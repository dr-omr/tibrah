<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="د. عمر العماد - رحلتك نحو الشفاء بالطب الشمولي والوظيفي. أدوات ذكية، جلسات علاجية، ومنتجات طبيعية.">
    <meta name="keywords" content="طب شمولي, طب وظيفي, علاج عن بعد, منتجات طبيعية, شفاء, دكتور عمر العماد, طِبرا, عجلة الحياة, تقييم صحي, DMSO, ترددات شفائية, تشخيص ذكي, خطة علاجية, تحليل الدم, خريطة الجسم, مفكرة الأعراض, تردد النقلة الموازية, صلاح الراشد, اختبار لوشير للألوان, الطب الشعوري, احمد الدملاوي">
    <title>د. عمر العماد | خبير الطب الشمولي والوظيفي</title>
    <meta name="theme-color" content="#F7FAFC">
    <meta name="color-scheme" content="light dark">
    <!-- Open Graph / Twitter -->
    <meta property="og:type" content="website">
    <meta property="og:locale" content="ar_YE">
    <meta property="og:title" content="د. عمر العماد | خبير الطب الشمولي والوظيفي">
    <meta property="og:description" content="رحلتك نحو الشفاء المتكامل تبدأ هنا: تنسيق السفر الطبي، الرأي الطبي الثاني، ومركز الأمراض المزمنة بمحتوى مُراجع.">
    <meta property="og:image" content="assets/images/omar.jpg">
    <meta property="og:url" content="/">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="د. عمر العماد | خبير الطب الشمولي والوظيفي">
    <meta name="twitter:description" content="تنسيق السفر الطبي، الرأي الطبي الثاني، ومركز معلومات الأمراض المزمنة.">
    <meta name="twitter:image" content="assets/images/omar.jpg">

    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Kufi+Arabic:wght@300;400;700&family=Great+Vibes&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preload" as="image" href="assets/images/omar.jpg" />
    
    <!-- Scripts -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Structured Data (Physician) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Physician",
      "name": "Dr. Omar Al Emad",
      "alternateName": "د. عمر العماد",
      "medicalSpecialty": ["InternalMedicine", "IntegrativeMedicine"],
      "areaServed": "YE",
      "sameAs": [
        "https://www.instagram.com/dr.omr369",
        "https://www.facebook.com/dr.omr369",
        "https://www.tiktok.com/@dr.omr369"
      ]
    }
    </script>

    <!-- Structured Data (Services) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@graph": [
        {
          "@type": "Service",
          "name": "Medical Travel & Logistics Coordination",
          "serviceType": "MedicalTravelCoordination",
          "areaServed": "YE",
          "availableChannel": { "@type": "ServiceChannel", "availableLanguage": ["ar", "en"], "serviceLocation": { "@type": "AdministrativeArea", "name": "Yemen" } },
          "provider": { "@type": "Physician", "name": "Dr. Omar Al Emad" }
        },
        {
          "@type": "Service",
          "name": "Second Opinion & Remote Consultation",
          "serviceType": "Telemedicine",
          "areaServed": "YE",
          "availableChannel": { "@type": "ServiceChannel", "availableLanguage": ["ar", "en"], "serviceUrl": "#view=second-opinion" },
          "provider": { "@type": "Physician", "name": "Dr. Omar Al Emad" }
        }
      ]
    }
    </script>


    <style>
        /* --- GLOBAL DESIGN SYSTEM & VARIABLES (REFINED) --- */
        :root {
            --primary-color: #1F6FEB; /* Clinical Blue */
            --primary-dark: #0F4CA8;  /* Deeper Clinical Blue */
            --primary-light: #6AA8FF; /* Lighter Blue */
            --primary-verylight: #EAF2FF; /* Very light Blue tint */
            --secondary-color: #F7FAFC; /* Clean off-white background */
            --accent-color: #2DD4BF;  /* Teal accent (trust + vitality) */
            --accent-light: #D1FAF0; /* Light teal for borders/surfaces */
            --accent-gold: #E9D8A6;   /* Warm gold for subtle highlights */
            --text-dark: #0B1220;    /* Near-black for high readability */
            --text-light: #FFFFFF;   /* White for dark surfaces */
        }
        
        /* --- GENERAL BODY & TYPOGRAPHY STYLES --- */
        body {
            font-family: 'Noto Kufi Arabic', sans-serif;
            background-color: var(--secondary-color);
            color: var(--text-dark);
            scroll-behavior: smooth;
        }
        @media (max-width: 768px) {
            body { padding-bottom: 72px; }
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Noto Kufi Arabic', sans-serif;
            font-weight: 700;
            color: var(--primary-dark);
        }
        .font-brand {
            font-family: 'Great Vibes', cursive;
        }

        /* --- ADVANCED ANIMATIONS & EFFECTS --- */
        @keyframes subtle-pan {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @keyframes ripple-effect { to { transform: scale(4); opacity: 0; } }
        @keyframes glow {
            0% { box-shadow: 0 0 5px var(--accent-gold); }
            50% { box-shadow: 0 0 20px var(--accent-gold); }
            100% { box-shadow: 0 0 5px var(--accent-gold); }
        }
        @keyframes pulse-loader {
          0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(90, 110, 90, 0.7); }
          70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(90, 110, 90, 0); }
          100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(90, 110, 90, 0); }
        }

        /* --- HERO SECTION STYLES --- */
        .hero-bg { animation: subtle-pan 25s ease-in-out infinite; }
        .hero-gradient { background: linear-gradient(to top, rgba(0,0,0,0.7), rgba(0,0,0,0.2)); }

        /* --- ENHANCED BUTTON STYLES --- */
        .btn { position: relative; overflow: hidden; transition: all 0.3s ease; transform-style: preserve-3d; letter-spacing: 0.2px; }
        .btn-primary { background-color: var(--primary-color); color: var(--text-light); }
        .btn-primary:hover { background-color: var(--primary-dark); transform: translateY(-4px); box-shadow: 0 8px 15px rgba(0,0,0,0.2); }
        .btn-secondary { background-color: transparent; color: var(--primary-color); border: 2px solid var(--primary-color); }
        .btn-secondary:hover { background-color: var(--primary-color); color: var(--text-light); transform: translateY(-4px); box-shadow: 0 8px 15px rgba(90, 110, 90, 0.2); }
        .btn-outline { background-color: transparent; color: var(--primary-dark); border: 2px solid var(--primary-dark); }
        .btn-outline:hover { background-color: var(--primary-dark); color: var(--text-light); transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }
        .btn-glow { animation: glow 3s infinite ease-in-out; }
        .ripple { position: absolute; border-radius: 50%; transform: scale(0); animation: ripple-effect 0.6s linear; background-color: rgba(255, 255, 255, 0.5); }
        /* Focus rings */
        .btn:focus-visible, .nav-link:focus-visible, #bottom-tabbar .tab-item:focus-visible, .inset-input:focus-visible { outline: 3px solid var(--accent-color); outline-offset: 2px; border-radius: 10px; }
        .dashboard-card:focus-visible { outline: 3px solid var(--accent-color); outline-offset: 2px; border-radius: 14px; }
        /* Top nav active */
        .nav-link.is-active { color: var(--primary-color) !important; border-bottom: 2px solid var(--accent-color); }
        @media (prefers-reduced-motion: reduce) {
            * { animation-duration: .01ms !important; animation-iteration-count: 1 !important; transition-duration: .01ms !important; scroll-behavior: auto !important; }
        }
        
        /* --- INTERACTIVE DASHBOARD CARD --- */
        .dashboard-card { cursor: pointer; transition: transform 0.4s ease, box-shadow 0.4s ease; transform-style: preserve-3d; background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }

        /* --- SECTION STYLES --- */
        .section-title::after { content: ''; display: block; width: 60px; height: 3px; background-color: var(--accent-color); margin: 1rem auto 0; transition: width 0.5s ease; }
        .section-title:hover::after { width: 100px; }
        
        /* --- Blog Post Typography --- */
        #post-content { line-height: 2; font-size: 1.05rem; }
        #post-content h2 { font-size: 1.5rem; margin: 1.25rem 0 .5rem; color: var(--primary-dark); font-weight: 700; }
        #post-content h3 { font-size: 1.25rem; margin: 1rem 0 .5rem; color: var(--primary-color); font-weight: 700; }
        #post-content p { margin: .6rem 0; color: #374151; }
        #post-content ul { list-style: disc; padding-right: 1.25rem; margin: .6rem 0; }
        #post-content ol { list-style: decimal; padding-right: 1.25rem; margin: .6rem 0; }
        #post-content li { margin: .25rem 0; }
        #post-content blockquote { border-right: 4px solid var(--accent-color); background: var(--primary-verylight); padding: .75rem 1rem; border-radius: .5rem; color: #1f2937; }
        #post-content hr { border: 0; border-top: 1px solid var(--accent-light); margin: 1.5rem 0; }
        #post-content img { border-radius: .75rem; box-shadow: 0 10px 24px rgba(0,0,0,0.08); }
        #post-content table { width: 100%; border-collapse: collapse; margin: 1rem 0; }
        #post-content th, #post-content td { border: 1px solid var(--accent-light); padding: .5rem .75rem; }
        #post-content th { background: var(--primary-verylight); text-align: right; }
        html[data-theme="dark"] #post-content p { color: #CBD5E1; }
        html[data-theme="dark"] #post-content blockquote { background: rgba(255,255,255,0.06); color: #E5E7EB; }
        html[data-theme="dark"] #post-content th, html[data-theme="dark"] #post-content td { border-color: rgba(255,255,255,0.12); }
        html[data-theme="dark"] #post-content th { background: rgba(255,255,255,0.08); }
        /* --- WHATSAPP & MODAL --- */
        .whatsapp-float { position: fixed; width: 60px; height: 60px; bottom: 40px; left: 40px; background-color: #25d366; color: #FFF; border-radius: 50px; text-align: center; font-size: 30px; box-shadow: 2px 2px 10px rgba(0,0,0,0.2); z-index: 100; transition: transform 0.3s ease; display: flex; align-items: center; justify-content: center; }
        /* Skip link */
        .skip-link { position: absolute; right: -9999px; top: auto; width: 1px; height: 1px; overflow: hidden; }
        .skip-link:focus { right: 1rem; top: 1rem; width: auto; height: auto; padding: 8px 12px; background: #111827; color: #fff; border-radius: 8px; z-index: 200; box-shadow: 0 6px 14px rgba(0,0,0,.2); }
        .whatsapp-float:hover { transform: scale(1.1) rotate(10deg); }
        #tool-modal, #quiz-modal { transition: opacity 0.3s ease, backdrop-filter 0.3s ease; backdrop-filter: blur(0px); }
        #tool-modal.is-open, #quiz-modal.is-open { opacity: 1; backdrop-filter: blur(8px); }
        /* Post reading progress */
        #post-progress { position: fixed; top: var(--header-h, 64px); right: 0; left: 0; height: 4px; z-index: 46; background: transparent; }
        #post-progress-inner { height: 100%; width: 0%; background: linear-gradient(90deg, var(--accent-color), var(--primary-color)); transition: width .15s ease; }

        /* --- FADE-IN ANIMATION --- */
        .fade-in-up { opacity: 0; transform: translateY(40px); transition: opacity 0.8s ease-out, transform 0.8s ease-out; }
        .fade-in-up.is-visible { opacity: 1; transform: translateY(0); }
        
        /* --- AI LOADER --- */
        .ai-loader { text-align: center; }
        .ai-loader .ai-loader-dots { display: inline-block; position: relative; width: 80px; height: 10px; }
        .ai-loader .ai-loader-dots div { position: absolute; top: 0; width: 13px; height: 13px; border-radius: 50%; background-color: var(--primary-color); animation: pulse-loader 1.4s infinite ease-in-out both; }
        .ai-loader .ai-loader-dots .dot1 { left: 8px; animation-delay: -0.32s; }
        .ai-loader .ai-loader-dots .dot2 { left: 32px; animation-delay: -0.16s; }
        .ai-loader .ai-loader-dots .dot3 { left: 56px; }

        /* --- FREQUENCY GENERATOR STYLES (REFINED) --- */
        #frequency-canvas { background: linear-gradient(135deg, #121212 0%, #2f3d2f 100%); border-radius: 8px; box-shadow: inset 0 0 15px rgba(0,0,0,0.6); }
        .freq-btn.active, .music-btn.active { background-color: var(--accent-color); color: white; transform: scale(1.05); box-shadow: 0 0 15px var(--accent-color); border-color: var(--accent-color); }
        .freq-description { font-size: 0.8rem; color: #777; margin-top: 4px; }
        .freq-btn, .music-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }


        /* --- SINGLE POST STYLES --- */
        #view-single-post .post-content h2 { font-size: 1.75rem; font-weight: bold; margin-top: 2rem; margin-bottom: 1rem; color: var(--primary-dark); }
        #view-single-post .post-content p { font-size: 1.1rem; line-height: 1.8; margin-bottom: 1.5rem; }
        #view-single-post .post-content ul { list-style-type: disc; margin-right: 2rem; margin-bottom: 1.5rem; }
        #view-single-post .post-content li { margin-bottom: 0.5rem; }

        /* --- WHEEL OF LIFE --- */
        #wheel-of-life-result { transition: opacity 0.5s ease-in-out; }
        #wheel-of-life-result-container .range-slider {
            -webkit-appearance: none; appearance: none;
            width: 100%; height: 8px; border-radius: 4px;
            background: var(--accent-light); outline: none; transition: background 0.3s;
        }
        #wheel-of-life-result-container .range-slider::-webkit-slider-thumb {
             -webkit-appearance: none; appearance: none; width: 20px; height: 20px;
             border-radius: 50%; background: var(--primary-color); cursor: pointer; transition: transform 0.2s;
        }
        #wheel-of-life-result-container .range-slider:hover { background: var(--accent-gold); }
        #wheel-of-life-result-container .range-slider::-webkit-slider-thumb:hover { transform: scale(1.2); }


        /* --- AUDIO PLAYER --- */
        .audio-player { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(10px); border-radius: 15px; padding: 20px; box-shadow: 0 8px 32px 0 rgba(0,0,0,0.1); }
        #audio-progress-bar { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; border-radius: 4px; background: var(--accent-light); outline: none; transition: opacity .2s; }
        #audio-progress-bar::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--primary-color); cursor: pointer; }
        
        /* --- BODY MAP (SVG UPGRADE) --- */
        #body-map-svg .organ-path {
            fill: rgba(31, 111, 235, 0.20); /* Clinical blue tint */
            stroke: var(--primary-dark);
            stroke-width: 1;
            transition: fill 0.25s ease, transform 0.2s ease;
            cursor: pointer;
        }
        #body-map-svg .organ-path:hover {
            fill: rgba(31, 111, 235, 0.40); /* Stronger blue on hover */
            transform: scale(1.02);
            stroke-width: 1.5;
        }
        #body-map-svg .organ-path.selected {
            fill: var(--accent-color) !important;
            stroke: var(--primary-dark);
            stroke-width: 2;
        }
        #body-map-svg #body-silhouette { pointer-events: none; }

        /* Category-based coloring for 2D organs */
        #body-map-svg [data-category="cardio"] { fill: rgba(185, 28, 28, 0.18); }
        #body-map-svg [data-category="neuro"] { fill: rgba(37, 99, 235, 0.18); }
        #body-map-svg [data-category="respiratory"] { fill: rgba(14, 165, 233, 0.18); }
        #body-map-svg [data-category="digestive"] { fill: rgba(5, 150, 105, 0.18); }
        #body-map-svg [data-category="endocrine"] { fill: rgba(168, 85, 247, 0.18); }
        #body-map-svg [data-category="adrenal"] { fill: rgba(245, 158, 11, 0.18); }

        /* Search match highlight */
        #body-map-svg .organ-path.match { filter: drop-shadow(0 0 6px rgba(31,111,235,0.5)); stroke: var(--accent-color); }
        /* Dark theme variants */
        html[data-theme="dark"] #body-map-svg .organ-path { fill: rgba(255,255,255,0.08); stroke: rgba(255,255,255,0.35); }
        html[data-theme="dark"] #body-map-svg .organ-path:hover { fill: rgba(31,111,235,0.55); stroke: rgba(255,255,255,0.7); }

        /* Anatomy overlay controls */
        #body-map-svg-container { position: relative; }
        #anatomy-overlay { position: absolute; inset: 0; pointer-events: none; }
        #overlay-controls { gap: 8px; }

        /* Category chip for info panel */
        .category-chip { display: inline-flex; align-items: center; gap: 6px; padding: 2px 8px; border: 1px solid #e5e7eb; border-radius: 999px; font-size: 0.8rem; background: #fff; }
        .category-chip .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }

        #body-map-info {
             transition: opacity 0.5s ease, transform 0.5s ease;
             max-height: 500px;
             overflow-y: auto;
        }
        /* Controls */
        .body-map-toolbar { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; margin-bottom: 16px; justify-content: flex-end; }
        .chip { display: inline-flex; align-items: center; gap: 6px; padding: 6px 10px; border: 1px solid var(--primary-light); border-radius: 999px; color: var(--primary-dark); background: #fff; font-size: 0.9rem; cursor: pointer; }
        .chip.active { background: var(--primary-verylight); border-color: var(--accent-color); color: var(--accent-color); }
        .chip .dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .search-input { border: 1px solid #e5e7eb; padding: 8px 12px; border-radius: 8px; min-width: 240px; }
        .legend { display: flex; gap: 12px; flex-wrap: wrap; justify-content: flex-end; }
        .legend-item { display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; background: #fafafa; border: 1px solid #eee; border-radius: 8px; font-size: 0.85rem; }
        .legend-item .swatch { width: 12px; height: 12px; border-radius: 3px; display: inline-block; }
        /* Tooltip */
        #body-map-tooltip { position: absolute; pointer-events: none; background: rgba(255,255,255,0.95); border: 1px solid #e5e7eb; box-shadow: 0 4px 20px rgba(0,0,0,0.08); border-radius: 8px; padding: 10px 12px; font-size: 0.85rem; color: #374151; transform: translate(-50%, -120%); min-width: 160px; z-index: 10; }
        #body-map-svg-container { position: relative; }
        #body-map-3d-container { position: relative; }
        model-viewer#body-model-3d { width: 100%; max-width: 320px; height: 520px; background: #fff; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
        .hotspot-btn { background: rgba(255,255,255,0.95); border: 1px solid #e5e7eb; color: #111827; padding: 4px 8px; border-radius: 999px; font-size: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .hotspot-btn.selected { border-color: var(--accent-color); color: var(--accent-color); font-weight: 700; }

        /* --- JOURNAL (NEW) --- */
        #journal-form label {
            text-align: right;
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .journal-entry {
            border-right: 4px solid var(--accent-light);
        }

        /* --- LUSCHER QUIZ STYLES --- */
        .color-swatch-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .color-swatch {
            width: 100%;
            height: 60px;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, opacity 0.3s;
            border: 3px solid transparent;
            position: relative;
        }
        .color-swatch:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .color-swatch.selected {
            opacity: 0.3;
            cursor: not-allowed;
            transform: scale(0.9);
        }
        .color-swatch.selected::after {
            content: attr(data-order);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 5px black;
        }
        
        /* --- FAQ Section --- */
        .faq-section {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
        }
        .faq-section details {
            border-bottom: 1px solid var(--accent-light);
            padding: 1.5rem;
        }
        .faq-section details:last-child {
            border-bottom: none;
        }
        .faq-section summary {
            font-weight: 700;
            color: var(--primary-dark);
            cursor: pointer;
            list-style: none; /* Hide default arrow */
            position: relative;
            padding-left: 2rem;
        }
        .faq-section summary::-webkit-details-marker {
            display: none; /* Hide default arrow for Chrome/Safari */
        }
        .faq-section summary::before {
            content: '+';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.5rem;
            color: var(--primary-color);
            transition: transform 0.3s ease;
        }
        .faq-section details[open] summary::before {
            transform: translateY(-50%) rotate(45deg);
        }
        .faq-section details[open] p {
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* --- Chronic Care Hub (New) --- */
        .chronic-category-btn.active {
            background-color: var(--primary-color);
            color: var(--text-light);
            border-color: var(--primary-color);
        }
        .legal-disclaimer {
            background: #fff7ed; /* warm amber-50 */
            border-right: 4px solid #f59e0b; /* amber-500 */
        }
        .tab-btn.active {
            background-color: var(--primary-dark);
            color: var(--text-light);
        }

        /* --- iOS-inspired Segmented Control --- */
        .segmented-control {
            display: inline-flex;
            background: rgba(67, 82, 67, 0.06);
            border: 1px solid var(--accent-light);
            border-radius: 9999px;
            padding: 4px;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.5);
        }
        .segmented-control .tab-btn {
            border: 0 !important;
            background: transparent;
            color: var(--primary-dark);
            padding: 8px 16px;
            border-radius: 9999px;
            transition: all .2s ease;
        }
        .segmented-control .tab-btn.active {
            background: var(--primary-dark);
            color: var(--text-light);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        .segmented-control .tab-btn:not(.active):hover {
            background: rgba(67, 82, 67, 0.12);
        }

        /* --- Large Title --- */
        .large-title {
            font-weight: 700;
            font-size: clamp(28px, 6vw, 40px);
            letter-spacing: -0.02em;
            margin-bottom: 0.75rem;
            transition: all .2s ease;
        }
        .large-title.compact {
            font-size: clamp(20px, 4.5vw, 28px);
            margin-bottom: 0.25rem;
            opacity: .95;
        }

        /* --- Mobile Bottom Tab Bar --- */
        #bottom-tabbar {
            background: rgba(255,255,255,0.9);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--accent-light);
        }
        #bottom-tabbar .tab-item {
            flex: 1;
            text-align: center;
            padding: 8px 6px;
            color: var(--primary-dark);
            min-height: 56px; /* comfortable touch target */
        }
        #bottom-tabbar .tab-item.active { color: var(--primary-color); }
        #bottom-tabbar .tab-item i { font-size: 18px; transition: transform .2s ease, color .2s ease; }
        #bottom-tabbar .tab-item .label { display: block; font-size: 12px; margin-top: 2px; }
        #bottom-tabbar .tab-item .dot { display: block; width: 6px; height: 6px; border-radius: 999px; margin: 2px auto 0; background: transparent; transition: background .2s ease, transform .2s ease; }
        #bottom-tabbar .tab-item.active i { transform: translateY(-2px) scale(1.15); }
        #bottom-tabbar .tab-item.active .dot { background: var(--primary-color); transform: translateY(-1px); }
 
        /* --- Inset Grouped Forms (iOS-inspired) --- */
        .inset-section { margin-bottom: 1.25rem; }
        .inset-title { font-size: 0.95rem; color: #6b7280; margin: 0 0 0.5rem 0; text-align: right; }
        .inset-group { background: #fff; border: 1px solid var(--accent-light); border-radius: 14px; overflow: hidden; }
        .inset-cell { display: grid; grid-template-columns: 1fr 2fr; gap: 0.5rem; padding: 12px 14px; align-items: center; border-bottom: 1px solid var(--accent-light); }
        .inset-cell:last-child { border-bottom: none; }
        .inset-label { font-weight: 600; text-align: right; color: var(--primary-dark); }
        .inset-input { width: 100%; background: transparent; border: none; outline: none; padding: 8px 0; color: inherit; }
        .inset-input::placeholder { color: #9ca3af; }
        .inset-textarea { resize: vertical; min-height: 90px; }
        .is-submitting { opacity: 0.7; pointer-events: none; }
        .loading-dots { display: inline-flex; gap: 4px; align-items: center; }
        .loading-dots span { width: 6px; height: 6px; background: var(--primary-color); border-radius: 9999px; display: inline-block; animation: pulse-loader 1.2s infinite ease-in-out; }
        .loading-dots span:nth-child(2) { animation-delay: .15s; }
        .loading-dots span:nth-child(3) { animation-delay: .3s; }
        .inset-cell.error { background: #fef2f2; }
        .inset-cell.error .inset-label { color: #b91c1c; }
        .inset-cell.error .inset-input { border-bottom: 1px solid #ef4444; }

        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            body { padding-bottom: calc(72px + env(safe-area-inset-bottom)); }
            #bottom-tabbar { padding-bottom: env(safe-area-inset-bottom); }
        }

        @supports (padding-top: env(safe-area-inset-top)) {
            header { padding-top: env(safe-area-inset-top); }
        }

        /* Scroll offset so sticky header doesn't overlap section headings */
        .page-view { scroll-margin-top: 88px; }

        /* Ensure floating WhatsApp button and back-to-top sit above bottom tabbar on mobile */
        @media (max-width: 768px) {
            .whatsapp-float { bottom: calc(88px + env(safe-area-inset-bottom)); left: 16px; width: 56px; height: 56px; }
        }

        /* --- View Subheader (iOS-style compact title) --- */
        :root { --header-h: 64px; }
        .view-subheader {
            position: sticky;
            top: calc(var(--header-h, 64px));
            z-index: 45;
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(8px);
            border-bottom: 1px solid var(--accent-light);
            padding: 8px 0;
            display: none; /* shown when large-title becomes compact */
        }
        .view-subheader .title { font-weight: 700; font-size: 1rem; color: var(--primary-dark); }
        .view-subheader.is-visible { animation: slideDown 0.25s ease; }
        @keyframes slideDown { from { transform: translateY(-8px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* Header compact state */
        header.scrolled { background: rgba(255,255,255,0.95); box-shadow: 0 10px 24px rgba(0,0,0,0.08); border-bottom: 1px solid var(--accent-light); }
        header.scrolled nav { padding-top: 6px !important; padding-bottom: 6px !important; }
        html[data-theme="dark"] header.scrolled { background: rgba(15,23,42,0.85); border-bottom-color: rgba(255,255,255,0.12); }

        /* Elevation and card polish */
        .dashboard-card { box-shadow: 0 6px 18px rgba(0,0,0,0.08); }
        .dashboard-card:hover { transform: translateY(-6px); box-shadow: 0 14px 28px rgba(0,0,0,0.16); }

        /* Scrollbar polish */
        *::-webkit-scrollbar { width: 10px; height: 10px; }
        *::-webkit-scrollbar-track { background: transparent; }
        *::-webkit-scrollbar-thumb { background: var(--primary-light); border-radius: 9999px; }

        /* Legal disclaimer tone */
        .legal-disclaimer { background: linear-gradient(to left, rgba(245, 158, 11, 0.08), rgba(255,255,255,0.9)); border-right: 4px solid rgba(245, 158, 11, 0.6); border-radius: 12px; }
        html[data-theme="dark"] .legal-disclaimer { background: linear-gradient(to left, rgba(245, 158, 11, 0.18), rgba(255,255,255,0.06)); border-right-color: rgba(245, 158, 11, 0.7); }

        /* Smart sticky CTA (mobile) */
        #smart-cta { bottom: 96px; }
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            #smart-cta { bottom: calc(96px + env(safe-area-inset-bottom)); }
        }
        #smart-cta .wrap { background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); border: 1px solid var(--accent-light); border-radius: 16px; padding: 8px; box-shadow: 0 10px 24px rgba(0,0,0,0.15); }
        html[data-theme="dark"] #smart-cta .wrap { background: rgba(2,6,23,0.85); border-color: rgba(255,255,255,0.12); }

        /* --- Badges --- */
        .badge { display: inline-block; padding: 4px 10px; border-radius: 9999px; font-size: 0.75rem; border: 1px solid transparent; }
        .badge-primary { background: var(--primary-verylight); color: var(--primary-dark); border-color: var(--primary-light); }
        .badge-secondary { background: rgba(148,163,184,0.12); color: #334155; border-color: rgba(148,163,184,0.3); }
        .badge-success { background: rgba(5,150,105,0.12); color: #065f46; border-color: rgba(5,150,105,0.3); }
        html[data-theme="dark"] .badge-secondary { background: rgba(148,163,184,0.2); color: #e2e8f0; border-color: rgba(148,163,184,0.25); }
        html[data-theme="dark"] .badge-success { background: rgba(5,150,105,0.25); color: #bbf7d0; border-color: rgba(5,150,105,0.25); }

        /* --- Segmented Control (world-class iOS-like) --- */
        .segmented-control { display: inline-flex; gap: 4px; background: var(--primary-verylight); border: 1px solid var(--accent-light); border-radius: 9999px; padding: 4px; }
        .segmented-control .tab-btn,
        .segmented-control .tool-cat-btn,
        .segmented-control .blog-cat-btn { border: 0; background: transparent; color: var(--primary-dark); padding: 8px 12px; border-radius: 9999px; }
        .segmented-control .tab-btn.active,
        .segmented-control .tool-cat-btn[aria-selected="true"],
        .segmented-control .blog-cat-btn[aria-selected="true"] { background: #fff; box-shadow: 0 6px 16px rgba(0,0,0,0.08); color: var(--primary-dark); }
        html[data-theme="dark"] .segmented-control { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.12); }
        html[data-theme="dark"] .segmented-control .tab-btn.active,
        html[data-theme="dark"] .segmented-control .tool-cat-btn[aria-selected="true"],
        html[data-theme="dark"] .segmented-control .blog-cat-btn[aria-selected="true"] { background: rgba(255,255,255,0.12); color: var(--text-light); }

        /* --- Dark Theme (Toggle via html[data-theme="dark"]) --- */
        html[data-theme="dark"] {
            --secondary-color: #0B1220;
            --text-dark: #E5E7EB;
            --text-light: #FFFFFF;
            --accent-light: rgba(31, 111, 235, 0.25);
        }
        html[data-theme="dark"] body { background-color: var(--secondary-color); color: var(--text-dark); }
        html[data-theme="dark"] header { background-color: rgba(15,23,42,0.72) !important; }
        html[data-theme="dark"] #bottom-tabbar { background: rgba(2,6,23,0.85); border-top-color: rgba(255,255,255,0.1); }
        html[data-theme="dark"] .dashboard-card { background: rgba(255,255,255,0.06); border-color: rgba(255,255,255,0.08); }
        html[data-theme="dark"] .audio-player { background: rgba(255,255,255,0.06); }
        html[data-theme="dark"] .inset-group { background: rgba(255,255,255,0.04); border-color: rgba(255,255,255,0.12); }
        html[data-theme="dark"] .badge-primary { background: rgba(31,111,235,0.2); color: #EAF2FF; border-color: rgba(31,111,235,0.4); }
        html[data-theme="dark"] .text-gray-600 { color: #CBD5E1 !important; }
        html[data-theme="dark"] .bg-gray-50 { background-color: rgba(255,255,255,0.06) !important; }
        html[data-theme="dark"] .bg-gray-100 { background-color: rgba(255,255,255,0.08) !important; }
        html[data-theme="dark"] .border-gray-200 { border-color: rgba(255,255,255,0.12) !important; }
        html[data-theme="dark"] .view-subheader { background: rgba(15,23,42,0.72); border-bottom-color: rgba(255,255,255,0.12); }

        /* --- Accessibility and WCAG Helpers --- */
        @import url('https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;700&display=swap');
        body.a11y-dys { font-family: 'Atkinson Hyperlegible', system-ui, -apple-system, Segoe UI, Roboto, Tahoma, Arial, sans-serif; }
        body.a11y-hc {
            --primary-color: #000000;
            --primary-dark: #000000;
            --secondary-color: #ffffff;
            --accent-color: #FFD700; /* gold */
            --accent-light: #D1D5DB; /* light border */
            color: #000 !important;
            background-color: #fff !important;
        }
        body.a11y-hc a { color: #0645AD !important; text-decoration: underline; }
        .a11y-toggle { position: fixed; bottom: 5.25rem; left: 1.25rem; z-index: 60; }
        #a11y-panel { width: 320px; max-width: calc(100vw - 2rem); }
        #a11y-panel .option-row { display: flex; justify-content: space-between; align-items: center; gap: .5rem; padding: .5rem 0; }
        .a11y-shortcut-hint { font-size: .75rem; color: #6b7280; }
        @media (max-width: 640px) {
            .inset-cell { grid-template-columns: 1fr; align-items: start; }
            .a11y-toggle { bottom: 6.5rem; }
        }
    </style>
</head>
<body class="bg-secondary-color text-text-dark">
    <a href="#main-content" class="skip-link">تخطي إلى المحتوى</a>

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-sm shadow-lg sticky top-0 z-50 transition-shadow duration-300" role="banner">
        <nav class="container max-w-screen-lg mx-auto px-4 sm:px-6 py-3 flex justify-between items-center">
            <a href="#" class="font-brand text-5xl text-[--primary-dark] nav-link" data-view="hero" style="text-shadow: 1px 1px 3px rgba(0,0,0,0.2);">
                د. عمر العماد
            </a>
            <div class="hidden md:flex items-center space-x-reverse space-x-6">
                <a href="#" class="nav-link hover:text-[--primary-color] transition-colors duration-300" data-view="about">عني</a>
                <a href="#" class="nav-link hover:text-[--primary-color] transition-colors duration-300" data-view="dashboard">الخدمات التفاعلية</a>
                <a href="#" class="nav-link hover:text-[--primary-color] transition-colors duration-300" data-view="chronic-care">الأمراض المزمنة</a>
                <a href="#" class="nav-link hover:text-[--primary-color] transition-colors duration-300" data-view="medical-travel">السفر الطبي</a>
                <a href="#" class="nav-link hover:text-[--primary-color] transition-colors duration-300" data-view="second-opinion">الرأي الطبي الثاني</a>
                <a href="#" class="nav-link hover:text-[--primary-color] transition-colors duration-300" data-view="services">الجلسات</a>
                <a href="#" class="nav-link hover:text-[--primary-color] transition-colors duration-300" data-view="store">المتجر</a>
                <a href="#" class="nav-link hover:text-[--primary-color] transition-colors duration-300" data-view="blog">المدونة</a>
                 <!-- Login/Profile Link -->
                 <div id="auth-section" class="flex items-center">
                     <button id="login-btn" class="font-bold text-[--primary-color] hover:underline">تسجيل الدخول</button>
                     <div id="profile-section-nav" class="hidden items-center">
                         <a href="#" class="nav-link font-bold text-[--primary-color] hover:underline ml-4" data-view="premium-content">ملف المريض</a>
                         <img id="user-avatar" class="w-8 h-8 rounded-full" alt="صورة المستخدم" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiM1YTZlNWEiLz4KPHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjIwIiBmaWxsPSJ3aGl0ZSI+VTwvdGV4dD4KPC9zdmc+Cg=='">
                     </div>
                 </div>
            </div>
            <a href="#contact" class="hidden md:block btn btn-primary text-white py-2 px-6 rounded-full">احجز جلستك</a>
            <!-- Theme Toggle -->
            <button id="theme-toggle" class="ml-3 md:ml-4 text-[--primary-dark] hover:text-[--primary-color]" aria-label="تبديل الوضع">
                <i class="fa-solid fa-moon text-xl"></i>
            </button>
            <!-- Mobile Menu Button -->
            <button id="mobile-menu-button" class="md:hidden" aria-controls="mobile-menu" aria-expanded="false">
                <i class="fas fa-bars text-2xl"></i>
            </button>
        </nav>
         <!-- Mobile Menu -->
         <div id="mobile-menu" class="hidden md:hidden px-4 sm:px-6 pb-4">
             <a href="#" class="nav-link block py-2 hover:text-[--primary-color]" data-view="about">عني</a>
             <a href="#" class="nav-link block py-2 hover:text-[--primary-color]" data-view="dashboard">الخدمات التفاعلية</a>
             <a href="#" class="nav-link block py-2 hover:text-[--primary-color]" data-view="chronic-care">الأمراض المزمنة</a>
             <a href="#" class="nav-link block py-2 hover:text-[--primary-color]" data-view="medical-travel">السفر الطبي</a>
             <a href="#" class="nav-link block py-2 hover:text-[--primary-color]" data-view="second-opinion">الرأي الطبي الثاني</a>
             <a href="#" class="nav-link block py-2 hover:text-[--primary-color]" data-view="services">الجلسات</a>
             <a href="#" class="nav-link block py-2 hover:text-[--primary-color]" data-view="store">المتجر</a>
             <a href="#" class="nav-link block py-2 hover:text-[--primary-color]" data-view="blog">المدونة</a>
             <a href="#contact" class="block py-2 hover:text-[--primary-color]">تواصل معي</a>
             <hr class="my-2">
             <div id="auth-section-mobile">
                 <button id="login-btn-mobile" class="w-full text-right py-2 font-bold text-[--primary-color]">تسجيل الدخول</button>
                 <a href="#" id="profile-link-mobile" class="nav-link hidden w-full text-right py-2 font-bold text-[--primary-color]" data-view="premium-content">ملف المريض</a>
             </div>
         </div>
    </header>

    <main id="main-content" role="main">
        <!-- Notification Toast -->
        <div id="notification-toast" class="hidden fixed top-20 right-5 py-3 px-6 rounded-lg shadow-xl z-[150] transition-all duration-500 transform text-white">
            <span id="notification-message"></span>
        </div>
        <!-- Quizzes Modal -->
        <div id="quiz-modal" class="hidden fixed inset-0 bg-black/60 z-[110] flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="quiz-modal-title">
            <div class="bg-white dark:bg-[rgba(15,23,42,0.9)] p-6 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto relative text-right">
                <button id="quiz-modal-close" class="absolute top-4 left-4 text-2xl text-gray-500 hover:text-gray-800" aria-label="إغلاق">&times;</button>
                <div id="quiz-modal-content"></div>
            </div>
        </div>
        <!-- Post reading progress bar (visible in single-post view only) -->
        <div id="post-progress" class="hidden"><div id="post-progress-inner"></div></div>
        <!-- Smart Mobile CTA -->
        <div id="smart-cta" class="hidden fixed right-4 left-4 bottom-5 md:bottom-6 md:left-auto md:right-5 z-[120]">
            <div class="wrap flex items-center gap-2">
                <a href="#" class="nav-link btn btn-primary text-white flex-1 py-3 px-4 rounded-full text-center" data-view="medical-travel">
                    <i class="fa-solid fa-plane-departure ml-2"></i>تنسيق السفر الطبي
                </a>
                <a href="#" class="nav-link btn btn-secondary flex-1 py-3 px-4 rounded-full text-center" data-view="second-opinion">
                    <i class="fa-solid fa-stethoscope ml-2"></i>الرأي الطبي الثاني
                </a>
            </div>
        </div>
        <!-- View Subheader (auto shows when title compacts) -->
        <div id="view-subheader" class="view-subheader">
            <div class="container max-w-screen-lg mx-auto px-4 sm:px-6">
                <div class="flex items-center justify-between">
                    <span class="title"></span>
                    <a href="#" class="nav-link text-[--primary-color] text-sm" data-view="hero" aria-label="العودة للرئيسية">
                        <i class="fa-solid fa-house ml-1"></i>الرئيسية
                    </a>
                </div>
            </div>
        </div>
        <!-- Hero Section -->
        <section id="view-hero" class="page-view relative h-screen flex items-center justify-center text-white text-center">
            <div class="absolute inset-0 bg-cover" style="background-image: url('assets/images/omar.jpg'); background-position: center 80%;"></div>
            <div class="absolute inset-0 hero-gradient"></div>
            <div class="relative z-10 p-6 fade-in-up">
                <h1 class="font-brand text-6xl md:text-8xl mb-4 text-[--accent-gold]" style="text-shadow: 2px 2px 5px rgba(0,0,0,0.5);">ṬibraSoul</h1>
                <h2 class="large-title text-4xl md:text-6xl font-bold mb-2">د. عمر العماد</h2>
                <p class="text-lg md:text-xl max-w-3xl mx-auto">رحلتك نحو الشفاء المتكامل تبدأ هنا</p>
                <div class="mt-8 flex flex-col sm:flex-row items-center justify-center gap-3">
                    <a href="#" class="nav-link inline-block btn bg-white text-[--primary-color] font-bold py-3 px-8 rounded-full text-lg btn-glow" data-view="medical-travel" aria-label="اطلب تنسيق السفر الطبي">
                        <i class="fa-solid fa-plane ml-2"></i>
                        اطلب تنسيق السفر الطبي
                    </a>
                    <a href="#" class="nav-link inline-block btn btn-primary text-white font-bold py-3 px-8 rounded-full text-lg" data-view="second-opinion" aria-label="أرسل تقاريرك للرأي الطبي الثاني">
                        <i class="fa-solid fa-file-medical ml-2"></i>
                        أرسل تقاريرك للرأي الطبي الثاني
                    </a>
                    <a href="#" class="nav-link inline-block btn bg-white/80 text-[--primary-color] font-bold py-3 px-8 rounded-full text-lg" data-view="dashboard" aria-label="اكتشف بقية الخدمات">
                        <i class="fa-solid fa-grip ml-2"></i>
                        اكتشف بقية الخدمات
                    </a>
                </div>
                <div class="mt-4 flex flex-wrap justify-center gap-4 text-sm opacity-90">
                    <div class="flex items-center gap-2"><i class="fa-solid fa-shield-halved"></i><span>سرية تامة للبيانات</span></div>
                    <div class="flex items-center gap-2"><i class="fa-solid fa-bolt"></i><span>رد خلال 24 ساعة</span></div>
                    <div class="flex items-center gap-2"><i class="fa-solid fa-user-doctor"></i><span>أطباء استشاريون</span></div>
                </div>
            </div>
        </section>

        <!-- Chronic Care Q&A Hub (NEW) -->
        <section id="view-chronic-care" class="page-view py-20 bg-white hidden">
            <div class="container max-w-screen-lg mx-auto px-4 sm:px-6">
                <div class="text-right mb-10">
                    <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="dashboard">
                        <i class="fas fa-arrow-right-long ml-2"></i>
                        الرجوع إلى لوحة التحكم
                    </button>
                </div>
                <div class="text-center mb-8">
                    <h2 class="large-title text-4xl font-bold mb-3 section-title">مركز معلومات الأمراض المزمنة (طبي)</h2>
                    <p class="max-w-3xl mx-auto text-lg">مواد تعليمية مُراجعة من منظور طبي لتفهّم حالتك بشكل أفضل، مع توفير مساعد معلومات عام (غير تشخيصي) لما قبل الزيارة.</p>
                </div>

                <!-- Priority CTAs: Medical Travel & Second Opinion -->
                <div class="bg-gradient-to-l from-[--accent-light] to-white border rounded-xl p-6 mb-6 shadow-sm">
                    <div class="md:flex items-center justify-between gap-6">
                        <div class="text-right">
                            <h3 class="text-2xl font-bold text-[--primary-dark] mb-1">ابدأ بخطوة تقود قرارك الطبي بثقة</h3>
                            <p class="text-gray-700">اختر أحد المسارين الأسرع تأثيراً: تنسيق السفر الطبي للحالات المعقدة أو إرسال التقارير للرأي الطبي الثاني. الاستشارة الباطنية متاحة كخيار لاحق داعم.</p>
                        </div>
                        <div class="mt-4 md:mt-0 flex flex-col sm:flex-row gap-3 md:gap-4">
                            <a href="#" class="nav-link btn btn-primary text-white py-3 px-6 rounded-full whitespace-nowrap" data-view="medical-travel"><i class="fa-solid fa-plane ml-2"></i>اطلب تنسيق السفر الطبي</a>
                            <a href="#" class="nav-link btn btn-secondary py-3 px-6 rounded-full whitespace-nowrap" data-view="second-opinion"><i class="fa-solid fa-file-medical ml-2"></i>أرسل تقاريرك للرأي الطبي الثاني</a>
                            <a href="https://wa.me/967771447111?text=أرغب%20في%20حجز%20استشارة%20باطنية" target="_blank" class="btn btn-outline py-3 px-6 rounded-full whitespace-nowrap"><i class="fas fa-user-doctor ml-2"></i>استشارة باطنية (اختياري)</a>
                        </div>
                    </div>
                </div>

                <!-- Legal Disclaimer (always visible) -->
                <div class="legal-disclaimer rounded-lg p-4 mb-6 text-right">
                    <p class="font-bold text-[--primary-dark]">
                        هذا القسم يقدم دعماً معلوماتياً عاماً فقط، ولا يُعد بديلاً عن الاستشارة الطبية أو التشخيص أو العلاج من طبيبك.
                    </p>
                    <p class="text-sm text-gray-700">This tool provides general, informational support only and is NOT a substitute for professional medical advice, diagnosis, or treatment.</p>
                </div>

                <!-- Tabs -->
                <div class="flex justify-center mb-6">
                    <div class="segmented-control" role="tablist" aria-label="تبويبات مركز الأمراض">
                        <button id="tab-articles" class="tab-btn btn btn-outline py-2 px-4 rounded-full" data-tab="articles" role="tab" aria-controls="chronic-articles-section" aria-selected="true">المحتوى الطبي المُراجع</button>
                        <button id="tab-assistant" class="tab-btn btn btn-outline py-2 px-4 rounded-full" data-tab="assistant" role="tab" aria-controls="chronic-assistant-section" aria-selected="false">المساعد العام (معلومات فقط)</button>
                    </div>
                </div>

                <!-- Doctor-Reviewed Articles Section -->
                <div id="chronic-articles-section" class="" role="tabpanel" aria-labelledby="tab-articles" aria-hidden="false">
                    <div id="chronic-articles-nav" class="mb-4 flex flex-wrap gap-2 justify-center">
                        <button class="btn btn-secondary py-2 px-4 rounded-full" data-disease="diabetes">السكري</button>
                        <button class="btn btn-secondary py-2 px-4 rounded-full" data-disease="hypertension">ارتفاع الضغط</button>
                        <button class="btn btn-secondary py-2 px-4 rounded-full" data-disease="ckd">مرض الكلى المزمن</button>
                        <button class="btn btn-secondary py-2 px-4 rounded-full" data-disease="dyslipidemia">اضطراب دهون الدم</button>
                        <button class="btn btn-secondary py-2 px-4 rounded-full" data-disease="copd">الانسداد الرئوي المزمن</button>
                    </div>
                    <div id="chronic-article-content" class="bg-white p-6 rounded-xl shadow-md max-w-4xl mx-auto text-right"></div>
                </div>

                <!-- Assistant Section (General Info) -->
                <div id="chronic-assistant-section" class="hidden" role="tabpanel" aria-labelledby="tab-assistant" aria-hidden="true">
                    <!-- Categories -->
                    <div class="mb-6 flex flex-wrap gap-3 justify-center">
                        <button class="chronic-category-btn btn btn-secondary py-2 px-4 rounded-full" data-cat="diabetes">السكري</button>
                        <button class="chronic-category-btn btn btn-secondary py-2 px-4 rounded-full" data-cat="hypertension">ارتفاع الضغط</button>
                        <button class="chronic-category-btn btn btn-secondary py-2 px-4 rounded-full" data-cat="diet">التغذية</button>
                        <button class="chronic-category-btn btn btn-secondary py-2 px-4 rounded-full" data-cat="medications">الأدوية والتداخلات</button>
                    </div>

                    <!-- Suggestions -->
                    <div id="chronic-suggestions" class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6"></div>

                    <!-- Ask UI -->
                    <div class="bg-gray-50 p-6 rounded-xl shadow-md max-w-4xl mx-auto">
                        <label for="chronic-question" class="block text-right font-semibold mb-2">سؤالك (غير طارئ)</label>
                        <textarea id="chronic-question" rows="4" class="w-full p-3 border rounded-md" placeholder="اكتب سؤالك هنا... مثل: ما أفضل نمط غذائي للسكري مع ارتفاع الضغط؟"></textarea>
                        <div class="flex items-center justify-between mt-4">
                            <p class="text-sm text-gray-500">يجب عدم استخدام هذه الأداة للحالات الطارئة. في الطوارئ اتصل بخدمات الإسعاف فوراً.</p>
                            <button id="chronic-ask-btn" class="btn btn-primary text-white py-2 px-6 rounded-full">احصل على إجابة عامة</button>
                        </div>
                    </div>

                    <!-- Results -->
                    <div id="chronic-results" class="mt-6 hidden" role="status" aria-live="polite"></div>
                </div>
            </div>
        </section>

        <!-- Home Services Section (Primary iOS-like Cards) -->
        <section id="featured-services" class="page-view py-16 bg-white dark:bg-gray-900 hidden">
            <div class="container max-w-screen-lg mx-auto px-4 sm:px-6">
                <div class="text-center mb-10">
                    <h2 class="large-title section-title">ابدأ من هنا</h2>
                    <p class="text-gray-600 max-w-2xl mx-auto">ركّزنا رحلتك على ثلاث خدمات محورية تقود قراراتك الطبية بثقة.</p>
                </div>
                <div class="grid gap-6 sm:grid-cols-2 md:grid-cols-3">
                    <!-- Card: Medical Travel -->
                    <a href="#" class="nav-link dashboard-card block p-8 rounded-2xl shadow-lg text-center hover:shadow-2xl transition" data-view="medical-travel">
                        <span class="badge badge-primary mb-3 inline-block">موصى به</span>
                        <div class="text-5xl text-[--primary-color] mb-3"><i class="fa-solid fa-plane"></i></div>
                        <h3 class="text-2xl font-bold mb-2">تنسيق السفر الطبي</h3>
                        <p class="text-gray-600">تنسيق شامل للمواعيد، التقارير، والسكن بالمراكز المتقدمة.</p>
                    </a>
                    <!-- Card: Second Opinion -->
                    <a href="#" class="nav-link dashboard-card block p-8 rounded-2xl shadow-lg text-center hover:shadow-2xl transition" data-view="second-opinion">
                        <span class="badge badge-primary mb-3 inline-block">موصى به</span>
                        <div class="text-5xl text-[--primary-color] mb-3"><i class="fa-solid fa-file-medical"></i></div>
                        <h3 class="text-2xl font-bold mb-2">الرأي الطبي الثاني</h3>
                        <p class="text-gray-600">ارسال التقارير إلى استشاريين كبار والحصول على توصية واضحة.</p>
                    </a>
                    <!-- Card: Chronic Disease Hub -->
                    <a href="#" class="nav-link dashboard-card block p-8 rounded-2xl shadow-lg text-center hover:shadow-2xl transition" data-view="chronic-care">
                        <div class="text-5xl text-[--primary-color] mb-3"><i class="fa-solid fa-heart-pulse"></i></div>
                        <h3 class="text-2xl font-bold mb-2">مركز الأمراض المزمنة</h3>
                        <p class="text-gray-600">محتوى طبي مُراجع لفهم حالتك، مع مساعد معلومات عام ثانوياً.</p>
                    </a>
                </div>

                <div class="mt-12">
                    <h3 class="text-xl font-bold mb-4 text-right">خدمات وأدوات إضافية</h3>
                    <div class="grid gap-6 sm:grid-cols-2 md:grid-cols-3">
                        <a href="#" class="nav-link dashboard-card block p-6 rounded-xl shadow-lg text-center" data-view="services">
                            <div class="text-4xl text-[--primary-color] mb-2"><i class="fas fa-user-doctor"></i></div>
                            <h4 class="text-lg font-bold mb-1">الجلسات الاستشارية</h4>
                            <p class="text-gray-600">استشارة أولية أو متابعة.</p>
                        </a>
                        <a href="#" class="nav-link dashboard-card block p-6 rounded-xl shadow-lg text-center" data-view="store">
                            <div class="text-4xl text-[--primary-color] mb-2"><i class="fas fa-store"></i></div>
                            <h4 class="text-lg font-bold mb-1">المتجر العلاجي</h4>
                            <p class="text-gray-600">منتجات ومكملات موصى بها.</p>
                        </a>
                        <a href="#" class="nav-link dashboard-card block p-6 rounded-xl shadow-lg text-center" data-view="dashboard">
                            <div class="text-4xl text-[--primary-color] mb-2"><i class="fas fa-magic-wand-sparkles"></i></div>
                            <h4 class="text-lg font-bold mb-1">الأدوات الذكية</h4>
                            <p class="text-gray-600">تحليلات وتوصيات مُعينة.</p>
                        </a>
                    </div>
                </div>
            </div>
        </section>

        <!-- Interactive Dashboard Section -->
        <section id="view-dashboard" class="page-view py-20 bg-gray-50 hidden">
            <div class="container max-w-screen-lg mx-auto px-4 sm:px-6 text-center">
                <h2 class="large-title text-4xl font-bold mb-4 section-title">لوحة التحكم التفاعلية</h2>
                <p class="max-w-3xl mx-auto mb-12">اختر الأداة أو الخدمة التي تناسب احتياجك الحالي وابدأ رحلة الشفاء.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <!-- Card 1: AI Tools -->
                    <div class="p-8 rounded-xl shadow-lg dashboard-card text-center md:col-span-2">
                        <div class="text-5xl text-[--primary-color] mb-4"><i class="fas fa-magic-wand-sparkles"></i></div>
                        <h3 class="text-2xl font-bold mb-3">الأدوات الذكية</h3>
                        <p class="text-gray-600 mb-4">استخدم أدوات الذكاء الاصطناعي للتشخيص، إنشاء الخطط العلاجية، الحصول على توصيات، والمزيد.</p>
                        <div class="mb-4 flex flex-col md:flex-row items-stretch md:items-center gap-3">
                            <div class="segmented-control" role="tablist" aria-label="تصنيف الأدوات">
                                <button class="tool-cat-btn btn btn-outline px-3 py-1 rounded-full" data-cat="all" aria-selected="true" id="tool-cat-all">الكل</button>
                                <button class="tool-cat-btn btn btn-outline px-3 py-1 rounded-full" data-cat="medical" aria-selected="false" id="tool-cat-med">طبي</button>
                                <button class="tool-cat-btn btn btn-outline px-3 py-1 rounded-full" data-cat="wellness" aria-selected="false" id="tool-cat-wellness">عافية</button>
                                <button class="tool-cat-btn btn btn-outline px-3 py-1 rounded-full" data-cat="smart" aria-selected="false" id="tool-cat-smart">ذكي</button>
                            </div>
                            <div class="flex-1">
                                <input id="tool-search" type="text" class="w-full p-2 border rounded-md" aria-label="ابحث عن أداة" placeholder="ابحث عن أداة...">
                            </div>
                        </div>
                        <div id="tool-favorites" class="mb-4 hidden text-right">
                            <h4 class="font-bold mb-2">المفضلة</h4>
                            <div id="tool-fav-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"></div>
                        </div>
                        <div id="tool-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                           <button class="smart-tool-btn btn btn-secondary w-full py-2 rounded-full" data-tool="blood-test-decoder" data-cat="medical">فك شفرة التحاليل</button>
                           <button class="smart-tool-btn btn btn-secondary w-full py-2 rounded-full" data-tool="diagnosis" data-cat="medical">التشخيص</button>
                           <button class="smart-tool-btn btn btn-secondary w-full py-2 rounded-full" data-tool="treatment-plan" data-cat="medical">خطة علاجية</button>
                           <button class="smart-tool-btn btn btn-secondary w-full py-2 rounded-full" data-tool="supplements" data-cat="medical">توصية مكملات</button>
                           <button class="smart-tool-btn btn btn-secondary w-full py-2 rounded-full" data-tool="med-interactions" data-cat="medical">تداخلات الأدوية</button>
                           <button class="smart-tool-btn btn btn-secondary w-full py-2 rounded-full" data-tool="nutrition-plan" data-cat="wellness">خطة تغذية أسبوعية</button>
                           <button class="smart-tool-btn btn btn-secondary w-full py-2 rounded-full" data-tool="sleep-coach" data-cat="wellness">مدرب النوم</button>
                           <button class="smart-tool-btn btn btn-secondary w-full py-2 rounded-full" data-tool="awareness-exercise" data-cat="wellness">تمرين وعي</button>
                           <button class="smart-tool-btn btn btn-secondary w-full py-2 rounded-full" data-tool="intention" data-cat="wellness">نية اليوم</button>
                           <button class="smart-tool-btn btn btn-secondary w-full py-2 rounded-full" data-tool="consultation" data-cat="smart">استشارة آلية</button>
                           <button class="smart-tool-btn btn btn-secondary w-full py-2 rounded-full" data-tool="protocols" data-cat="smart">بروتوكولات طِبرا</button>
                        </div>
                        <p class="text-xs text-gray-500 mt-4 text-right">هذه الأدوات معلومات عامة وليست بديلاً عن التشخيص أو وصف العلاج. راجع طبيبك دائماً.</p>
                    </div>

                    <!-- Card 2: Wheel of Life -->
                    <a href="#" class="nav-link group dashboard-card block p-8 rounded-xl shadow-lg text-center" data-view="wheel-of-life">
                        <div class="text-5xl text-[--primary-color] mb-4 group-hover:text-[--accent-color] transition-colors"><i class="fa-solid fa-dharmachakra"></i></div>
                        <h3 class="text-2xl font-bold mb-3">عجلة العافية</h3>
                        <p class="text-gray-600">قيّم جوانب حياتك المختلفة واحصل على رؤى فورية لتحقيق التوازن.</p>
                    </a>
                    
                    <!-- NEW Card: Body Map -->
                    <a href="#" class="nav-link group dashboard-card block p-8 rounded-xl shadow-lg text-center" data-view="body-map">
                        <div class="text-5xl text-[--primary-color] mb-4 group-hover:text-[--accent-color] transition-colors"><i class="fa-solid fa-person-chalkboard"></i></div>
                        <h3 class="text-2xl font-bold mb-3">خريطة الجسد الشعوري</h3>
                        <p class="text-gray-600">استكشف أعضاء جسدك وافهم رسائلها من منظور الطب الشعوري.</p>
                    </a>

                    <!-- NEW Card: Symptom Journal -->
                    <a href="#" class="nav-link group dashboard-card block p-8 rounded-xl shadow-lg text-center" data-view="journal">
                        <div class="text-5xl text-[--primary-color] mb-4 group-hover:text-[--accent-color] transition-colors"><i class="fa-solid fa-book-medical"></i></div>
                        <h3 class="text-2xl font-bold mb-3">مفكرة الأعراض والمزاج</h3>
                        <p class="text-gray-600">تتبع صحتك اليومية واكتشف الأنماط الخفية (للمسجلين فقط).</p>
                    </a>

                    <!-- NEW Card: Quizzes -->
                    <a href="#" class="nav-link group dashboard-card block p-8 rounded-xl shadow-lg text-center" data-view="quizzes">
                        <div class="text-5xl text-[--primary-color] mb-4 group-hover:text-[--accent-color] transition-colors"><i class="fa-solid fa-clipboard-question"></i></div>
                        <h3 class="text-2xl font-bold mb-3">التقييمات الصحية</h3>
                        <p class="text-gray-600">أجب عن استبيانات دقيقة لتقييم جوانب محددة من صحتك.</p>
                    </a>
                    
                    <a href="#" class="nav-link group dashboard-card block p-8 rounded-xl shadow-lg text-center" data-view="frequencies">
                        <div class="text-5xl text-[--primary-color] mb-4 group-hover:text-[--accent-color] transition-colors"><i class="fas fa-wave-square"></i></div>
                        <h3 class="text-2xl font-bold mb-3">الترددات الشفائية</h3>
                        <p class="text-gray-600">استمع إلى ترددات السولفيجيو وترددات النقلة الموازية.</p>
                    </a>
                    
                    <a href="#" class="nav-link group dashboard-card block p-8 rounded-xl shadow-lg text-center" data-view="blog">
                        <div class="text-5xl text-[--primary-color] mb-4 group-hover:text-[--accent-color] transition-colors"><i class="fas fa-book-open"></i></div>
                        <h3 class="text-2xl font-bold mb-3">المقالات والمعرفة</h3>
                        <p class="text-gray-600">اقرأ أحدث المقالات والرؤى حول الطب الشمولي.</p>
                    </a>
                    <!-- NEW Card: Chronic Care Q&A Hub -->
                    <a href="#" class="nav-link group dashboard-card block p-8 rounded-xl shadow-lg text-center" data-view="chronic-care">
                        <div class="text-5xl text-[--primary-color] mb-4 group-hover:text-[--accent-color] transition-colors"><i class="fa-solid fa-stethoscope"></i></div>
                        <h3 class="text-2xl font-bold mb-3">مركز دعم الأمراض المزمنة</h3>
                        <p class="text-gray-600">إجابات عامة موثوقة وأسئلة شائعة مع توجيه لحجز استشارة باطنية.</p>
                    </a>
                    <a href="#" class="nav-link group dashboard-card block p-8 rounded-xl shadow-lg text-center" data-view="premium-content">
                        <div class="text-5xl text-[--primary-color] mb-4 group-hover:text-[--accent-color] transition-colors"><i class="fas fa-folder-user"></i></div>
                        <h3 class="text-2xl font-bold mb-3">ملف المريض</h3>
                        <p class="text-gray-600">ادخل إلى مساحتك الخاصة لمراجعة نتائجك المحفوظة.</p>
                    </a>
                </div>
            </div>
        </section>
        
        <!-- Medical Travel & Logistics (NEW) -->
        <section id="view-medical-travel" class="page-view py-20 bg-white hidden">
            <div class="container max-w-screen-lg mx-auto px-4 sm:px-6">
                <div class="text-right mb-10">
                    <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="dashboard">
                        <i class="fas fa-arrow-right-long ml-2"></i>
                        الرجوع إلى لوحة التحكم
                    </button>
                </div>
                <div class="text-center mb-8">
                    <h2 class="large-title text-4xl font-bold mb-3 section-title">تنسيق السفر الطبي للحالات المعقدة</h2>
                    <p class="max-w-3xl mx-auto text-lg">ننسق مواعيدك، تجهيز مستنداتك الطبية، والسكن/المستشفى في المراكز المتقدمة داخل صنعاء أو خارج اليمن.</p>
                </div>

                <div class="legal-disclaimer rounded-lg p-4 mb-6 text-right">
                    <p class="font-bold text-[--primary-dark]">هذه خدمة لوجستية وتنسيقية وليست بديلاً عن خدمات الطوارئ أو التشخيص اللحظي.</p>
                    <p class="text-sm text-gray-700">يرجى الاتصال بخدمة الإسعاف في الحالات الطارئة.</p>
                </div>

                <form id="medical-travel-form" class="bg-gray-50 p-6 rounded-xl shadow-md max-w-4xl mx-auto">
                    <h3 class="text-2xl font-bold mb-4 text-right">طلب تنسيق سفر طبي</h3>

                    <div class="inset-section">
                        <p class="inset-title">بيانات المريض</p>
                        <div class="inset-group">
                            <div class="inset-cell">
                                <label class="inset-label" for="mt-fullname">الاسم الكامل</label>
                                <input id="mt-fullname" class="inset-input" required />
                            </div>
                            <div class="inset-cell">
                                <label class="inset-label" for="mt-dob">تاريخ الميلاد</label>
                                <input id="mt-dob" type="date" class="inset-input" required />
                            </div>
                            <div class="inset-cell">
                                <label class="inset-label" for="mt-phone">رقم الهاتف</label>
                                <input id="mt-phone" class="inset-input" required />
                            </div>
                            <div class="inset-cell">
                                <label class="inset-label" for="mt-email">البريد الإلكتروني</label>
                                <input id="mt-email" type="email" class="inset-input" required />
                            </div>
                            <div class="inset-cell">
                                <label class="inset-label" for="mt-city">المدينة</label>
                                <input id="mt-city" class="inset-input" />
                            </div>
                            <div class="inset-cell">
                                <label class="inset-label" for="mt-nationality">الجنسية</label>
                                <input id="mt-nationality" class="inset-input" />
                            </div>
                        </div>
                    </div>

                    <div class="inset-section">
                        <p class="inset-title">معلومات طبية</p>
                        <div class="inset-group">
                            <div class="inset-cell">
                                <label class="inset-label" for="mt-diagnosis">ملخص الحالة/التشخيص الحالي</label>
                                <textarea id="mt-diagnosis" rows="3" class="inset-input inset-textarea" required></textarea>
                            </div>
                            <div class="inset-cell">
                                <label class="inset-label" for="mt-comorbid">أمراض مصاحبة/أدوية حالية/حساسية</label>
                                <textarea id="mt-comorbid" rows="3" class="inset-input inset-textarea"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="inset-section">
                        <p class="inset-title">اللوجستيات</p>
                        <div class="inset-group">
                            <div class="inset-cell">
                                <label class="inset-label" for="mt-urgency">درجة الإلحاح</label>
                                <select id="mt-urgency" class="inset-input">
                                    <option>عادية</option>
                                    <option>متوسطة</option>
                                    <option>عالية</option>
                                </select>
                            </div>
                            <div class="inset-cell">
                                <label class="inset-label" for="mt-destination">الوجهة المفضلة</label>
                                <select id="mt-destination" class="inset-input">
                                    <option>صنعاء</option>
                                    <option>مصر</option>
                                    <option>الهند</option>
                                    <option>أخرى</option>
                                </select>
                            </div>
                            <div class="inset-cell">
                                <label class="inset-label" for="mt-companions">عدد المرافقين (إن وجد)</label>
                                <input id="mt-companions" type="number" min="0" class="inset-input" />
                            </div>
                            <div class="inset-cell">
                                <label class="inset-label" for="mt-dates">فترة السفر المفضلة</label>
                                <input id="mt-dates" class="inset-input" placeholder="مثال: منتصف نوفمبر" />
                            </div>
                        </div>
                    </div>

                    <div class="inset-section">
                        <p class="inset-title">الملفات الطبية</p>
                        <div class="inset-group">
                            <div class="inset-cell">
                                <label class="inset-label" for="mt-files">رفع التقارير الطبية</label>
                                <input id="mt-files" type="file" multiple accept=".pdf,.jpg,.jpeg,.png,.heic,.heif" class="inset-input" />
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 text-left">
                        <button id="mt-submit" type="submit" class="btn btn-primary text-white py-2 px-6 rounded-full">إرسال الطلب</button>
                    </div>
                    <div id="mt-result" class="mt-4 text-right" role="status" aria-live="polite"></div>
                </form>
            </div>
        </section>

        <!-- Second Opinion (NEW) -->
        <section id="view-second-opinion" class="page-view py-20 bg-white hidden">
            <div class="container max-w-screen-lg mx-auto px-4 sm:px-6">
                <div class="text-right mb-10">
                    <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="dashboard">
                        <i class="fas fa-arrow-right-long ml-2"></i>
                        الرجوع إلى لوحة التحكم
                    </button>
                </div>
                <div class="text-center mb-8">
                    <h2 class="large-title text-4xl font-bold mb-3 section-title">الرأي الطبي الثاني (مراجعة التقارير عن بُعد)</h2>
                    <p class="max-w-3xl mx-auto text-lg">استشر استشاريين كبار في مصر أو الهند أو غيرها. أرسل تقاريرك الطبية واحصل على توصيات عملية للخطوات التالية.</p>
                </div>

                <div class="legal-disclaimer rounded-lg p-4 mb-6 text-right">
                    <p class="font-bold text-[--primary-dark]">هذه الخدمة لا تستبدل الفحص السريري المباشر، وهي غير مناسبة للطوارئ.</p>
                    <p class="text-sm text-gray-700">قد تتطلب المراكز أو الاستشاريون فحوصات إضافية قبل التوصية النهائية.</p>
                </div>

                <form id="second-opinion-form" class="bg-gray-50 p-6 rounded-xl shadow-md max-w-4xl mx-auto">
                    <h3 class="text-2xl font-bold mb-4 text-right">إرسال التقارير للرأي الطبي الثاني</h3>

                    <div class="inset-section">
                        <p class="inset-title">بيانات المريض</p>
                        <div class="inset-group">
                            <div class="inset-cell">
                                <label class="inset-label" for="so-fullname">الاسم الكامل</label>
                                <input id="so-fullname" class="inset-input" required />
                            </div>
                            <div class="inset-cell">
                                <label class="inset-label" for="so-phone">رقم الهاتف</label>
                                <input id="so-phone" class="inset-input" required />
                            </div>
                            <div class="inset-cell">
                                <label class="inset-label" for="so-email">البريد الإلكتروني</label>
                                <input id="so-email" type="email" class="inset-input" required />
                            </div>
                        </div>
                    </div>

                    <div class="inset-section">
                        <p class="inset-title">تفضيلات الوجهة</p>
                        <div class="inset-group">
                            <div class="inset-cell">
                                <label class="inset-label" for="so-region">الوجهة/البلد المفضل</label>
                                <select id="so-region" class="inset-input">
                                    <option>مصر</option>
                                    <option>الهند</option>
                                    <option>لا تفضيل محدد</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="inset-section">
                        <p class="inset-title">معلومات طبية</p>
                        <div class="inset-group">
                            <div class="inset-cell">
                                <label class="inset-label" for="so-summary">ملخص الحالة والتشخيص حتى الآن</label>
                                <textarea id="so-summary" rows="3" class="inset-input inset-textarea" required></textarea>
                            </div>
                            <div class="inset-cell">
                                <label class="inset-label" for="so-questions">أسئلتك المحددة للاستشاري</label>
                                <textarea id="so-questions" rows="3" class="inset-input inset-textarea"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="inset-section">
                        <p class="inset-title">الملفات الطبية</p>
                        <div class="inset-group">
                            <div class="inset-cell">
                                <label class="inset-label" for="so-files">رفع التقارير الطبية</label>
                                <input id="so-files" type="file" multiple accept=".pdf,.jpg,.jpeg,.png,.heic,.heif" class="inset-input" />
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 text-left">
                        <button id="so-submit" type="submit" class="btn btn-primary text-white py-2 px-6 rounded-full">إرسال الطلب</button>
                    </div>
                    <div id="so-result" class="mt-4 text-right" role="status" aria-live="polite"></div>
                </form>
            </div>
        </section>
        
        <!-- Wheel of Life Section -->
        <section id="view-wheel-of-life" class="page-view py-20 bg-white hidden">
             <div class="container max-w-screen-lg mx-auto px-4 sm:px-6">
                 <div class="text-right mb-12">
                     <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="dashboard">
                         <i class="fas fa-arrow-right-long ml-2"></i>
                         الرجوع إلى لوحة التحكم
                     </button>
                 </div>
                <div class="text-center mb-12">
                    <h2 class="large-title text-4xl font-bold mb-4 section-title">عجلة العافية الشمولية</h2>
                    <p class="max-w-3xl mx-auto text-lg">قيّم مستوى رضاك في الجوانب الأساسية لحياتك. حرك المؤشرات لتعكس وضعك الحالي، ثم احصل على رؤى فورية لمساعدتك على تحديد نقاط التركيز في رحلتك نحو التوازن.</p>
                </div>

                <div id="wheel-of-life-result-container" class="grid grid-cols-1 md:grid-cols-2 gap-12 items-center">
                    <!-- Chart Canvas -->
                    <div class="w-full max-w-lg mx-auto fade-in-up">
                        <canvas id="wheel-of-life-chart"></canvas>
                    </div>
                    <!-- Sliders -->
                    <div id="wheel-of-life-sliders" class="space-y-4 fade-in-up" style="animation-delay: 0.2s;">
                        <!-- Sliders will be dynamically generated here -->
                    </div>
                </div>

                <!-- Result Section -->
                <div class="mt-12 text-center">
                     <button id="get-wheel-insight-btn" class="btn btn-primary text-white py-3 px-8 text-lg rounded-full">اكشف عن رؤيتك الشخصية</button>
                     <div id="wheel-of-life-result" class="mt-6 p-6 bg-green-50 border-r-4 border-primary-color rounded-lg max-w-4xl mx-auto opacity-0 hidden">
                         <!-- AI Insight will be injected here -->
                     </div>
                </div>
            </div>
        </section>

        <!-- About Me Section -->
        <section id="view-about" class="page-view py-20 bg-white hidden">
             <div class="container max-w-screen-lg mx-auto px-4 sm:px-6">
                 <div class="text-right mb-12">
                     <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="dashboard">
                         <i class="fas fa-arrow-right-long ml-2"></i>
                         الرجوع إلى لوحة التحكم
                     </button>
                 </div>
                <div class="md:flex items-center gap-12">
                    <div class="md:w-1/3 text-center fade-in-up">
                        <img src="assets/images/omar.jpg" alt="صورة د. عمر العماد" loading="lazy" decoding="async" class="rounded-full shadow-2xl mx-auto w-64 h-64 md:w-80 md:h-80 object-cover border-4 border-white">
                    </div>
                    <div class="md:w-2/3 mt-8 md:mt-0 fade-in-up">
                        <h2 class="large-title text-4xl font-bold mb-4 section-title text-right">عن د. عمر العماد</h2>
                        <p class="mb-4">🌿 ماذا لو لم يكن مرضك مجرّد عرَض… بل نداء داخلي للعودة إلى ذاتك؟</p>

                        <p class="mb-4">أنا د. عمر، طبيبٌ عام، وباحثٌ في علوم الشفاء الجسدي–الروحي.<br>لا أقدّم لك دواءً فقط… بل منهجًا يعيدك إلى فطرتك.<br>أسّست <strong>Ṭibra | طِبرا – طب يعيدك إليك</strong> لأدمج فيه بين الطب الحديث، والحكمة التي حملها الأنبياء، والصوت الذي يناديك من داخلك منذ زمن.</p>

                        <h3 class="text-2xl font-semibold text-[--primary-color] mb-2">🔍 ماذا أفعل؟</h3>
                        <ul class="list-disc pr-6 mb-4 text-right">
                            <li>فهم جذر مرضك، لا فقط إيقاف أعراضه</li>
                            <li>استخدام التحاليل والمكملات بطريقة واعية وفعّالة</li>
                            <li>التحرر من أنماط نفسية وجسدية تربك طاقتك</li>
                            <li>بناء برنامج شفاء متكامل: طب حديث × علاج طاقي × غذاء وظيفي × تمرينات شفاء ذاتي</li>
                        </ul>

                        <h3 class="text-2xl font-semibold text-[--primary-color] mb-2">🎯 لمن أعمل؟</h3>
                        <ul class="list-disc pr-6 mb-4 text-right">
                            <li>لمن جرّب كل شيء… ومازال يعاني من مرضه المزمن</li>
                            <li>لمن يؤمن أن الجسد لا يخطئ، بل يتحدث</li>
                            <li>لمن يريد أن يتحرّر من التكرار، ويبدأ مسارًا حقيقيًا نحو الشفاء</li>
                        </ul>

                        <h3 class="text-2xl font-semibold text-[--primary-color] mb-2">🌀 لماذا طِبرا؟</h3>
                        <ul class="list-disc pr-6 mb-4 text-right">
                            <li>لأنّ الطب ليس وصفة… بل وعي أيضًا.</li>
                            <li>لأنّ المرض ليس عدوًا… بل رسالة.</li>
                            <li>ولأنك تستحق أن تُعامل كإنسانٍ حيّ واعٍ، لا رقم في ملف.</li>
                        </ul>

                        <h3 class="text-2xl font-semibold text-[--primary-color] mb-2">🧬 من هو د. عمر؟</h3>
                        <ul class="list-disc pr-6 mb-4 text-right">
                            <li>طبيب عام</li>
                            <li>باحث في الشفاء الوظيفي–الطاقي</li>
                            <li>مؤسس منهج Ṭibra</li>
                            <li>أعمل على تطوير أدوات ذكية تشخّص وترافق رحلة المريض، لا تتحكم فيه</li>
                        </ul>

                        <h3 class="text-2xl font-semibold text-[--primary-color] mb-2">🚀 كيف تبدأ؟</h3>
                        <p class="mb-4">احجز استشارة أولى لتقييم وضعك الجسدي والنفسي، وبناء خطة شفاء مخصصة.<br>
                        أو تعرّف على <a href="#" class="nav-link text-[--accent-color] underline" data-view="dashboard">أدوات “طِبرا” عبر الموقع</a>.</p>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Services Section -->
        <section id="view-services" class="page-view py-20 hidden">
             <div class="container max-w-screen-lg mx-auto px-4 sm:px-6 text-center">
                 <div class="text-right mb-12">
                     <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="dashboard">
                         <i class="fas fa-arrow-right-long ml-2"></i>
                         الرجوع إلى لوحة التحكم
                     </button>
                 </div>
                <h2 class="large-title text-4xl font-bold mb-4 section-title">جلسات العلاج الشمولي</h2>
                <p class="max-w-2xl mx-auto mb-12">جلسات شخصية عن بعد، مصممة خصيصاً لتلبية احتياجاتك الفريدة ومساعدتك على تحقيق أهدافك الصحية.</p>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 fade-in-up hover:-translate-y-2">
                        <div class="text-5xl text-[--accent-color] mb-4"><i class="fas fa-user-md"></i></div>
                        <h3 class="text-2xl font-bold mb-3">استشارة أولية شاملة</h3>
                        <p class="mb-6">جلسة لمدة 90 دقيقة لتقييم حالتك الصحية بالكامل، مناقشة تاريخك المرضي، ووضع خريطة طريق علاجية مخصصة.</p>
                        <a href="https://wa.me/967771447111?text=أرغب%20في%20حجز%20استشارة%20أولية%20شاملة" target="_blank" class="btn btn-primary text-white py-2 px-6 rounded-full">احجز الآن</a>
                    </div>
                    <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 fade-in-up hover:-translate-y-2" style="animation-delay: 0.2s;">
                        <div class="text-5xl text-[--accent-color] mb-4"><i class="fas fa-heartbeat"></i></div>
                        <h3 class="text-2xl font-bold mb-3">باقة المتابعة الصحية</h3>
                        <p class="mb-6">3 جلسات متابعة (45 دقيقة لكل جلسة) لمراقبة تقدمك، تعديل الخطة العلاجية، وتقديم الدعم المستمر لك.</p>
                         <a href="https://wa.me/967771447111?text=أرغب%20في%20الاشتراك%20بباقة%20المتابعة%20الصحية" target="_blank" class="btn btn-primary text-white py-2 px-6 rounded-full">اشترك الآن</a>
                    </div>
                    <div class="bg-white p-8 rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 fade-in-up hover:-translate-y-2" style="animation-delay: 0.4s;">
                        <div class="text-5xl text-[--accent-color] mb-4"><i class="fas fa-leaf"></i></div>
                        <h3 class="text-2xl font-bold mb-3">استشارة التغذية الوظيفية</h3>
                        <p class="mb-6">جلسة مركزة لمدة 60 دقيقة لوضع خطة تغذية علاجية مخصصة لمعالجة مشاكل صحية معينة مثل مشاكل الهضم أو الطاقة.</p>
                         <a href="https://wa.me/967771447111?text=أرغب%20في%20حجز%20استشارة%20التغذية%20الوظيفية" target="_blank" class="btn btn-primary text-white py-2 px-6 rounded-full">احجز الآن</a>
                    </div>
                </div>
            </div>
        </section>

        <!-- Store Section -->
        <section id="view-store" class="page-view py-20 bg-gray-50 hidden">
            <div class="container max-w-screen-lg mx-auto px-4 sm:px-6 text-center">
                 <div class="text-right mb-12">
                     <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="dashboard">
                         <i class="fas fa-arrow-right-long ml-2"></i>
                         الرجوع إلى لوحة التحكم
                     </button>
                 </div>
                <h2 class="large-title text-4xl font-bold mb-4 section-title">متجر المنتجات الشافية</h2>
                <p class="max-w-2xl mx-auto mb-12">مجموعة منتقاة بعناية من المنتجات الطبيعية والأدوية الوظيفية التي أثق بها وأوصي بها لدعم رحلتك العلاجية.</p>
                <div id="store-products-grid" class="grid md:grid-cols-2 lg:grid-cols-4 gap-8">
                    <div class="border bg-white border-gray-200 rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 fade-in-up hover:-translate-y-2">
                        <img src="assets/images/DMSO%20.webp" alt="DMSO للجلد" loading="lazy" decoding="async" class="w-full h-56 object-cover">
                        <div class="p-6">
                            <h3 class="text-xl font-bold mb-2">DMSO للجلد</h3>
                            <p class="text-gray-600 mb-4">مذيب طبيعي قوي لدعم الشفاء وتخفيف الألم الموضعي.</p>
                            <p class="text-2xl font-bold text-[--primary-color] mb-4">$45</p>
                            <a href="https://wa.me/967771447111?text=أرغب%20في%20شراء%20DMSO%20للجلد" target="_blank" class="btn btn-secondary w-full block py-2 rounded-full">اطلب عبر واتساب</a>
                        </div>
                    </div>
                    <div class="border bg-white border-gray-200 rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 fade-in-up hover:-translate-y-2" style="animation-delay: 0.1s;">
                        <img src="assets/images/Vit%20D3%20+%20K2%20.webp" alt="مكمل فيتامين D3 + K2" loading="lazy" decoding="async" class="w-full h-56 object-cover">
                        <div class="p-6">
                            <h3 class="text-xl font-bold mb-2">مكمل فيتامين د3 + ك2</h3>
                            <p class="text-gray-600 mb-4">لدعم صحة العظام والمناعة.</p>
                            <p class="text-2xl font-bold text-[--primary-color] mb-4">$35</p>
                            <a href="https://wa.me/967771447111?text=أرغب%20في%20شراء%20مكمل%20فيتامين%20د3%20%2B%20ك2" target="_blank" class="btn btn-secondary w-full block py-2 rounded-full">اطلب عبر واتساب</a>
                        </div>
                    </div>
                    <div class="border bg-white border-gray-200 rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 fade-in-up hover:-translate-y-2" style="animation-delay: 0.2s;">
                        <img src="assets/images/magnesium-citrate-solaray-400-2.webp" alt="زيت الماغنيسيوم النقي" loading="lazy" decoding="async" class="w-full h-56 object-cover">
                        <div class="p-6">
                            <h3 class="text-xl font-bold mb-2">زيت الماغنسيوم النقي</h3>
                            <p class="text-gray-600 mb-4">للاسترخاء وتخفيف آلام العضلات.</p>
                             <p class="text-2xl font-bold text-[--primary-color] mb-4">$25</p>
                            <a href="https://wa.me/967771447111?text=أرغب%20في%20شراء%20زيت%20الماغنسيوم%20النقي" target="_blank" class="btn btn-secondary w-full block py-2 rounded-full">اطلب عبر واتساب</a>
                        </div>
                    </div>
                    <div class="border bg-white border-gray-200 rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 fade-in-up hover:-translate-y-2" style="animation-delay: 0.3s;">
                        <img src="assets/images/بكتيرياء%20نافعة%20probiotic%20.png" alt="بروبيوتيك عالي الجودة" loading="lazy" decoding="async" class="w-full h-56 object-cover">
                        <div class="p-6">
                            <h3 class="text-xl font-bold mb-2">بروبيوتيك عالي الجودة</h3>
                            <p class="text-gray-600 mb-4">لدعم صحة الجهاز الهضمي والميكروبيوم.</p>
                             <p class="text-2xl font-bold text-[--primary-color] mb-4">$50</p>
                            <a href="https://wa.me/967771447111?text=أرغب%20في%20شراء%20بروبيوتيك%20عالي%20الجودة" target="_blank" class="btn btn-secondary w-full block py-2 rounded-full">اطلب عبر واتساب</a>
                        </div>
                    </div>
                    <!-- NEW Product: Tibrah Ora – باكج صحة اللثة والأسنان -->
                    <div class="border bg-white border-gray-200 rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 fade-in-up hover:-translate-y-2" style="animation-delay: 0.4s;">
                        <img src="assets/images/اساسي 2 ).png" alt="tibrah ora | باكج صحة اللثة والأسنان" loading="lazy" decoding="async" class="w-full h-56 object-cover">
                        <div class="p-6 text-right">
                            <h3 class="text-xl font-bold mb-2">tibrah ora | باكج صحة اللثة والأسنان</h3>
                            <p class="text-gray-600 mb-4">نظام متكامل لتنقية الفم وإنعاش النفس (مضمضة علاجية + بخاخ عشبي).</p>
                            <p class="text-2xl font-bold text-[--primary-color] mb-4">3300 ريال يمني</p>
                            <a href="https://wa.me/967771447111?text=أرغب%20في%20شراء%20باكج%20Tibrah%20Ora" target="_blank" class="btn btn-secondary w-full block py-2 rounded-full">اطلب عبر واتساب</a>
                            <button class="btn btn-outline w-full mt-4 details-button" data-prod="tibrahOra">وصف المنتج</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Frequency Generator Section -->
        <section id="view-frequencies" class="page-view py-20 bg-white hidden">
            <div class="container max-w-screen-lg mx-auto px-4 sm:px-6 text-center">
                 <div class="text-right mb-12">
                     <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="dashboard">
                         <i class="fas fa-arrow-right-long ml-2"></i>
                         الرجوع إلى لوحة التحكم
                     </button>
                 </div>
                <h2 class="large-title text-4xl font-bold mb-4 section-title">مولد الترددات الشفائية</h2>
                <p class="max-w-2xl mx-auto mb-6">استمع للترددات النقية للتأمل العميق، أو اختر الموسيقى الهادئة للاسترخاء. استخدم سماعات الرأس لأفضل تأثير.</p>
                
                <div id="audio-init-prompt" class="text-center mb-8">
                    <button id="start-audio-btn" class="btn btn-primary text-white py-3 px-8 text-lg rounded-full">
                        <i class="fas fa-power-off mr-2"></i> بدء النظام الصوتي
                    </button>
                </div>

                <div id="frequency-player-container" class="bg-gray-100 p-8 rounded-xl shadow-lg max-w-5xl mx-auto hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                        <div>
                            <h3 class="text-2xl font-bold mb-4">مشغل الترددات</h3>
                             <canvas id="frequency-canvas" class="w-full h-40 mb-4"></canvas>
                             <button id="stop-freq-btn" class="btn btn-secondary py-2 px-6 rounded-full w-full">إيقاف التردد</button>
                        </div>
                        <div>
                           <h3 class="text-2xl font-bold mb-4">موسيقى هادئة</h3>
                           <div id="music-player" class="bg-white p-4 rounded-lg">
                               <p id="music-title" class="font-bold text-lg">موسيقى للاسترخاء</p>
                               <p class="text-sm text-gray-500 mb-2">تأليف: Ashot Danielyan</p>
                               <audio id="background-music" loop src="https://cdn.pixabay.com/download/audio/2022/11/21/audio_a1bf8202ef.mp3"></audio>
                               <div class="flex items-center gap-4 mt-2">
                                   <button id="music-play-pause-btn" class="music-btn text-3xl text-[--primary-color]"><i class="fas fa-play"></i></button>
                                   <input id="music-volume" type="range" min="0" max="1" step="0.01" value="0.5" class="w-full">
                               </div>
                           </div>
                        </div>
                    </div>
                    <hr class="my-8">
                    <h3 class="text-2xl font-bold mb-4">ترددات النقلة الموازية (Parallel Shift)</h3>
                     <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8" id="parallel-shift-buttons">
                        <button class="freq-btn p-3 rounded-lg border-2 border-gray-200 transition bg-white" data-freq="7.83">
                            <span>7.83 Hz - تردد شومان</span>
                            <span class="freq-description">التجذر والتناغم مع الأرض</span>
                        </button>
                        <button class="freq-btn p-3 rounded-lg border-2 border-gray-200 transition bg-white" data-freq="432">
                            <span>432 Hz - التناغم الكوني</span>
                             <span class="freq-description">السكينة والهدوء الداخلي</span>
                        </button>
                        <button class="freq-btn p-3 rounded-lg border-2 border-gray-200 transition bg-white" data-freq="111">
                            <span>111 Hz - الجسر الطاقي</span>
                            <span class="freq-description">ربط العقل الواعي باللاواعي</span>
                        </button>
                        <button class="freq-btn p-3 rounded-lg border-2 border-gray-200 transition bg-white" data-freq="222">
                            <span>222 Hz - الثقة والتوازن</span>
                             <span class="freq-description">إعادة التوازن والثقة بالمسار</span>
                        </button>
                    </div>

                    <h3 class="text-2xl font-bold mb-4">ترددات السولفيجيو العلاجية</h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-3 gap-4" id="frequency-buttons">
                        <button class="freq-btn p-3 rounded-lg border-2 border-gray-200 transition bg-white" data-freq="396">
                            <span>396 Hz - تحرير الذنب</span>
                             <span class="freq-description">التخلص من الخوف والشعور بالذنب</span>
                        </button>
                        <button class="freq-btn p-3 rounded-lg border-2 border-gray-200 transition bg-white" data-freq="417">
                            <span>417 Hz - تسهيل التغيير</span>
                             <span class="freq-description">إزالة الطاقات السلبية</span>
                        </button>
                        <button class="freq-btn p-3 rounded-lg border-2 border-gray-200 transition bg-white" data-freq="528">
                            <span>528 Hz - التحول والمعجزات</span>
                             <span class="freq-description">إصلاح الحمض النووي (DNA)</span>
                        </button>
                        <button class="freq-btn p-3 rounded-lg border-2 border-gray-200 transition bg-white" data-freq="639">
                             <span>639 Hz - إعادة الاتصال</span>
                            <span class="freq-description">تحسين العلاقات والتناغم</span>
                        </button>
                        <button class="freq-btn p-3 rounded-lg border-2 border-gray-200 transition bg-white" data-freq="741">
                            <span>741 Hz - إيقاظ الحدس</span>
                            <span class="freq-description">التطهير والتعبير عن الذات</span>
                        </button>
                        <button class="freq-btn p-3 rounded-lg border-2 border-gray-200 transition bg-white" data-freq="852">
                            <span>852 Hz - العودة للروح</span>
                             <span class="freq-description">الاتصال بالنظام الروحي</span>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Body Map Section (SVG UPGRADE) -->
        <section id="view-body-map" class="page-view py-20 bg-white hidden">
            <div class="container max-w-screen-lg mx-auto px-4 sm:px-6">
                 <div class="text-right mb-12">
                     <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="dashboard">
                         <i class="fas fa-arrow-right-long ml-2"></i>
                         الرجوع إلى لوحة التحكم
                     </button>
                 </div>
                 <!-- Toolbar: legend, search, filter chips -->
                 <div class="body-map-toolbar">
                    <div class="legend">
                        <span class="legend-item"><span class="swatch" style="background:#b91c1c"></span> قلبي وعائي</span>
                        <span class="legend-item"><span class="swatch" style="background:#2563eb"></span> عصبي</span>
                        <span class="legend-item"><span class="swatch" style="background:#0ea5e9"></span> تنفسي</span>
                        <span class="legend-item"><span class="swatch" style="background:#059669"></span> هضمي</span>
                        <span class="legend-item"><span class="swatch" style="background:#a855f7"></span> غدد صماء</span>
                        <span class="legend-item"><span class="swatch" style="background:#f59e0b"></span> كظري/كلوي</span>
                    </div>
                    <input id="body-map-search" class="search-input" type="search" placeholder="ابحث عن عضو أو عرض (مثال: قلب، قلق)..."/>
                    <div class="chips" role="group" aria-label="تصفية حسب النظام">
                        <button class="chip active" data-filter="all"><span class="dot" style="background:#6b7280"></span> الكل</button>
                        <button class="chip" data-filter="cardio"><span class="dot" style="background:#b91c1c"></span> قلبي</button>
                        <button class="chip" data-filter="neuro"><span class="dot" style="background:#2563eb"></span> عصبي</button>
                        <button class="chip" data-filter="respiratory"><span class="dot" style="background:#0ea5e9"></span> تنفسي</button>
                        <button class="chip" data-filter="digestive"><span class="dot" style="background:#059669"></span> هضمي</button>
                        <button class="chip" data-filter="endocrine"><span class="dot" style="background:#a855f7"></span> غدد</button>
                        <button class="chip" data-filter="adrenal"><span class="dot" style="background:#f59e0b"></span> كظري/كلوي</button>
                    </div>
                    <div class="segmented-control" role="tablist" aria-label="وضع العرض">
                        <button class="btn btn-outline rounded-full px-3 py-1" data-mode="3d" aria-selected="true" title="عرض ثلاثي الأبعاد">3D</button>
                        <button class="btn btn-outline rounded-full px-3 py-1" data-mode="2d" title="عرض ثنائي الأبعاد">2D</button>
                    </div>
                    <div class="segmented-control" role="tablist" aria-label="الجنس">
                        <button class="btn btn-outline rounded-full px-3 py-1" data-sex="male" aria-selected="true" title="ذكر">ذكر</button>
                        <button class="btn btn-outline rounded-full px-3 py-1" data-sex="female" title="أنثى">أنثى</button>
                    </div>
                    <button id="body-map-tune-toggle" class="btn btn-outline rounded-full px-3 py-1" title="وضع الضبط">وضع الضبط</button>
                    <button id="body-map-tune-reset" class="btn btn-outline rounded-full px-3 py-1" title="إعادة ضبط">إعادة ضبط</button>
                    <button id="body-map-export-pdf" class="btn btn-outline rounded-full px-3 py-1" title="تصدير PDF">تصدير PDF</button>
                    <button id="body-map-share" class="btn btn-outline rounded-full px-3 py-1" title="نسخ رابط المشاركة">نسخ الرابط</button>
                    <button id="body-map-copy-summary" class="btn btn-outline rounded-full px-3 py-1" title="نسخ ملخص العضو">نسخ الملخص</button>
                    <button id="body-map-reset-view" class="btn btn-outline rounded-full px-3 py-1" title="تصفير عرض 2D">تصفير العرض</button>
                    <div class="segmented-control" role="tablist" aria-label="وضع الدرس">
                        <button id="body-map-lesson-toggle" class="btn btn-outline rounded-full px-3 py-1" title="بدء الدرس">بدء الدرس</button>
                        <button id="body-map-lesson-prev" class="btn btn-outline rounded-full px-3 py-1 hidden" title="السابق">السابق</button>
                        <button id="body-map-lesson-next" class="btn btn-outline rounded-full px-3 py-1 hidden" title="التالي">التالي</button>
                    </div>
                 </div>
                <div class="text-center mb-12">
                    <h2 class="large-title text-4xl font-bold mb-4 section-title">خريطة الجسد الشعوري</h2>
                    <p class="max-w-3xl mx-auto text-lg">انقر على أي عضو لاستكشاف الأمراض المرتبطة به وأسبابها الشعورية العميقة بناءً على مبادئ الطب الشعوري.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 items-start">
                    <!-- SVG Body Map Container -->
                    <div id="body-map-svg-container" class="md:col-span-1 w-full rounded-lg shadow-lg flex justify-center items-center p-4">
                       <svg id="body-map-svg" class="w-full max-w-xs h-auto" viewBox="0 0 300 600" xmlns="http://www.w3.org/2000/svg">
                            <defs>
                                <linearGradient id="skinGrad" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="0%" stop-color="rgba(230, 211, 193, 0.5)" />
                                    <stop offset="100%" stop-color="rgba(230, 211, 193, 0.25)" />
                                </linearGradient>
                            </defs>
                            <!-- Base Body Outline -->
                            <g id="body-silhouette" fill="url(#skinGrad)" stroke="#c9b8a9" stroke-width="0.6">
                                <!-- Torso, arms, legs silhouette (simplified front view) -->
                                <path d="M150 575
                                         C 130 540, 120 500, 118 470
                                         C 116 440, 118 420, 120 400
                                         C 110 370, 95 340, 95 310
                                         C 95 270, 115 235, 140 220
                                         C 148 213, 148 195, 148 180
                                         C 152 195, 152 213, 160 220
                                         C 185 235, 205 270, 205 310
                                         C 205 340, 190 370, 180 400
                                         C 182 420, 184 440, 182 470
                                         C 180 500, 170 540, 150 575 Z"/>
                                <!-- Neck and head -->
                                <rect x="138" y="160" width="24" height="20" rx="6" ry="6"/>
                                <ellipse cx="150" cy="120" rx="30" ry="36"/>
                                <!-- Arms (subtle) -->
                                <path d="M95 310 C 85 260, 95 230, 115 220 C 110 245, 110 265, 112 295 C 114 320, 108 330, 100 330 C 96 326, 95 320, 95 310 Z" />
                                <path d="M205 310 C 215 260, 205 230, 185 220 C 190 245, 190 265, 188 295 C 186 320, 192 330, 200 330 C 204 326, 205 320, 205 310 Z" />
                                <!-- Leg separation line -->
                                <path d="M150 420 L150 575" stroke="#d8c7b8" stroke-width="1" fill="none"/>
                                <!-- Subtle rib lines -->
                                <path d="M120 235 C 135 228, 165 228, 180 235" stroke="#dbcabc" stroke-width="0.6" fill="none"/>
                                <path d="M118 245 C 135 238, 165 238, 182 245" stroke="#dbcabc" stroke-width="0.5" fill="none"/>
                                <path d="M116 255 C 135 248, 165 248, 184 255" stroke="#dbcabc" stroke-width="0.4" fill="none"/>
                            </g>
                            <!-- Organs -->
                            <path class="organ-path" data-organ="brain" d="M150,120 a26,26 0 1,0 0.1,0 Z" />
                            <ellipse class="organ-path" data-organ="thyroid" cx="150" cy="175" rx="10" ry="6" />
                            <!-- Trachea and Esophagus -->
                            <rect class="organ-path" data-organ="trachea" x="153" y="180" width="5" height="45" rx="2" ry="2" />
                            <rect class="organ-path" data-organ="esophagus" x="142" y="180" width="5" height="45" rx="2" ry="2" />
                            <!-- Lungs (left and right) -->
                            <g data-organ="lungs" class="organ-path">
                                <path d="M135 210 C 120 210, 105 230, 110 260 C 115 285, 135 285, 140 260 C 142 245, 142 225, 135 210 Z" />
                                <path d="M165 210 C 180 210, 195 230, 190 260 C 185 285, 165 285, 160 260 C 158 245, 158 225, 165 210 Z" />
                            </g>
                            <path class="organ-path" data-organ="heart" d="M150 250 C 140 240, 120 245, 125 265 S 150 280, 150 280 S 175 265, 175 265 S 160 240, 150 250 Z" />
                            <path class="organ-path" data-organ="liver" d="M118,315 C 130,300 170,300 180,310 C 175,330 165,335 150,336 C 135,338 125,330 118,315 Z" />
                            <!-- Stomach, Pancreas, Spleen -->
                            <path class="organ-path" data-organ="stomach" d="M160 305 C 147 305, 140 318, 147 332 C 152 341, 168 342, 173 329 C 178 315, 170 305, 160 305 Z" />
                            <path class="organ-path" data-organ="pancreas" d="M140 320 C 155 314, 172 318, 184 324 C 170 330, 153 332, 140 326 Z" />
                            <path class="organ-path" data-organ="spleen" d="M185 300 C 193 305, 198 315, 194 328 C 190 340, 178 342, 173 334 C 170 328, 172 318, 178 310 C 180 306, 183 302, 185 300 Z" />
                            <!-- Gallbladder -->
                            <ellipse class="organ-path" data-organ="gallbladder" cx="168" cy="328" rx="6" ry="8" />
                            <!-- Diaphragm -->
                            <path class="organ-path" data-organ="diaphragm" d="M110 300 Q 150 285 190 300 L 190 305 Q 150 290 110 305 Z" />
                            <path class="organ-path" data-organ="gut" d="M150,380 a45,30 0 1,0 0.1,0 Z M150,380 a30,20 0 1,1 0.1,0 Z" />
                            <!-- Small Intestine (stylized coils) -->
                            <g data-organ="small_intestine" class="organ-path">
                                <path d="M140 360 C 158 355, 165 373, 148 378 C 135 382, 162 390, 160 402 C 158 412, 142 408, 145 396 C 148 388, 132 382, 140 360 Z" />
                            </g>
                            <!-- Colon (outline around intestines) -->
                            <path class="organ-path" data-organ="colon" d="M120 350 C 120 330, 130 318, 145 315 L 155 315 C 170 318, 180 330, 180 350 L 180 390 C 180 410, 170 420, 155 423 L 145 423 C 130 420, 120 410, 120 390 Z" />
                            <g data-organ="adrenals" class="organ-path">
                                <path d="M120,310 a15,8 0 0,1 10,-5" />
                                <path d="M170,310 a15,8 0 0,0 -10,-5" />
                            </g>
                             <g data-organ="kidneys" class="organ-path">
                                <path d="M125 340 C 115 340, 110 370, 125 370 C 135 370, 130 340, 125 340 Z" />
                                <path d="M175 340 C 165 340, 160 370, 175 370 C 185 370, 180 340, 175 340 Z" />
                            </g>
                            <!-- Bladder and Reproductive (sex-specific) -->
                            <ellipse class="organ-path" data-organ="bladder" cx="150" cy="460" rx="18" ry="22" />
                            <!-- Male: Prostate -->
                            <g class="organ-path" data-organ="prostate" data-sex="male">
                                <path d="M150 485 C 145 482, 145 490, 150 493 C 155 490, 155 482, 150 485 Z" />
                            </g>
                            <!-- Female: Uterus and Ovaries -->
                            <g class="organ-path" data-organ="uterus_ovaries" data-sex="female">
                                <!-- Uterus -->
                                <path d="M150 488 C 142 488, 142 498, 150 502 C 158 498, 158 488, 150 488 Z" />
                                <!-- Fallopian tubes -->
                                <path d="M142 494 C 135 492, 132 490, 129 487" />
                                <path d="M158 494 C 165 492, 168 490, 171 487" />
                                <!-- Ovaries -->
                                <ellipse cx="126" cy="485" rx="6" ry="5" />
                                <ellipse cx="174" cy="485" rx="6" ry="5" />
                            </g>
                        </svg>
                        <!-- Tooltip container -->
                        <div id="body-map-tooltip" class="hidden"></div>
                        <!-- Anatomy reference toggle and image -->
                        <button id="anatomy-ref-toggle" class="mt-3 text-sm text-[--primary-color] underline">إخفاء المخطط التشريحي المرجعي</button>
                        <div id="anatomy-ref" class="mt-3 w-full">
                            <img id="anatomy-ref-img" src="https://commons.wikimedia.org/wiki/Special:FilePath/Internal_organs.svg" alt="مخطط تشريحي لأعضاء الإنسان (ويكيميديا كومنز)" class="w-full border rounded-md"/>
                            <p class="text-xs text-gray-500 mt-1 text-center">المصدر: <a href="https://commons.wikimedia.org/wiki/File:Internal_organs.svg" target="_blank" rel="noopener" class="underline">Wikimedia Commons</a> — ملكية عامة</p>
                        </div>
                    </div>

                    <!-- 3D Body Model Container (hidden by default; enabled if model loads) -->
                    <div id="body-map-3d-container" class="md:col-span-1 w-full rounded-lg shadow-lg flex flex-col justify-center items-center p-4 hidden">
                        <model-viewer id="body-model-3d" src="assets/models/human_body.glb" ar camera-controls auto-rotate shadow-intensity="0.8" interaction-prompt="none" alt="نموذج ثلاثي الأبعاد للجسم البشري">
                            <!-- Hotspots (approximate positions; adjust after choosing final model) -->
                            <button class="hotspot-btn" slot="hotspot-brain" data-organ="brain" data-position="0m 1.55m 0.08m" data-normal="0 1 0">الدماغ</button>
                            <button class="hotspot-btn" slot="hotspot-thyroid" data-organ="thyroid" data-position="0m 1.42m 0.12m" data-normal="0 1 0">الدرقية</button>
                            <button class="hotspot-btn" slot="hotspot-heart" data-organ="heart" data-position="0.02m 1.30m 0.12m" data-normal="0 1 0">القلب</button>
                            <button class="hotspot-btn" slot="hotspot-lungs" data-organ="lungs" data-position="0.02m 1.36m 0.12m" data-normal="0 1 0">الرئتان</button>
                            <button class="hotspot-btn" slot="hotspot-liver" data-organ="liver" data-position="0.06m 1.22m 0.10m" data-normal="0 1 0">الكبد</button>
                            <button class="hotspot-btn" slot="hotspot-stomach" data-organ="stomach" data-position="-0.05m 1.20m 0.10m" data-normal="0 1 0">المعدة</button>
                            <button class="hotspot-btn" slot="hotspot-pancreas" data-organ="pancreas" data-position="-0.02m 1.18m 0.10m" data-normal="0 1 0">البنكرياس</button>
                            <button class="hotspot-btn" slot="hotspot-spleen" data-organ="spleen" data-position="-0.08m 1.24m 0.10m" data-normal="0 1 0">الطحال</button>
                            <button class="hotspot-btn" slot="hotspot-kidneys" data-organ="kidneys" data-position="0.08m 1.14m -0.05m" data-normal="0 1 0">الكلى</button>
                            <button class="hotspot-btn" slot="hotspot-adrenals" data-organ="adrenals" data-position="0.06m 1.19m 0.02m" data-normal="0 1 0">كظرية</button>
                            <button class="hotspot-btn" slot="hotspot-gut" data-organ="gut" data-position="0m 1.05m 0.10m" data-normal="0 1 0">الأمعاء</button>
                            <button class="hotspot-btn" slot="hotspot-bladder" data-organ="bladder" data-position="0m 0.95m 0.10m" data-normal="0 1 0">المثانة</button>
                            <button class="hotspot-btn" slot="hotspot-reproductive" data-organ="reproductive" data-position="0m 0.90m 0.12m" data-normal="0 1 0">التناسلي</button>
                        </model-viewer>
                        <div id="body-map-3d-error" class="hidden mt-3 text-sm text-red-700 bg-red-50 border border-red-200 rounded-md p-2 text-center w-full">لم يتم العثور على نموذج ثلاثي الأبعاد للجسم. الرجاء وضع الملف <code>assets/models/human_body.glb</code> أو إبلاغنا لاستخدام نموذج افتراضي للاختبار.</div>
                    </div>

                    <!-- Info Panel -->
                    <div id="body-map-info-container" class="md:col-span-2">
                        <div id="body-map-info" class="bg-white p-8 rounded-xl shadow-lg opacity-0 transform translate-y-5 h-full">
                            <h3 id="organ-name" class="text-3xl font-bold mb-4 text-[--primary-color]">حدد عضواً للبدء</h3>
                            <div id="organ-details">
                                <p class="text-gray-600">انقر على رسم الجسم لاكتشاف المزيد.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Quizzes Section (NEW) -->
        <section id="view-quizzes" class="page-view py-20 bg-gray-50 hidden">
             <div class="container max-w-screen-lg mx-auto px-4 sm:px-6">
                 <div class="text-right mb-12">
                     <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="dashboard">
                         <i class="fas fa-arrow-right-long ml-2"></i>
                         الرجوع إلى لوحة التحكم
                     </button>
                 </div>
                <div class="text-center mb-12">
                    <h2 class="large-title text-4xl font-bold mb-4 section-title">التقييمات الصحية التفاعلية</h2>
                    <p class="max-w-3xl mx-auto text-lg">مجموعة اختبارات مهنية تم انتقاؤها بعناية لتقديم صورة فورية وموثوقة عن حالتك — نتائج تحفظ تلقائياً، قابلة للمشاركة والتحميل PDF. ليست تشخيصاً طبياً نهائياً، لكنها خطوة ذكية نحو قرار سريري أدق.</p>
                    <div class="mt-4 flex flex-wrap gap-2 justify-center">
                        <span class="badge badge-success"><i class="fa-solid fa-shield-heart ml-1"></i>موثّق</span>
                        <span class="badge badge-secondary"><i class="fa-solid fa-floppy-disk ml-1"></i>يحفظ النتائج</span>
                        <span class="badge badge-secondary"><i class="fa-solid fa-file-pdf ml-1"></i>تصدير PDF</span>
                        <span class="badge badge-secondary"><i class="fa-solid fa-share-nodes ml-1"></i>مشاركة سهلة</span>
                    </div>
                </div>
                <!-- Controls: Categories + Search -->
                <div class="mb-6 flex flex-col md:flex-row gap-3 items-stretch md:items-center justify-between">
                    <div id="quiz-cat-control" class="segmented-control" role="tablist" aria-label="تصنيفات التقييمات">
                        <button class="quiz-cat-btn tab-btn" data-cat="all" aria-selected="true">الكل</button>
                        <button class="quiz-cat-btn tab-btn" data-cat="mental" aria-selected="false">نفسي</button>
                        <button class="quiz-cat-btn tab-btn" data-cat="sleep" aria-selected="false">نوم</button>
                        <button class="quiz-cat-btn tab-btn" data-cat="metabolic" aria-selected="false">أيضي</button>
                        <button class="quiz-cat-btn tab-btn" data-cat="cardio" aria-selected="false">قلبي</button>
                        <button class="quiz-cat-btn tab-btn" data-cat="respiratory" aria-selected="false">تنفسي</button>
                        <button class="quiz-cat-btn tab-btn" data-cat="gastro" aria-selected="false">هضمي</button>
                        <button class="quiz-cat-btn tab-btn" data-cat="geriatrics" aria-selected="false">شيخوخة</button>
                        <button class="quiz-cat-btn tab-btn" data-cat="lifestyle" aria-selected="false">نمط حياة</button>
                    </div>
                    <div class="flex-1"><input id="quiz-search" type="text" class="w-full p-2 border rounded-md" placeholder="ابحث عن تقييم... مثل: السكري، الاكتئاب، النوم"></div>
                </div>
                <!-- Featured dynamically injected -->
                <div id="quizzes-featured" class="mb-8 grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                <!-- Quick links -->
                <div id="quiz-quick-links" class="mb-6 flex flex-wrap gap-2 justify-center">
                    <button class="quiz-quick-btn btn btn-secondary py-1.5 px-4 rounded-full" data-quiz="phq9">PHQ‑9 اكتئاب</button>
                    <button class="quiz-quick-btn btn btn-secondary py-1.5 px-4 rounded-full" data-quiz="gad7">GAD‑7 قلق</button>
                    <button class="quiz-quick-btn btn btn-secondary py-1.5 px-4 rounded-full" data-quiz="findrisc">FINDRISC سكري</button>
                    <button class="quiz-quick-btn btn btn-secondary py-1.5 px-4 rounded-full" data-quiz="stop-bang">STOP‑Bang نوم</button>
                    <button class="quiz-quick-btn btn btn-secondary py-1.5 px-4 rounded-full" data-quiz="cat">CAT COPD</button>
                </div>
                <!-- Dynamic grid -->
                <div id="quizzes-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                
                <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6 hidden" aria-hidden="true">
                    <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow">
                        <h3 class="text-2xl font-bold mb-3 text-[--primary-dark]">اختبار الإرهاق الكظري</h3>
                        <p class="text-gray-600 mb-4">هل تشعر بالتعب المستمر وصعوبة في التعامل مع الإجهاد؟ قد تكون غدتك الكظرية بحاجة إلى دعم.</p>
                        <button class="btn btn-primary text-white py-2 px-6 rounded-full quiz-start-btn" data-quiz="adrenal-fatigue">ابدأ الاختبار</button>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow">
                        <h3 class="text-2xl font-bold mb-3 text-[--primary-dark]">تقييم الأمعاء المتسربة</h3>
                        <p class="text-gray-600 mb-4">اكتشف ما إذا كانت مشاكل مثل الانتفاخ، الحساسية الغذائية، أو المشاكل الجلدية قد تكون مرتبطة بصحة أمعائك.</p>
                        <button class="btn btn-primary text-white py-2 px-6 rounded-full quiz-start-btn" data-quiz="leaky-gut">ابدأ الاختبار</button>
                    </div>
                     <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow">
                        <h3 class="text-2xl font-bold mb-3 text-[--primary-dark]">احسب درجة السمية في جسمك</h3>
                        <p class="text-gray-600 mb-4">قيّم تعرضك للسموم البيئية وقدرة جسمك على التخلص منها.</p>
                        <button class="btn btn-primary text-white py-2 px-6 rounded-full quiz-start-btn" data-quiz="toxicity-score">ابدأ الاختبار</button>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow">
                        <h3 class="text-2xl font-bold mb-3 text-[--primary-dark]">اختبار لوشير للألوان</h3>
                        <p class="text-gray-600 mb-4">اختر الألوان حسب تفضيلك للكشف عن جوانب من حالتك النفسية الحالية.</p>
                        <button class="btn btn-primary text-white py-2 px-6 rounded-full quiz-start-btn" data-quiz="luscher-color-test">ابدأ الاختبار</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Journal Section (NEW) -->
        <section id="view-journal" class="page-view py-20 bg-white hidden">
            <div class="container max-w-screen-lg mx-auto px-4 sm:px-6">
                <div id="journal-content-container">
                     <div class="text-right mb-12">
                         <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="dashboard">
                              <i class="fas fa-arrow-right-long ml-2"></i>
                              الرجوع إلى لوحة التحكم
                           </button>
                     </div>
                    <div class="text-center mb-12">
                        <h2 class="text-4xl font-bold mb-4 section-title">مفكرة الأعراض والمزاج</h2>
                        <p class="max-w-3xl mx-auto text-lg">أداة قوية لتصبح محققاً في رحلتك الصحية. سجّل تتبعك اليومي هنا لاكتشاف الروابط بين نمط حياتك وما تشعر به.</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <!-- New Entry Form -->
                        <div class="md:col-span-1 bg-gray-50 p-6 rounded-xl shadow-lg">
                            <h3 class="text-2xl font-bold mb-4 text-center">إدخال اليوم</h3>
                            <form id="journal-form">
                                <div class="mb-4">
                                    <label for="entry-date">التاريخ</label>
                                    <input type="date" id="entry-date" class="w-full p-2 border rounded-md" required>
                                </div>
                                <div class="mb-4">
                                    <label for="mood-rating">المزاج (1=سيء, 10=ممتاز)</label>
                                    <input type="range" id="mood-rating" min="1" max="10" value="5" class="w-full">
                                </div>
                                 <div class="mb-4">
                                    <label for="energy-rating">الطاقة (1=منهك, 10=حيوي)</label>
                                    <input type="range" id="energy-rating" min="1" max="10" value="5" class="w-full">
                                </div>
                                 <div class="mb-4">
                                    <label for="sleep-quality">جودة النوم (ساعات)</label>
                                    <input type="number" id="sleep-quality" min="0" max="12" step="0.5" class="w-full p-2 border rounded-md" placeholder="e.g., 7.5">
                                </div>
                                 <div class="mb-4">
                                    <label for="symptoms-today">الأعراض اليوم</label>
                                    <textarea id="symptoms-today" rows="3" class="w-full p-2 border rounded-md" placeholder="صداع، انتفاخ، ألم مفاصل..."></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary text-white w-full py-3 rounded-full">حفظ الإدخال</button>
                            </form>
                        </div>
                        <!-- Entries & Charts -->
                        <div class="md:col-span-2">
                             <h3 class="text-2xl font-bold mb-4 text-center">تحليل الأنماط</h3>
                             <div class="bg-gray-50 p-6 rounded-xl shadow-lg mb-6">
                                 <canvas id="journal-chart"></canvas>
                             </div>
                             <h3 class="text-2xl font-bold mb-4 text-center">سجل إدخالاتي</h3>
                             <div id="journal-entries-container" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                                 <!-- Entries will be loaded here -->
                             </div>
                        </div>
                    </div>
                </div>

                 <div id="journal-login-prompt" class="hidden text-center py-16">
                     <div class="bg-white max-w-2xl mx-auto p-8 rounded-xl shadow-lg">
                         <i class="fas fa-lock text-5xl text-[--accent-color] mb-4"></i>
                         <h3 class="text-2xl font-bold mb-3">هذه الميزة حصرية للأعضاء</h3>
                         <p class="text-gray-600 mb-6">يرجى تسجيل الدخول للوصول إلى مفكرة الأعراض والمزاج الخاصة بك وحفظ تقدمك.</p>
                         <button id="login-for-journal-btn" class="btn btn-primary text-white py-2 px-8 rounded-full">تسجيل الدخول</button>
                     </div>
                 </div>
            </div>
        </section>
        
        <!-- Premium Content / Patient File Section -->
        <section id="view-premium-content" class="page-view py-20 hidden">
            <div class="container max-w-screen-lg mx-auto px-4 sm:px-6 text-center">
                 <div class="text-right mb-12">
                     <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="dashboard">
                         <i class="fas fa-arrow-right-long ml-2"></i>
                         الرجوع إلى لوحة التحكم
                     </button>
                 </div>
                <h2 id="welcome-message" class="text-4xl font-bold mb-4 section-title">مرحباً بك في أسرتنا</h2>
                <p class="max-w-2xl mx-auto mb-12">هذه مساحتك الحصرية. هنا ستجد المحتوى الخاص وجميع نتائجك المحفوظة من أدواتنا الذكية.</p>
                <div id="patient-file-content" class="bg-white p-8 rounded-xl shadow-inner max-w-4xl mx-auto text-right">
                    <h3 class="text-2xl font-bold mb-6">سجلاتي المحفوظة</h3>
                    <div id="saved-results-container" class="space-y-6">
                        <p>الرجاء تسجيل الدخول لعرض سجلاتك المحفوظة.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Blog Section -->
        <section id="view-blog" class="page-view py-20 bg-gray-50 hidden">
             <div class="container max-w-screen-lg mx-auto px-4 sm:px-6 text-center">
                 <div class="text-right mb-12">
                     <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="dashboard">
                         <i class="fas fa-arrow-right-long ml-2"></i>
                         الرجوع إلى لوحة التحكم
                     </button>
                 </div>
                <h2 class="large-title text-4xl font-bold mb-4 section-title">من وحي المدونة</h2>
                <p class="max-w-2xl mx-auto mb-12">مقالات ورؤى لمساعدتك على فهم جسدك بشكل أفضل واتخاذ قرارات صحية مستنيرة.</p>
                <div id="featured-post" class="relative rounded-2xl overflow-hidden mb-8 shadow-lg hidden" aria-labelledby="featured-title">
                    <img id="featured-image" src="" alt="مقال مميز" class="w-full h-72 md:h-96 object-cover" loading="lazy" decoding="async">
                    <div class="absolute inset-0 bg-black/40"></div>
                    <div class="absolute inset-0 flex items-end p-6">
                        <div class="text-white text-right max-w-3xl ml-auto">
                            <p id="featured-cat" class="text-xs opacity-90 mb-1"></p>
                            <h3 id="featured-title" class="text-2xl md:text-3xl font-bold mb-2"></h3>
                            <p id="featured-excerpt" class="text-sm md:text-base opacity-95 mb-3"></p>
                            <a href="#" id="featured-read" class="read-more-btn btn btn-primary text-white rounded-full px-4 py-2 inline-block" data-postid="">اقرأ الآن</a>
                        </div>
                    </div>
                </div>
                <div class="mb-6 flex flex-col md:flex-row items-stretch md:items-center gap-3">
                    <div class="segmented-control" role="tablist" aria-label="تصنيفات المدونة">
                        <button class="blog-cat-btn btn btn-outline px-3 py-1 rounded-full" data-cat="all" aria-selected="true" id="blog-cat-all">الكل</button>
                        <button class="blog-cat-btn btn btn-outline px-3 py-1 rounded-full" data-cat="nutrition" aria-selected="false">تغذية</button>
                        <button class="blog-cat-btn btn btn-outline px-3 py-1 rounded-full" data-cat="mind" aria-selected="false">تنفس وذهن</button>
                        <button class="blog-cat-btn btn btn-outline px-3 py-1 rounded-full" data-cat="supplements" aria-selected="false">مكملات</button>
                    </div>
                    <div class="flex-1">
                        <input id="blog-search" type="text" class="w-full p-2 border rounded-md" aria-label="ابحث في المدونة" placeholder="ابحث في المقالات...">
                    </div>
                </div>
                <div id="blog-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 text-right"></div>
            </div>
        </section>

        <!-- Single Post View -->
        <section id="view-single-post" class="page-view py-20 bg-white hidden">
            <div class="container max-w-screen-lg mx-auto px-4 sm:px-6 max-w-4xl">
                 <div class="text-right mb-12">
                     <button class="nav-link font-bold text-[--primary-color] hover:text-[--accent-color] transition-colors" data-view="blog">
                         <i class="fas fa-arrow-right-long ml-2"></i>
                         الرجوع إلى المدونة
                     </button>
                 </div>
                 <article>
                     <h1 id="post-title" class="text-4xl md:text-5xl font-bold mb-4 text-center section-title"></h1>
                     <div id="post-meta" class="text-sm text-gray-500 flex flex-wrap gap-3 justify-end mb-2"></div>
                     <img id="post-image" src="" alt="صورة المقال" class="w-full h-96 object-cover rounded-xl shadow-lg my-8">
                     <div id="post-content" class="prose lg:prose-xl max-w-none text-right"></div>
                     <div class="mt-6 flex flex-wrap gap-3 justify-end" id="post-share">
                         <span class="text-sm text-gray-600">شارك:</span>
                         <a id="share-whatsapp" href="#" target="_blank" class="btn btn-outline rounded-full px-3 py-1 text-sm" rel="noopener">واتساب</a>
                         <a id="share-facebook" href="#" target="_blank" class="btn btn-outline rounded-full px-3 py-1 text-sm" rel="noopener">فيسبوك</a>
                         <a id="share-x" href="#" target="_blank" class="btn btn-outline rounded-full px-3 py-1 text-sm" rel="noopener">X</a>
                     </div>
                     <div class="mt-8 bg-secondary-color/30 rounded-xl p-4 text-right">
                         <h3 class="font-bold mb-2">هل تحتاج رأياً طبياً ثانياً؟</h3>
                         <a href="#" class="nav-link btn btn-secondary rounded-full px-4 py-2" data-view="second-opinion">أرسل تقريرك الآن</a>
                     </div>
                     <div class="mt-3 bg-secondary-color/20 rounded-xl p-4 text-right">
                         <h3 class="font-bold mb-2">تبحث عن تنسيق سفر طبي موثوق؟</h3>
                         <a href="#" class="nav-link btn btn-outline rounded-full px-4 py-2" data-view="medical-travel">ابدأ التنسيق</a>
                     </div>
                     <div class="mt-8 text-right">
                         <h3 class="text-2xl font-bold mb-3">مقالات ذات صلة</h3>
                         <div id="related-posts" class="grid sm:grid-cols-2 gap-4"></div>
                     </div>
                 </article>
            </div>
        </section>
        
        <!-- FAQ Section (NEW) -->
        <section class="py-20 bg-secondary-color">
            <div class="container mx-auto px-6">
                <h2 class="text-4xl font-bold mb-12 text-center section-title">أسئلة شائعة</h2>
                <div class="max-w-4xl mx-auto faq-section">
                    <details>
                        <summary>متى يُنصح باستخدام أداة التشخيص الآلي؟</summary>
                        <p class="mt-4 text-gray-700">أداة التشخيص الآلي مصممة لتكون نقطة بداية استكشافية عندما تشعر بأعراض غير واضحة أو متعددة. إنها تساعد في ربط الأعراض الجسدية بالمشاعر ونمط الحياة لتقديم رؤية شمولية محتملة، ولكنها لا تغني أبداً عن استشارة طبية متخصصة لتأكيد التشخيص.</p>
                    </details>
                    <details>
                        <summary>ما الفرق بين "خطة علاجية" و"تشخيص"؟</summary>
                        <p class="mt-4 text-gray-700">التشخيص يهدف إلى تحديد "ماذا" يحدث في جسمك بناءً على الأعراض التي تقدمها. أما الخطة العلاجية فتهدف إلى تحديد "كيف" يمكن معالجة هذا التشخيص أو مجموعة الأعراض من خلال اقتراح بروتوكول علاجي يتضمن تغذية، مكملات، ونصائح حياتية. يمكنك استخدام نتيجة التشخيص كمدخل لطلب خطة علاجية.</p>
                    </details>
                     <details>
                        <summary>هل "خريطة الجسد الشعوري" علمية؟</summary>
                        <p class="mt-4 text-gray-700">خريطة الجسد الشعوري مبنية على مبادئ الطب الشعوري والطب الألماني الحديث (GNM)، وهي مدارس ترى أن لكل مرض جسدي جذر أو صدمة شعورية مرتبطة به. بينما لا تزال هذه الأفكار في طور البحث في الأوساط العلمية التقليدية، فإنها تقدم منظوراً قوياً للشفاء الذاتي وفهم أعمق لرسائل أجسادنا.</p>
                    </details>
                    <details>
                        <summary>هل يمكنني الاعتماد على بروتوكول الشعر فقط؟</summary>
                        <p class="mt-4 text-gray-700">البروتوكول المقدم هو مجموعة من أفضل الممارسات الشمولية التي أثبتت فعاليتها للكثيرين. ومع ذلك، تختلف الاستجابة من شخص لآخر. للحصول على أفضل النتائج، يُفضل دمج البروتوكول مع نظام غذائي صحي، إدارة للتوتر، ونوم كافٍ. هو جزء من منظومة متكاملة وليس حلاً سحرياً منفرداً.</p>
                    </details>
                </div>
            </div>
        </section>

    </main>
    
    <!-- Mobile Bottom Tab Bar (Primary Services) -->
    <nav id="bottom-tabbar" class="fixed bottom-0 inset-x-0 md:hidden z-50" role="navigation" aria-label="الخدمات الأساسية">
        <div class="max-w-screen-lg mx-auto flex">
            <a href="#" class="tab-item nav-link" data-view="medical-travel" aria-label="السفر الطبي" aria-current="false">
                <i class="fa-solid fa-plane"></i>
                <span class="label">السفر الطبي</span>
                <span class="dot" aria-hidden="true"></span>
            </a>
            <a href="#" class="tab-item nav-link" data-view="second-opinion" aria-label="الرأي الطبي الثاني" aria-current="false">
                <i class="fa-solid fa-file-medical"></i>
                <span class="label">الرأي الطبي الثاني</span>
                <span class="dot" aria-hidden="true"></span>
            </a>
            <a href="#" class="tab-item nav-link" data-view="chronic-care" aria-label="الأمراض المزمنة" aria-current="false">
                <i class="fa-solid fa-heart-pulse"></i>
                <span class="label">الأمراض المزمنة</span>
                <span class="dot" aria-hidden="true"></span>
            </a>
        </div>
    </nav>

    <!-- Footer -->
    <footer id="contact" class="bg-gray-800 text-white pt-20 pb-8" role="contentinfo">
        <div class="container max-w-screen-lg mx-auto px-4 sm:px-6 text-center">
            <h2 class="text-3xl font-bold mb-4">هل أنت مستعد لبدء رحلة الشفاء؟</h2>
            <p class="max-w-xl mx-auto mb-8">تواصل معي اليوم عبر واتساب لحجز استشارتك الأولى، أو تابعني على وسائل التواصل الاجتماعي لمحتوى يومي ملهم.</p>
            <a href="https://wa.me/967771447111?text=أهلاً%20د.%20عمر،%20أرغب%20في%20الاستفسار%20عن%20جلسات%20العلاج%20الشمولي" target="_blank" class="btn btn-primary text-white text-xl py-3 px-8 rounded-full inline-block mb-12"><i class="fab fa-whatsapp"></i> تواصل معي عبر واتساب</a>
            
            <div class="flex justify-center space-x-6 text-3xl mb-8">
                <a href="https://www.instagram.com/dr.omr369" target="_blank" class="hover:text-[--accent-color] transition"><i class="fab fa-instagram"></i></a>
                <a href="https://www.facebook.com/dr.omr369" target="_blank" class="hover:text-[--accent-color] transition"><i class="fab fa-facebook-f"></i></a>
                <a href="https://www.tiktok.com/@dr.omr369" target="_blank" class="hover:text-[--accent-color] transition"><i class="fab fa-tiktok"></i></a>
            </div>

            <!-- Credibility & References -->
            <div class="text-right bg-gray-900/40 rounded-lg p-4 mb-6">
                <h3 class="text-xl font-bold mb-2">بيانات الاعتماد والموثوقية</h3>
                <ul class="list-disc pr-6 text-sm text-gray-200">
                    <li>المؤهلات: [الدرجة العلمية]، [الجامعة]، [السنة].</li>
                    <li>الترخيص المهني: [الجهة المرخصة] – رقم: [XXXX].</li>
                    <li>عضويات مهنية: [الجمعية/الهيئة الطبية].</li>
                </ul>
                <p class="text-xs text-gray-300 mt-2">المحتوى تعليمي عام ويعتمد على مصادر طبية مُراجعة وممارسات تكاملية قيد البحث. يُرجى مراجعة طبيبك قبل أي قرار علاجي. لمراجعة مبادئ الشفافية ومعرفة الجهة المُشغِّلة والغرض من الموقع راجع MedlinePlus: medlineplus.gov.</p>
            </div>

            <div class="border-t border-gray-700 pt-6">
                 <p>&copy; 2025 د. عمر العماد | جميع الحقوق محفوظة.</p>
            </div>
        </div>
    </footer>

    <!-- Back to Top Button -->
    <button id="back-to-top-btn" class="hidden fixed md:bottom-5 bottom-24 right-5 bg-[--primary-color] text-white w-12 h-12 rounded-full shadow-lg flex items-center justify-center text-2xl transition-opacity duration-300 hover:bg-[--primary-dark]">
        <i class="fas fa-arrow-up"></i>
    </button>

    <!-- WhatsApp Floating Button -->
    <a href="https://wa.me/967771447111" class="whatsapp-float" target="_blank" aria-label="تواصل معنا عبر واتساب">
        <i class="fab fa-whatsapp"></i>
    </a>

    <!-- Accessibility Controls -->
    <div class="a11y-toggle">
        <button id="a11y-open-btn" aria-expanded="false" aria-controls="a11y-panel" class="btn btn-secondary rounded-full px-4 py-2 text-sm">
            <i class="fa-solid fa-universal-access"></i> خيارات الوصول
        </button>
    </div>
    <div id="a11y-panel" class="hidden fixed bottom-24 left-5 bg-white rounded-xl shadow-2xl border p-4 z-[120] w-[320px] max-w-[calc(100vw-2rem)]" role="dialog" aria-labelledby="a11y-title" aria-modal="false" tabindex="-1">
        <div class="flex items-center justify-between mb-2">
            <h3 id="a11y-title" class="font-bold text-right">خيارات الوصول</h3>
            <button id="a11y-close-btn" class="btn btn-outline rounded-full px-3 py-1 text-sm" aria-label="إغلاق">×</button>
        </div>
        <div class="option-row">
            <label class="inset-label">حجم الخط</label>
            <div class="flex items-center gap-2">
                <button id="font-dec-btn" class="btn btn-secondary rounded-full px-3 py-1" aria-label="تصغير الخط">−</button>
                <span id="font-scale-label" class="text-sm">100%</span>
                <button id="font-inc-btn" class="btn btn-secondary rounded-full px-3 py-1" aria-label="تكبير الخط">+</button>
            </div>
        </div>
        <div class="option-row">
            <label class="inset-label" for="hc-toggle">تباين عالٍ</label>
            <input id="hc-toggle" type="checkbox" class="w-5 h-5" />
        </div>
        <div class="option-row">
            <label class="inset-label" for="dys-toggle">خط سهل القراءة</label>
            <input id="dys-toggle" type="checkbox" class="w-5 h-5" />
        </div>
        <p class="a11y-shortcut-hint">اختصار: Alt+Shift+A لفتح/إغلاق.</p>
    </div>

    <!-- Modals -->
    <div id="tool-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-4 opacity-0" role="dialog" aria-modal="true" aria-labelledby="tool-modal-title">
        <div id="modal-content" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto transform scale-95 transition-transform duration-300" tabindex="-1"></div>
    </div>
    
    <div id="quiz-modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-[100] p-4 opacity-0">
        <div id="quiz-modal-content" class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto transform scale-95 transition-transform duration-300"></div>
    </div>


    <div id="hair-protocol-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[110] p-4">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto relative text-right">
            <button class="absolute top-4 left-4 text-2xl text-gray-500 hover:text-gray-800" onclick="closeModal('hair-protocol-modal')">&times;</button>
            <h3 class="text-2xl font-bold mb-4 text-center text-[--primary-color]">البروتوكول الشمولي لعلاج الشعر</h3>
            <div class="text-right space-y-4">
                <p class="text-center text-gray-600 mb-4">بروتوكول علاجي شامل لتأخير الشيب وتحفيز تصبغ الشعر وتقليل التساقط.</p>
                
                <div class="p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-bold text-lg mb-2 text-[--primary-dark]">الجزء 1: الزيوت العلاجية الموضعية (2-3 مرات أسبوعياً)</h4>
                    <p><strong>التركيبة:</strong></p>
                    <ul class="list-disc list-inside pr-4">
                        <li>زيت إكليل الجبل: 10 مل</li>
                        <li>زيت النعناع: 5 مل</li>
                        <li>زيت الليمون: 5 مل</li>
                        <li>زيت السمسم (كزيت حامل): 30 مل</li>
                        <li>زيت الخروع (اختياري للتكثيف): 10 مل</li>
                        <li>كيروسين طبي أو بارافين طبي: 5 مل</li>
                    </ul>
                    <p class="mt-2"><strong>طريقة الاستخدام:</strong> امزج المكونات، دفئها قليلاً، دلك فروة الرأس لـ 5-10 دقائق، واتركها لساعتين على الأقل قبل غسلها بشامبو طبيعي.</p>
                </div>

                <div class="p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-bold text-lg mb-2 text-[--primary-dark]">الجزء 2: مكملات غذائية يومية</h4>
                     <ul class="list-disc list-inside pr-4">
                        <li><strong>صباحًا بعد الفطور:</strong> Zinc (30-50 ملغ) مع Vitamin C (Liposomal) (500-1000 ملغ)</li>
                        <li><strong>بعد ساعتين من الزنك:</strong> Copper (2-3 ملغ)</li>
                        <li><strong>صباحًا أو مساءً:</strong> Fo-Ti (كبسولة 500-1000 ملغ) - <span class="text-red-500 font-bold">ينصح بعمل تحليل وظائف كبد.</span></li>
                    </ul>
                </div>
                
                <div class="p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-bold text-lg mb-2 text-[--primary-dark]">الجزء 3: قناع الشعر الطبيعي (مرة أسبوعياً)</h4>
                    <p><strong>التركيبة:</strong> ملعقة كبيرة سدر بودرة، ملعقة صغيرة عكبر نحل، نصف ملعقة صغيرة بذور الخلة المطحونة، 2 ملعقة كبيرة خل تفاح طبيعي، وماء دافئ للعجن.</p>
                    <p class="mt-2"><strong>طريقة الاستخدام:</strong> يوضع على الفروة والشعر لمدة 30-60 دقيقة ثم يغسل جيداً.</p>
                </div>

                <div class="p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-bold text-lg mb-2 text-[--primary-dark]">الجزء 4: مادة ORMUS</h4>
                    <p><strong>الجرعة:</strong> ملعقة صغيرة يومياً صباحاً على معدة فارغة من مصدر موثوق.</p>
                    <p><strong>الفوائد:</strong> يزيد التركيز، يوازن الطاقات، ويحفز تجدد الخلايا الصبغية.</p>
                    <p class="text-red-500 font-bold mt-2">تحذير: لا تستخدم ORMUS مع أدوية نفسية أو مناعية دون استشارة طبيب.</p>
                </div>

                <div class="p-4 bg-green-50 rounded-lg border-r-4 border-green-500">
                    <h4 class="font-bold text-lg mb-2 text-green-800">نصائح عامة داعمة</h4>
                    <ul class="list-disc list-inside pr-4">
                        <li>اتبع نظامًا غذائيًا غنيًا بفيتامينات B12، حمض الفوليك، والسيليكا.</li>
                        <li>خفف التوتر، لأن الإجهاد يزيد من الشيب.</li>
                        <li>تجنب الصبغات الكيميائية القوية أثناء البروتوكول.</li>
                        <li>أكثر من شرب العصائر الخضراء.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- START Hemorrhoid Protocol Modal -->
    <div id="hemorrhoid-protocol-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-[110] p-4">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto relative text-right">
            <button class="absolute top-4 left-4 text-2xl text-gray-500 hover:text-gray-800" onclick="closeModal('hemorrhoid-protocol-modal')">&times;</button>
            <h3 class="text-2xl font-bold mb-4 text-center text-[--primary-color]">🌿 بروتوكول طِبرة العميق لعلاج البواسير – Ṭibrah Hemorrhoid Healing Protocol</h3>
            <div class="text-right space-y-4">
                <p class="italic bg-yellow-50 p-4 rounded-lg border-r-4 border-yellow-400 leading-relaxed">هذا البروتوكول صُمّم ليكون شاملًا، يغطي جوانب مختلفة من علاج البواسير — من الأدوية الحديثة، إلى الأعشاب، إلى المكملات، إلى العلاج الطاقي والروحي.<br><br>لكن الحقيقة البسيطة هي:<br><strong>لستَ بحاجة أن تطبّق كل شيء دفعة واحدة.</strong><br><br><em>ابدأ بما يناسبك، بما ترتاح له، بما تستطيع فعله اليوم.</em> قد تختار أن تبدأ بالمغطس فقط، أو بالكريم الطبيعي، أو بالمكملات… وكلها أبواب صادقة نحو الشفاء.<br><br><strong>استمع إلى جسدك، وثق بأن كل خطوة صغيرة، إن وُضعت بنيّة، تُحدث فرقًا.</strong><br>🌱 الشفاء ليس سباقًا… بل عودة هادئة إلى ذاتك.</p>

                <div class="p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-bold text-lg mb-2 text-[--primary-dark]">🎯 الخطوة 1 | العلاجات التقليدية الحديثة (Conventional Medicine)</h4><ol class="list-decimal list-inside pr-4 space-y-1"><li><strong>أقراص دافلون (Daflon 1000mg)</strong> – قرص واحد يومياً، لتحسين الدورة الوريدية وتخفيف الاحتقان.</li><li><strong>مرهم نيوهيلار (Neo-Healar)</strong> – مرتين يومياً، يقلل الالتهاب والتورم.</li><li><strong>تحاميل بروكتوجليفينول (Procto-Glyvenol)</strong> – تحميلة مساءً لتسكين الألم الداخلي والتورم.</li><li><strong>تقنيات غير جراحية (للحالات المتقدمة):</strong><ul class="list-disc list-inside pr-6"><li>ربط بالشريط المطاطي</li><li>الليزر (Hemorrhoidoplasty)</li><li>الترددات الراديوية (RFA)</li></ul><span class="text-sm text-red-600">تُجرى جميعها تحت إشراف طبي مختص.</span></li></ol></div><!-- الخطوة 2 --><div class="p-4 bg-gray-50 rounded-lg"><h4 class="font-bold text-lg mb-2 text-[--primary-dark]">🍀 الخطوة 2 | العلاج بالأعشاب الطبية (Herbal Medicine)</h4><p class="mb-2">شاي أو كبسولات مرتين يومياً حسب التوفر:</p><ul class="list-disc list-inside pr-4 space-y-1"><li><strong>Witch Hazel bark:</strong> قابض للأوعية، يوقف النزيف.</li><li><strong>Catnip:</strong> يريح عضلات الأمعاء ويقلل التشنجات.</li><li><strong>Yellow Dock:</strong> يعالج الإمساك ويحسّن الهضم.</li><li><strong>White Oak Bark:</strong> قابض للأنسجة ويسرّع الشفاء.</li></ul><p class="mt-3 font-semibold">خلطة الأعشاب (مرتين يومياً):</p><ul class="list-disc list-inside pr-4 space-y-1"><li>Bayberry</li><li>Alum Root</li><li>Mullein</li><li>Pilewort</li><li>Yarrow</li></ul><p class="mt-2 text-sm text-gray-700">تُسرّع شفاء النزيف والالتهاب.</p><p class="mt-3"><strong>Bloodroot (جذر الدم):</strong> منشط مناعي قوي – 10 قطرات في كوب ماء يومياً لمدة أسبوعين فقط، وتحت إشراف مختص.</p></div><!-- الخطوة 3 --><div class="p-4 bg-gray-50 rounded-lg"><h4 class="font-bold text-lg mb-2 text-[--primary-dark]">🌿 الخطوة 3 | مكملات الأورثوموليكيولر (Orthomolecular Supplements)</h4><p class="mb-2">لمدة 4–8 أسابيع:</p><ul class="list-disc list-inside pr-4 space-y-1"><li>فيتامين C – 1000mg مرتين يومياً</li><li>روتين – Rutin 500mg مرتين</li><li>فيتامين E (Tocotrienols) – 400 IU يومياً</li><li>Zinc Bisglycinate – 25mg يومياً</li><li>Horse Chestnut – 250mg مرتين</li><li>Grape Seed Extract – 200mg مرتين</li><li>Liquid Chlorophyll – 10ml مرتين</li><li>Bromelain – 500mg مرتين على معدة فارغة</li></ul></div><!-- الخطوة 4 --><div class="p-4 bg-gray-50 rounded-lg"><h4 class="font-bold text-lg mb-2 text-[--primary-dark]">🧴 الخطوة 4 | العلاجات الموضعية غير التقليدية (Topical Alternative)</h4><ol class="list-decimal list-inside pr-4 space-y-2"><li><strong>كريم طِبرة بالكيروسين للبواسير:</strong><ul class="list-disc list-inside pr-4"><li>10ml كيروسين طبي نقي</li><li>10ml زيت خروع</li><li>10ml زيت جوز هند</li><li>3 قطرات Tea Tree Oil</li><li>3 قطرات Lavender Oil</li></ul><span class="text-sm">يُستخدم مرتين يومياً.</span></li><li><strong>مرهم DMSO العميق:</strong><ul class="list-disc list-inside pr-4"><li>70% DMSO</li><li>30% جل ألوفيرا</li><li>500mg كركمين لكل 50ml</li></ul><span class="text-sm">يُستخدم مرة مساءً.</span></li><li><strong>كمادات Witch Hazel وWhite Oak:</strong> 15 دقيقة يومياً بمغلي مبرد.</li></ol></div><!-- الخطوة 5 --><div class="p-4 bg-gray-50 rounded-lg"><h4 class="font-bold text-lg mb-2 text-[--primary-dark]">💧 الخطوة 5 | المغطس العلاجي (Sitz Bath)</h4><ul class="list-disc list-inside pr-4"><li>10ml كيروسين طبي</li><li>10ml زيت النيم</li><li>5 قطرات Tea Tree Oil</li><li>5 قطرات Cypress Oil</li></ul><p class="mt-2 text-sm">يُستخدم يومياً 15–20 دقيقة.</p></div><!-- الخطوة 6 --><div class="p-4 bg-gray-50 rounded-lg"><h4 class="font-bold text-lg mb-2 text-[--primary-dark]">🍏 الخطوة 6 | التغذية العلاجية الواعية</h4><ul class="list-disc list-inside pr-4"><li>ألياف نباتية (سيليوم، شيا، كتان)</li><li>3 لتر ماء يومياً</li><li>تجنّب السكر، الألبان، القمح</li></ul></div><!-- الخطوة 7 --><div class="p-4 bg-gray-50 rounded-lg"><h4 class="font-bold text-lg mb-2 text-[--primary-dark]">🚶‍♂️ الخطوة 7 | نمط الحياة الواعي</h4><ul class="list-disc list-inside pr-4"><li>تمارين تنفس 10 دقائق</li><li>مشي 20 دقيقة</li><li>رفع الساقين أثناء النوم</li><li>تجنّب الجلوس الطويل</li></ul></div><!-- الخطوة 8 --><div class="p-4 bg-gray-50 rounded-lg"><h4 class="font-bold text-lg mb-2 text-[--primary-dark]">🌀 الخطوة 8 | معالجة الجذر الشعوري والطاقي</h4><ul class="list-disc list-inside pr-4"><li><strong>تأمل تفريغ الحوض – Pelvic Release Meditation</strong></li><li><strong>رسالة للقولون:</strong> "أنا آسف لأنني كتمت..."</li></ul><p class="mt-2 text-sm">الشفاء أحيانًا في إطلاق الحزن، لا فقط البراز.</p></div><!-- نصائح --><div class="p-4 bg-green-50 rounded-lg border-r-4 border-green-500"><h4 class="font-bold text-lg mb-2 text-green-800">⚡ نصائح هامة</h4><ul class="list-disc list-inside pr-4"><li>DMSO قوي الاختراق، نظّف المنطقة جيدًا قبل استخدامه.</li><li>Bloodroot لا يُستخدم إلا بإشراف مختص.</li><li>كريم طِبرة فعّال ويُستخدم مع العلاجات التقليدية.</li><li>دافلون علميًا مثبت.</li></ul></div><div class="p-4 bg-red-50 rounded-lg border-r-4 border-red-500"><h4 class="font-bold text-lg mb-2 text-red-800">🚨 تحذيرات</h4><ul class="list-disc list-inside pr-4"><li>لا تستخدم مواد غير موثوقة.</li><li>راقب التحسس من الكيروسين وDMSO.</li><li>استشر مختصًا عند استخدام Bloodroot.</li></ul></div><div class="p-4 bg-blue-50 rounded-lg border-r-4 border-blue-500"><h4 class="font-bold text-lg mb-2 text-blue-800">✅ الفوائد المتوقعة</h4><ul class="list-disc list-inside pr-4"><li>وقف سريع للنزيف</li><li>تقليل الألم والحرقان</li><li>شفاء عميق للبواسير الداخلية والخارجية</li><li>تحسين مناعة وصحة الهضم</li></ul></div><p class="text-center font-semibold text-[--primary-dark]">🌟 هذا بروتوكول علاجي شامل يجمع بين الطب التقليدي والحديث والعشبي والتكميلي – للوصول إلى شفاء جذري واعٍ.<br>بالشفاء التام بإذن الله. 🌿✨</p>

            </div>
        </div>
    </div>
    <!-- END Hemorrhoid Protocol Modal -->

    <!-- Notification Toast -->
    <div id="notification-toast" class="hidden fixed top-20 right-5 py-3 px-6 rounded-lg shadow-xl z-[150] transition-transform duration-500 translate-x-full">
        <p id="notification-message" class="text-white"></p>
    </div>
    
    <script>
  window.openModal = id => document.getElementById(id)?.classList.remove('hidden');
  window.closeModal = id => document.getElementById(id)?.classList.add('hidden');
</script>

<script type="module">
        // --- SDK IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, query, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // =========================================================================
        // !! ‫مفتاح API المحدث !!
        // =========================================================================
        const GEMINI_API_KEY = "AIzaSyCaev1GHwaZ7EqoxIyvRmgLehWs6Hq1gDw"; // <-- تم تحديث المفتاح هنا
        // =========================================================================

        // --- FIREBASE CONFIG ---
        const firebaseConfig = typeof __firebase_config !== 'undefined'
          ? JSON.parse(__firebase_config)
          : {
               apiKey: "AIzaSyBi2y64T-X1FNwbhv8ATQnF5xTZ3Pq4neg", // Fallback for local testing
               authDomain: "tibrasoul.firebaseapp.com",
               projectId: "tibrasoul",
               storageBucket: "tibrasoul.appspot.com",
               messagingSenderId: "920755760709",
               appId: "1:920755760709:web:778cd12e6edbd199827d2c"
            };
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- FIREBASE INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const storage = getStorage(app);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        
        // --- GLOBAL STATE ---
        let currentUser = null;
        let wheelChart;
        let journalChart; 

        // --- GLOBAL HELPERS (used by multiple modules incl. Blog) ---
        const catLabel = (c) => c === 'nutrition' ? 'تغذية' : c === 'mind' ? 'تنفس وذهن' : 'مكملات';
        const stripHtml = (html) => (html || '').replace(/<[^>]+>/g, ' ').replace(/\s+/g, ' ').trim();
        const readingTime = (html) => {
            const words = stripHtml(html).split(' ').filter(Boolean).length;
            const mins = Math.max(1, Math.round(words / 180));
            return `${mins} دقيقة قراءة`;
        };
        const cssVar = (name) => getComputedStyle(document.documentElement).getPropertyValue(name).trim();
        function hexToRgba(hex, alpha = 1) {
            try {
                if (!hex) return `rgba(0,0,0,${alpha})`;
                let c = hex.trim();
                if (c.startsWith('rgb')) return c; // already rgb/rgba
                if (c[0] === '#') c = c.substring(1);
                if (c.length === 3) c = c.split('').map(ch => ch + ch).join('');
                const num = parseInt(c, 16);
                const r = (num >> 16) & 255;
                const g = (num >> 8) & 255;
                const b = num & 255;
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            } catch { return `rgba(0,0,0,${alpha})`; }
        }

        // Re-apply palette on existing charts (for theme toggle)
        function refreshChartsTheme() {
            try {
                // Wheel of Life
                if (window.Chart && window.wheelChart) {
                    const ACCENT = cssVar('--accent-color') || '#2DD4BF';
                    const PRIMARY = cssVar('--primary-color') || '#1F6FEB';
                    const PRIMARY_DARK = cssVar('--primary-dark') || '#0F4CA8';
                    const TEXT = cssVar('--text-dark') || '#222';
                    const ds = window.wheelChart.data.datasets?.[0];
                    if (ds) {
                        ds.backgroundColor = hexToRgba(ACCENT, 0.35);
                        ds.borderColor = PRIMARY;
                        ds.pointBackgroundColor = PRIMARY;
                        ds.pointHoverBorderColor = PRIMARY;
                    }
                    if (window.wheelChart.options?.scales?.r) {
                        window.wheelChart.options.scales.r.angleLines.color = hexToRgba(PRIMARY_DARK, 0.25);
                        window.wheelChart.options.scales.r.grid.color = hexToRgba(PRIMARY_DARK, 0.25);
                        window.wheelChart.options.scales.r.pointLabels.color = TEXT;
                    }
                    window.wheelChart.update('none');
                }
                // Journal chart
                if (window.Chart && window.journalChart) {
                    const PRIMARY = cssVar('--primary-color') || '#1F6FEB';
                    const ACCENT = cssVar('--accent-color') || '#2DD4BF';
                    const ds0 = window.journalChart.data.datasets?.[0];
                    const ds1 = window.journalChart.data.datasets?.[1];
                    if (ds0) {
                        ds0.borderColor = PRIMARY;
                        ds0.backgroundColor = hexToRgba(PRIMARY, 0.2);
                    }
                    if (ds1) {
                        ds1.borderColor = ACCENT;
                        ds1.backgroundColor = hexToRgba(ACCENT, 0.2);
                    }
                    window.journalChart.update('none');
                }
            } catch {}
        }

        // --- APP INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const safe = (fn, name) => { try { typeof fn === 'function' && fn(); } catch (e) { console.error('Init error:', name, e); } };
            safe(initTheme, 'initTheme');
            safe(initAuth, 'initAuth');
            safe(initSmartTools, 'initSmartTools');
            safe(initFrequencyGenerator, 'initFrequencyGenerator');
            safe(initGeneralUI, 'initGeneralUI');
            safe(initAccessibility, 'initAccessibility');
            safe(initNavigation, 'initNavigation');
            safe(initCreativeEffects, 'initCreativeEffects');
            safe(initBlog, 'initBlog');
            safe(initWheelOfLife, 'initWheelOfLife');
            safe(initAudioPlayer, 'initAudioPlayer');
            safe(initBodyMap, 'initBodyMap'); 
            safe(initQuizzes, 'initQuizzes'); 
            safe(initJournal, 'initJournal'); 
            safe(initChronicCare, 'initChronicCare');
            safe(initMedicalTravel, 'initMedicalTravel');
            safe(initSecondOpinion, 'initSecondOpinion');
            // Prefer URL hash state if available
            const hashParams = parseHashParams();
            if (hashParams.view) {
                showView(hashParams.view);
                if (hashParams.view === 'chronic-care') {
                    const targetView = document.getElementById('view-chronic-care');
                    if (targetView) {
                        const tab = hashParams.tab || 'articles';
                        targetView.querySelector(`.tab-btn[data-tab="${tab}"]`)?.click();
                        if (hashParams.disease) {
                            targetView.querySelector(`#chronic-articles-nav [data-disease="${hashParams.disease}"]`)?.click();
                        }
                    }
                }
                if (hashParams.view === 'quizzes') {
                    // Apply category and open a quiz if provided
                    if (hashParams.cat) {
                        document.querySelector(`#quiz-cat-control .quiz-cat-btn[data-cat="${hashParams.cat}"]`)?.click();
                    }
                    if (hashParams.quiz) {
                        setTimeout(() => { try { window.__startQuiz?.(hashParams.quiz); } catch {} }, 80);
                    }
                }
            } else {
                showView('hero');
            }
            // React to manual hash changes
            window.addEventListener('hashchange', () => {
                const p = parseHashParams();
                if (p.view) {
                    showView(p.view);
                    if (p.view === 'chronic-care') {
                        const targetView = document.getElementById('view-chronic-care');
                        if (targetView) {
                            const tab = p.tab || 'articles';
                            targetView.querySelector(`.tab-btn[data-tab="${tab}"]`)?.click();
                            if (p.disease) {
                                targetView.querySelector(`#chronic-articles-nav [data-disease="${p.disease}"]`)?.click();
                            }
                        }
                    }
                    if (p.view === 'quizzes') {
                        if (p.cat) {
                            document.querySelector(`#quiz-cat-control .quiz-cat-btn[data-cat="${p.cat}"]`)?.click();
                        }
                        if (p.quiz) {
                            // Avoid double-start when hash was set inside startQuiz
                            if (window.__quizNavigating) { window.__quizNavigating = false; }
                            else setTimeout(() => { try { window.__startQuiz?.(p.quiz); } catch {} }, 80);
                        }
                    }
                }
            });
        });

        // --- URL HASH PARSER ---
        function parseHashParams() {
            const hash = (location.hash || '').replace(/^#/, '');
            const params = {};
            if (!hash) return params;
            hash.split('&').forEach(pair => {
                if (!pair) return;
                const [k, v] = pair.split('=');
                if (k) params[decodeURIComponent(k)] = decodeURIComponent(v || '');
            });
            return params;
        }

        // --- THEME TOGGLE (LIGHT/DARK) ---
        function initTheme() {
            const root = document.documentElement;
            const btn = document.getElementById('theme-toggle');
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            let mode = localStorage.getItem('theme') || (prefersDark ? 'dark' : 'light');
            const apply = (m) => {
                root.setAttribute('data-theme', m === 'dark' ? 'dark' : 'light');
                localStorage.setItem('theme', m);
                const icon = btn?.querySelector('i');
                if (icon) {
                    icon.classList.toggle('fa-moon', m !== 'dark');
                    icon.classList.toggle('fa-sun', m === 'dark');
                }
                // Update browser UI theme color for better integration
                try {
                    const meta = document.querySelector('meta[name="theme-color"]');
                    if (meta) meta.setAttribute('content', m === 'dark' ? '#0B1220' : '#F7FAFC');
                } catch {}
                try { refreshChartsTheme(); } catch {}
            };
            apply(mode);
            btn?.addEventListener('click', () => {
                mode = (localStorage.getItem('theme') || 'light') === 'dark' ? 'light' : 'dark';
                apply(mode);
            });
        }

        // --- DYNAMIC SCRIPT LOADER & LIB ENSURERS ---
        const loadedScripts = new Set();
        function loadScript(src, type = 'text/javascript') {
            return new Promise((resolve, reject) => {
                if (loadedScripts.has(src)) return resolve();
                const s = document.createElement('script');
                s.src = src;
                s.async = true;
                if (type) s.type = type;
                s.onload = () => { loadedScripts.add(src); resolve(); };
                s.onerror = () => reject(new Error('Failed to load ' + src));
                document.head.appendChild(s);
            });
        }
        async function ensureChart() {
            if (window.Chart) return;
            await loadScript('https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js');
        }
        async function ensureTone() {
            if (window.Tone) return;
            await loadScript('https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js');
        }

        // --- iOS-like NAV/UI HELPERS ---
        let currentViewId = 'hero';
        let activeLargeTitleEl = null;
        function updateBottomTabActive(viewId) {
            const items = document.querySelectorAll('#bottom-tabbar .tab-item');
            items.forEach(it => {
                const isActive = it.dataset.view === viewId;
                it.classList.toggle('active', isActive);
                it.setAttribute('aria-current', isActive ? 'page' : 'false');
            });
        }
        function updateTopNavActive(viewId) {
            document.querySelectorAll('header .nav-link[data-view]').forEach(link => {
                const active = link.dataset.view === viewId;
                link.classList.toggle('is-active', active);
                link.setAttribute('aria-current', active ? 'page' : 'false');
            });
        }
        // Highlight first missing field in inset-grouped forms
        function highlightFirstMissing(ids) {
            for (const id of ids) {
                const el = document.getElementById(id);
                if (!el) continue;
                const val = (el.value || '').toString().trim();
                if (!val) {
                    const cell = el.closest('.inset-cell');
                    if (cell) {
                        cell.classList.add('error');
                        setTimeout(() => cell.classList.remove('error'), 2500);
                    }
                    el.focus();
                    try { el.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch {}
                    break;
                }
            }
        }
        
        // Catalog rendering and interactivity
        if (featuredWrap && gridWrap) {
            const staticGrid = document.querySelector('#view-quizzes .max-w-4xl');
            function renderCatalog() {
                try {
                    const activeCatBtn = catControl?.querySelector('.quiz-cat-btn[aria-selected="true"]');
                    const cat = activeCatBtn?.dataset.cat || 'all';
                    const q = (searchInput?.value || '').trim();
                    const entries = Object.entries(quizzes).map(([id, data])=>({id, data})).filter(e=>{
                        const d = e.data;
                        const inCat = cat==='all' || (d.meta && d.meta.cat===cat);
                        const text = (d.title + ' ' + (d.meta?.description||'')).toLowerCase();
                        const okSearch = !q || text.includes(q.toLowerCase());
                        return inCat && okSearch;
                    });
                    const featured = entries.filter(e=>e.data.meta?.featured).slice(0,2);
                    const regular = entries.filter(e=>!e.data.meta?.featured);
                    const card = (e)=>{
                        const cat = e.data.meta?.cat || 'lifestyle';
                        const icon = catIcon[cat] || 'fa-clipboard-check';
                        const isCalc = (e.data.type === 'calculator');
                        const verified = Array.isArray(e.data.references) && e.data.references.length > 0;
                        return `<div class="bg-white p-6 rounded-lg shadow-md hover:shadow-xl transition-shadow transform transition-transform hover:-translate-y-1">
                            <div class="flex items-center justify-between mb-2">
                               <h3 class="text-2xl font-bold text-[--primary-dark]">${e.data.title}</h3>
                               <span class="text-[--primary-color]"><i class="fa-solid ${icon}"></i></span>
                            </div>
                            <div class="flex items-center gap-2 mb-3">
                               <span class="badge ${isCalc?'badge-secondary':'badge-primary'}">${isCalc?'حاسبة':'استبيان'}</span>
                               ${verified?'<span class="badge badge-success"><i class="fa-solid fa-shield-heart ml-1"></i>موثّق</span>':''}
                            </div>
                            <p class="text-gray-600 mb-3">${e.data.meta?.description||''}</p>
                            <button class="btn btn-primary text-white py-2 px-6 rounded-full quiz-start-btn" data-quiz="${e.id}">ابدأ التقييم</button>
                        </div>`;
                    };
                    // Always hide static fallback; render dynamic list (or an empty-state message)
                    staticGrid?.classList.add('hidden');
                    featuredWrap.innerHTML = featured.map(card).join('');
                    gridWrap.innerHTML = entries.length
                        ? regular.map(card).join('')
                        : `<div class="col-span-2 text-center text-gray-600">لا توجد نتائج مطابقة. جرّب تصنيفاً آخر أو عدّل عبارة البحث.</div>`;
                    bindStartButtons(featuredWrap);
                    bindStartButtons(gridWrap);
                } catch (err) {
                    console.error('renderCatalog error:', err);
                    // Fallback to static grid if dynamic fails
                    staticGrid?.classList.remove('hidden');
                }
            }
            catControl?.addEventListener('click', (ev)=>{
                const btn = ev.target.closest('.quiz-cat-btn');
                if (!btn) return;
                catControl.querySelectorAll('.quiz-cat-btn').forEach(b=>b.setAttribute('aria-selected','false'));
                btn.setAttribute('aria-selected','true');
                try { location.hash = `view=quizzes&cat=${encodeURIComponent(btn.dataset.cat || 'all')}`; } catch {}
                renderCatalog();
            });
            searchInput?.addEventListener('input', renderCatalog);
            
            // Enter to open top result
            searchInput?.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const first = gridWrap.querySelector('.quiz-start-btn') || featuredWrap.querySelector('.quiz-start-btn');
                    if (first) first.click();
                }
            });
            renderCatalog();
            // Expose re-render for view activation safety
            window.__renderQuizzes = renderCatalog;
        }
        function updateLargeTitleCompact() {
            if (!activeLargeTitleEl) return;
            const targetView = document.getElementById('view-' + currentViewId);
            if (!targetView) return;
            const sectionTop = targetView.offsetTop || 0;
            const scrolled = window.scrollY - sectionTop;
            const compact = scrolled > 60;
            activeLargeTitleEl.classList.toggle('compact', compact);
            const sub = document.getElementById('view-subheader');
            if (sub) {
                if (compact) {
                    const t = sub.querySelector('.title');
                    if (t) t.textContent = (activeLargeTitleEl.textContent || '').trim();
                    sub.style.display = 'block';
                } else {
                    sub.style.display = 'none';
                }
            }
        }
        // Reading progress for single post
        function updatePostProgress() {
            const bar = document.getElementById('post-progress');
            const inner = document.getElementById('post-progress-inner');
            const view = document.getElementById('view-single-post');
            if (!bar || !inner || !view) return;
            const isVisible = !view.classList.contains('hidden');
            bar.classList.toggle('hidden', !isVisible);
            if (!isVisible) return;
            const article = view.querySelector('article') || view;
            const start = (article.offsetTop || 0) - 100;
            const end = start + article.scrollHeight - window.innerHeight;
            const denom = Math.max(1, end - start);
            const p = Math.min(1, Math.max(0, (window.scrollY - start) / denom));
            inner.style.width = `${p * 100}%`;
        }
        window.addEventListener('scroll', updateLargeTitleCompact, { passive: true });
        window.addEventListener('scroll', updatePostProgress, { passive: true });

        // --- NAVIGATION MODULE ---
        function initNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const viewName = link.dataset.view;
                    if (viewName) {
                        document.getElementById('mobile-menu').classList.add('hidden');
                        // Update hash for deep-linking
                        location.hash = `view=${encodeURIComponent(viewName)}`;
                        showView(viewName);
                    }
                });
            });
        }

        function showView(viewId) {
             document.querySelectorAll('.page-view').forEach(view => {
                 view.classList.add('hidden');
             });
             const targetView = document.getElementById('view-' + viewId);
             if(targetView) {
                 // Update document title by view
                 const titles = {
                     'hero': 'الصفحة الرئيسية',
                     'dashboard': 'لوحة التحكم',
                     'chronic-care': 'مركز الأمراض المزمنة',
                     'medical-travel': 'السفر الطبي',
                     'second-opinion': 'الرأي الطبي الثاني',
                     'wheel-of-life': 'عجلة العافية',
                     'body-map': 'خريطة الجسد',
                     'quizzes': 'التقييمات الصحية',
                     'journal': 'مفكرة الأعراض',
                     'services': 'الجلسات',
                     'store': 'المتجر',
                     'about': 'عني',
                     'blog': 'المدونة',
                     'premium-content': 'ملف المريض',
                     'frequencies': 'الموجات'
                 };
                 document.title = `${titles[viewId] || 'ṬibraSoul'} | د. عمر العماد`;
                 // Special case: when showing hero, also show featured services section below it
                 if(viewId === 'hero') {
                     const feat = document.getElementById('featured-services');
                     if(feat) feat.classList.remove('hidden');
                 }
                 // Chronic Care: apply tab/disease from hash if present, else default to articles
                 if (viewId === 'chronic-care') {
                     const p = parseHashParams();
                     const tab = p.tab || 'articles';
                     targetView.querySelector(`.tab-btn[data-tab="${tab}"]`)?.click();
                     if (p.disease) {
                         targetView.querySelector(`#chronic-articles-nav [data-disease="${p.disease}"]`)?.click();
                     }
                 }
                 // Body Map: honor sex/mode/organ from URL hash on navigation
                 if (viewId === 'body-map') {
                     const p = parseHashParams();
                     if (window.BodyMap) {
                         if (p.sex) try { window.BodyMap.applySex(p.sex); } catch {}
                         if (p.mode) try { window.BodyMap.switchMode(p.mode); } catch {}
                         if (p.organ) try { window.BodyMap.selectOrgan(p.organ); } catch {}
                     }
                 }
                 // Quizzes: ensure dynamic catalog is rendered on navigation
                 if (viewId === 'quizzes') {
                     try { window.__renderQuizzes?.(); } catch {}
                 }
                 // Update bottom tab active state
                 updateBottomTabActive(viewId);
                 // Update top nav active state
                 updateTopNavActive(viewId);
                 // Large Title setup
                 currentViewId = viewId;
                 activeLargeTitleEl = targetView.querySelector('.large-title');
                 if (activeLargeTitleEl) {
                     activeLargeTitleEl.classList.remove('compact');
                     activeLargeTitleEl.setAttribute('tabindex', '-1');
                     setTimeout(() => {
                         updateLargeTitleCompact();
                         try { activeLargeTitleEl.focus({ preventScroll: true }); } catch { activeLargeTitleEl.focus(); }
                     }, 50);
                 }
                 targetView.classList.remove('hidden');
                 // Smoothly scroll to the revealed view so the user sees the change
                 targetView.scrollIntoView({behavior: 'smooth'});

                 const elementsToAnimate = targetView.querySelectorAll('.fade-in-up');
                 elementsToAnimate.forEach(el => el.classList.remove('is-visible'));
                 setTimeout(() => {
                     elementsToAnimate.forEach(el => {
                         el.classList.add('is-visible');
                     });
                 }, 100);
             }
        }

        // --- NOTIFICATION MODULE ---
        const notificationToast = document.getElementById('notification-toast');
        const notificationMessage = document.getElementById('notification-message');
        let notificationTimeout;
        function showNotification(message, type = 'error', duration = 4000) {
            if (notificationTimeout) clearTimeout(notificationTimeout);
            notificationMessage.textContent = message;
            notificationToast.className = 'fixed top-20 right-5 py-3 px-6 rounded-lg shadow-xl z-[150] transition-all duration-500 transform text-white';
            if (type === 'success') {
                notificationToast.classList.add('bg-green-500');
            } else if (type === 'warning') {
                notificationToast.classList.add('bg-yellow-500');
            } else {
                notificationToast.classList.add('bg-red-600');
            }
            notificationToast.classList.remove('hidden');
            notificationToast.classList.add('translate-x-full');
            setTimeout(() => {
                notificationToast.classList.remove('translate-x-full');
            }, 10);
            notificationTimeout = setTimeout(() => {
                notificationToast.classList.add('translate-x-full');
                 setTimeout(() => notificationToast.classList.add('hidden'), 500);
            }, duration);
        }

        // --- AUTHENTICATION MODULE ---
        function initAuth() {
            const loginBtns = [
                document.getElementById('login-btn'), 
                document.getElementById('login-btn-mobile'),
                document.getElementById('login-for-journal-btn')
            ];
            
            onAuthStateChanged(auth, user => {
                currentUser = user;
                const isLoggedIn = !!user;
                
                document.getElementById('login-btn').classList.toggle('hidden', isLoggedIn);
                document.getElementById('login-btn-mobile').classList.toggle('hidden', isLoggedIn);
                document.getElementById('profile-section-nav').classList.toggle('hidden', !isLoggedIn);
                document.getElementById('profile-section-nav').classList.toggle('flex', isLoggedIn);
                document.getElementById('profile-link-mobile').classList.toggle('hidden', !isLoggedIn);

                if (isLoggedIn) {
                    document.getElementById('user-avatar').src = user.photoURL || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMjAiIGZpbGw9IiM1YTZlNWEiLz4KPHRleHQgeD0iNTAlIiB5PSI1MCUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjIwIiBmaWxsPSJ3aGl0ZSI+VTwvdGV4dD4KPC9zdmc+Cg==';
                    document.getElementById('welcome-message').textContent = `مرحباً بك في أسرتنا، ${user.displayName || 'صديقي'}`;
                    loadPatientFileData();
                    toggleJournalView(true);
                    loadJournalEntries(); 
                } else {
                    document.getElementById('saved-results-container').innerHTML = '<p>الرجاء تسجيل الدخول لعرض سجلاتك المحفوظة.</p>';
                    toggleJournalView(false);
                }
            });

            const handleLogin = () => {
                signInWithPopup(auth, provider).catch(error => {
                    console.error("Google Login Error:", error);
                    showNotification("فشل تسجيل الدخول. يرجى المحاولة مرة أخرى.", "error");
                });
            }
            loginBtns.forEach(btn => {
                if(btn) btn.addEventListener('click', handleLogin)
            });
        }
        
        // --- FIRESTORE MODULE ---
        async function saveResultToFirestore(toolName, resultData, meta) {
            if (!currentUser) {
                showNotification('الرجاء تسجيل الدخول لحفظ نتائجك.', 'warning'); 
                return;
            }
            const resultId = `${toolName.replace(/\s+/g, '-')}-${new Date().getTime()}`;
            const resultRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'toolResults', resultId);
            
            try {
                await setDoc(resultRef, {
                    tool: toolName,
                    data: resultData,
                    meta: meta || null,
                    createdAt: new Date()
                });
                const saveBtn = document.getElementById('save-result-btn') || document.getElementById('save-wheel-result-btn');
                if(saveBtn) {
                   saveBtn.textContent = 'تم الحفظ بنجاح!';
                   saveBtn.disabled = true;
                }
                showNotification('تم حفظ النتيجة بنجاح في ملفك!', 'success');
                loadPatientFileData();
            } catch (error) {
                console.error("Error saving document: ", error);
                showNotification('حدث خطأ أثناء حفظ النتيجة.', 'error');
            }
        }

        async function loadPatientFileData() {
            if (!currentUser) return;
            const container = document.getElementById('saved-results-container');
            container.innerHTML = '<p>جاري تحميل سجلاتك...</p>';
            try {
                const resultsCol = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'toolResults');
                const q = query(resultsCol, limit(50));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    container.innerHTML = '<p>لا توجد نتائج محفوظة بعد. استخدم إحدى الأدوات الذكية واحفظ النتيجة لتظهر هنا.</p>';
                    return;
                }
                
                const results = [];
                querySnapshot.forEach(doc => {
                    results.push(doc.data());
                });

                results.sort((a, b) => b.createdAt.toDate().getTime() - a.createdAt.toDate().getTime());
                
                let html = '';
                results.forEach(result => {
                    const canOpen = result.meta && result.meta.id;
                    html += `
                        <div class="p-4 bg-gray-50 border-r-4 border-gray-300 rounded-md">
                            <h4 class="font-bold text-lg">${result.tool}</h4>
                            <p class="text-sm text-gray-500 mb-2">تاريخ الحفظ: ${result.createdAt.toDate().toLocaleString('ar-EG')}</p>
                            <div class="text-gray-700 whitespace-pre-wrap mb-3">${result.data}</div>
                            <div class="flex gap-2 justify-start">
                               <button class="open-saved-assessment btn btn-outline px-3 py-1 rounded-full" data-quiz-id="${canOpen ? result.meta.id : ''}" ${canOpen ? '' : 'disabled'}>${canOpen ? 'إعادة فتح التقييم' : '—'}</button>
                            </div>
                        </div>`;
                });
                container.innerHTML = html;
                // Bind reopen buttons
                container.querySelectorAll('.open-saved-assessment').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const id = btn.getAttribute('data-quiz-id');
                        if (id) window.__startQuiz?.(id);
                    });
                });
            } catch (error) {
                console.error("Error loading patient data:", error);
                container.innerHTML = '<p class="text-red-500">حدث خطأ أثناء تحميل سجلاتك. يرجى المحاولة مرة أخرى.</p>';
            }
        }
        
        // --- Central API Request Handler ---
        async function handleApiRequest(prompt, resultsDivId, apiKey) {
            const resultsDiv = document.getElementById(resultsDivId);
            if (!resultsDiv) {
                console.error(`Element with ID ${resultsDivId} not found.`);
                return null;
            }
            
            resultsDiv.classList.remove('hidden');
            resultsDiv.style.opacity = '1';
            resultsDiv.innerHTML = `<div class="ai-loader"><div class="ai-loader-dots"><div class="dot1"></div><div class="dot2"></div><div class="dot3"></div></div><p class="mt-4 text-[--primary-color]">جاري التحليل...</p></div>`;
            
            if (!apiKey || apiKey === "YOUR_API_KEY_HERE" || apiKey.length < 30) {
                showNotification("مفتاح Google API غير موجود أو غير صحيح. يرجى إضافته في الكود.", "error");
                resultsDiv.innerHTML = `<p class="text-center text-red-500">خطأ: مفتاح Google API مطلوب لتشغيل هذه الأداة.</p>`;
                return null;
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("API Error Response:", errorData);
                    throw new Error(`HTTP error! status: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
                }
                const data = await response.json();
                if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts.length > 0) {
                    return data.candidates[0].content.parts[0].text;
                } else { throw new Error("Invalid API response structure"); }
            } catch (error) {
                console.error("API Request Error:", error);
                resultsDiv.innerHTML = `<p class="text-center text-red-500">حدث خطأ: ${error.message}. يرجى التحقق من مفتاح API وصلاحياته.</p>`;
                return null;
            }
        }


        // --- SMART TOOLS MODULE ---
        function initSmartTools() {
            const toolModal = document.getElementById('tool-modal');
            const modalContent = document.getElementById('modal-content');
            let lastFocused = null;
            
            const showModal = (content) => {
                modalContent.innerHTML = content;
                // label dialog by first header
                const firstH3 = modalContent.querySelector('h3');
                if (firstH3) firstH3.id = 'tool-modal-title';
                toolModal.setAttribute('aria-labelledby', firstH3 ? 'tool-modal-title' : '');
                // open and focus
                lastFocused = document.activeElement;
                toolModal.classList.remove('hidden');
                setTimeout(() => {
                    toolModal.classList.add('is-open');
                    modalContent.parentElement.classList.add('scale-100');
                    const focusables = modalContent.querySelectorAll('a[href], button, textarea, input, select, [tabindex]:not([tabindex="-1"])');
                    (focusables[0] || modalContent).focus();
                }, 10);
                const closeButton = modalContent.querySelector('.close-modal-btn');
                if (closeButton) closeButton.addEventListener('click', hideModal);
            };

            const hideModal = () => {
                toolModal.classList.remove('is-open');
                modalContent.parentElement.classList.remove('scale-100');
                setTimeout(() => {
                    toolModal.classList.add('hidden');
                    modalContent.innerHTML = '';
                    if (lastFocused) try { lastFocused.focus(); } catch {}
                }, 300);
            };
            
            toolModal.addEventListener('click', e => {
                if (e.target === toolModal) hideModal();
            });
            toolModal.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') { e.preventDefault(); hideModal(); return; }
                if (e.key !== 'Tab') return;
                const focusables = Array.from(modalContent.querySelectorAll('a[href], button, textarea, input, select, [tabindex]:not([tabindex="-1"])'));
                if (!focusables.length) return;
                const idx = focusables.indexOf(document.activeElement);
                let next = idx;
                if (e.shiftKey) next = (idx - 1 + focusables.length) % focusables.length;
                else next = (idx + 1) % focusables.length;
                e.preventDefault();
                focusables[next].focus();
            });

            document.querySelectorAll('.smart-tool-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const tool = button.dataset.tool;
                    let modalHTML = '';
                    switch(tool) {
                        case 'med-interactions':
                            modalHTML = `
                                <button class="close-modal-btn absolute top-4 left-4 text-2xl text-gray-500 hover:text-gray-800" aria-label="إغلاق">&times;</button>
                                <h3 class="text-2xl font-bold mb-4 text-[--primary-color]">تداخلات الأدوية</h3>
                                <p class="text-gray-600 mb-6">أدخل قائمة الأدوية/المكملات الجارية (مع الجرعات إن أمكن) للتحقق من أشهر التداخلات والملاحظات.</p>
                                <form id="tool-form">
                                    <div class="mb-4">
                                        <label for="meds-list" class="block text-right font-semibold mb-2">الأدوية والمكملات</label>
                                        <textarea id="meds-list" rows="6" class="w-full p-2 border rounded-md" placeholder="مثال:\nAspirin 81mg daily\nMetformin 1000mg BID\nVitamin D3 2000 IU daily\nOmega-3 1000mg"></textarea>
                                    </div>
                                    <div class="text-left">
                                        <button type="button" class="close-modal-btn btn btn-secondary py-2 px-6 rounded-full">إغلاق</button>
                                        <button type="submit" class="btn btn-primary text-white py-2 px-6 rounded-full mr-2">تحقق من التداخلات</button>
                                    </div>
                                </form>
                                <div id="tool-results" class="mt-6 hidden"></div>`;
                            break;
                        case 'nutrition-plan':
                            modalHTML = `
                                <button class="close-modal-btn absolute top-4 left-4 text-2xl text-gray-500 hover:text-gray-800" aria-label="إغلاق">&times;</button>
                                <h3 class="text-2xl font-bold mb-4 text-[--primary-color]">خطة تغذية أسبوعية</h3>
                                <p class="text-gray-600 mb-6">أدخل الهدف الغذائي والقيود لتوليد خطة أسبوعية متوازنة (اقتراح عام غير تشخيصي).</p>
                                <form id="tool-form">
                                    <div class="mb-4 grid md:grid-cols-2 gap-3 text-right">
                                        <div>
                                            <label for="nutri-goal" class="block font-semibold mb-2">الهدف</label>
                                            <input id="nutri-goal" type="text" class="w-full p-2 border rounded-md" placeholder="إنقاص وزن، ضبط سكر، مضاد التهاب..." />
                                        </div>
                                        <div>
                                            <label for="nutri-restrict" class="block font-semibold mb-2">قيود/حساسيات</label>
                                            <input id="nutri-restrict" type="text" class="w-full p-2 border rounded-md" placeholder="خالي من الغلوتين، بدون ألبان..." />
                                        </div>
                                    </div>
                                    <div class="text-left">
                                        <button type="button" class="close-modal-btn btn btn-secondary py-2 px-6 rounded-full">إغلاق</button>
                                        <button type="submit" class="btn btn-primary text-white py-2 px-6 rounded-full mr-2">أنشئ الخطة</button>
                                    </div>
                                </form>
                                <div id="tool-results" class="mt-6 hidden"></div>`;
                            break;
                        case 'sleep-coach':
                            modalHTML = `
                                <button class="close-modal-btn absolute top-4 left-4 text-2xl text-gray-500 hover:text-gray-800" aria-label="إغلاق">&times;</button>
                                <h3 class="text-2xl font-bold mb-4 text-[--primary-color]">مدرب النوم</h3>
                                <p class="text-gray-600 mb-6">صف مشاكل النوم الحالية، وروتينك، لتحصل على خطة عادات نوم عملية.</p>
                                <form id="tool-form">
                                    <div class="mb-4">
                                        <label for="sleep-issues" class="block text-right font-semibold mb-2">مشاكل النوم</label>
                                        <textarea id="sleep-issues" rows="5" class="w-full p-2 border rounded-md" placeholder="مثال: صعوبة في البدء بالنوم، استيقاظ متكرر..."></textarea>
                                    </div>
                                    <div class="text-left">
                                        <button type="button" class="close-modal-btn btn btn-secondary py-2 px-6 rounded-full">إغلاق</button>
                                        <button type="submit" class="btn btn-primary text-white py-2 px-6 rounded-full mr-2">احصل على الخطة</button>
                                    </div>
                                </form>
                                <div id="tool-results" class="mt-6 hidden"></div>`;
                            break;
                        case 'protocols':
                            modalHTML = `
                                <button class="close-modal-btn absolute top-4 left-4 text-2xl text-gray-500 hover:text-gray-800">&times;</button>
                                <h3 class="text-2xl font-bold mb-4 text-center text-[--primary-color]">🧪 بروتوكولات طِبرا العلاجية</h3>
                                <p class="text-center text-gray-600 mb-6">بروتوكولات علاجية متكاملة صمّمها د. عمر لمرافقة رحلة الشفاء الطبيعية</p>
                                <div class="grid gap-4 sm:grid-cols-2">
                                    <div class="p-6 bg-white rounded-lg shadow border text-right flex flex-col justify-between">
                                        <div>
                                            <h4 class="font-bold text-lg mb-2">💆‍♂️ بروتوكول تقوية وتغذية الشعر وإزالة الشيب والصلع</h4>
                                            <p class="text-sm mb-4">بروتوكول شامل لتقوية الجذور، تأخير الشيب، وتحفيز نمو الشعر الطبيعي</p>
                                        </div>
                                        <button class="btn btn-secondary w-full mt-auto" onclick="openModal('hair-protocol-modal')">عرض التفاصيل</button>
                                    </div>
                                    <div class="p-6 bg-white rounded-lg shadow border text-right flex flex-col justify-between">
                                        <div>
                                            <h4 class="font-bold text-lg mb-2">🩺 بروتوكول البواسير المتكامل</h4>
                                            <p class="text-sm mb-4">علاج شامل للبواسير عبر الدمج بين الطب الحديث، الأعشاب، المكملات، والعلاج الطاقي–الشعوري. بإشراف د. عمر.</p>
                                        </div>
                                        <button class="btn btn-secondary w-full mt-auto" onclick="openModal('hemorrhoid-protocol-modal')">عرض التفاصيل</button>
                                    </div>
                                    <div class="p-6 bg-gray-50 rounded-lg shadow border flex items-center justify-center text-center">
                                        <h4 class="font-bold">🧠 بروتوكول صفاء الدماغ<br><span class="text-sm text-gray-500">قريبًا</span></h4>
                                    </div>
                                    <div class="p-6 bg-gray-50 rounded-lg shadow border flex items-center justify-center text-center">
                                        <h4 class="font-bold">🔥 بروتوكول تقليل الالتهاب<br><span class="text-sm text-gray-500">قريبًا</span></h4>
                                    </div>
                                    <div class="p-6 bg-gray-50 rounded-lg shadow border flex items-center justify-center text-center">
                                        <h4 class="font-bold">🌿 بروتوكول تنظيف القولون<br><span class="text-sm text-gray-500">قريبًا</span></h4>
                                    </div>
                                </div>`;
                            showModal(modalHTML);
                            break;
                        case 'hair-protocol':
                            modalHTML = `
                                <button class="close-modal-btn absolute top-4 left-4 text-2xl text-gray-500 hover:text-gray-800">&times;</button>
                                <h3 class="text-2xl font-bold mb-4 text-center text-[--primary-color]">البروتوكول الشمولي لعلاج الشعر</h3>
                                <div class="text-right space-y-4">
                                    <p class="text-center text-gray-600 mb-4">بروتوكول علاجي شامل لتأخير الشيب وتحفيز تصبغ الشعر وتقليل التساقط.</p>
                                    
                                    <div class="p-4 bg-gray-50 rounded-lg">
                                        <h4 class="font-bold text-lg mb-2 text-[--primary-dark]">الجزء 1: الزيوت العلاجية الموضعية (2-3 مرات أسبوعياً)</h4>
                                        <p><strong>التركيبة:</strong></p>
                                        <ul class="list-disc list-inside pr-4">
                                            <li>زيت إكليل الجبل: 10 مل</li>
                                            <li>زيت النعناع: 5 مل</li>
                                            <li>زيت الليمون: 5 مل</li>
                                            <li>زيت السمسم (كزيت حامل): 30 مل</li>
                                            <li>زيت الخروع (اختياري للتكثيف): 10 مل</li>
                                            <li>كيروسين طبي أو بارافين طبي: 5 مل</li>
                                        </ul>
                                        <p class="mt-2"><strong>طريقة الاستخدام:</strong> امزج المكونات، دفئها قليلاً، دلك فروة الرأس لـ 5-10 دقائق، واتركها لساعتين على الأقل قبل غسلها بشامبو طبيعي.</p>
                                    </div>

                                    <div class="p-4 bg-gray-50 rounded-lg">
                                        <h4 class="font-bold text-lg mb-2 text-[--primary-dark]">الجزء 2: مكملات غذائية يومية</h4>
                                         <ul class="list-disc list-inside pr-4">
                                            <li><strong>صباحًا بعد الفطور:</strong> Zinc (30-50 ملغ) مع Vitamin C (Liposomal) (500-1000 ملغ)</li>
                                            <li><strong>بعد ساعتين من الزنك:</strong> Copper (2-3 ملغ)</li>
                                            <li><strong>صباحًا أو مساءً:</strong> Fo-Ti (كبسولة 500-1000 ملغ) - <span class="text-red-500 font-bold">ينصح بعمل تحليل وظائف كبد.</span></li>
                                        </ul>
                                    </div>
                                    
                                    <div class="p-4 bg-gray-50 rounded-lg">
                                        <h4 class="font-bold text-lg mb-2 text-[--primary-dark]">الجزء 3: قناع الشعر الطبيعي (مرة أسبوعياً)</h4>
                                        <p><strong>التركيبة:</strong> ملعقة كبيرة سدر بودرة، ملعقة صغيرة عكبر نحل، نصف ملعقة صغيرة بذور الخلة المطحونة، 2 ملعقة كبيرة خل تفاح طبيعي، وماء دافئ للعجن.</p>
                                        <p class="mt-2"><strong>طريقة الاستخدام:</strong> يوضع على الفروة والشعر لمدة 30-60 دقيقة ثم يغسل جيداً.</p>
                                    </div>

                                    <div class="p-4 bg-gray-50 rounded-lg">
                                        <h4 class="font-bold text-lg mb-2 text-[--primary-dark]">الجزء 4: مادة ORMUS</h4>
                                        <p><strong>الجرعة:</strong> ملعقة صغيرة يومياً صباحاً على معدة فارغة من مصدر موثوق.</p>
                                        <p><strong>الفوائد:</strong> يزيد التركيز، يوازن الطاقات، ويحفز تجدد الخلايا الصبغية.</p>
                                        <p class="text-red-500 font-bold mt-2">تحذير: لا تستخدم ORMUS مع أدوية نفسية أو مناعية دون استشارة طبيب.</p>
                                    </div>

                                    <div class="p-4 bg-green-50 rounded-lg border-r-4 border-green-500">
                                        <h4 class="font-bold text-lg mb-2 text-green-800">نصائح عامة داعمة</h4>
                                        <ul class="list-disc list-inside pr-4">
                                            <li>اتبع نظامًا غذائيًا غنيًا بفيتامينات B12، حمض الفوليك، والسيليكا.</li>
                                            <li>خفف التوتر، لأن الإجهاد يزيد من الشيب.</li>
                                            <li>تجنب الصبغات الكيميائية القوية أثناء البروتوكول.</li>
                                            <li>أكثر من شرب العصائر الخضراء.</li>
                                        </ul>
                                    </div>
                                </div>`;
                             break;
                         case 'blood-test-decoder':
                             modalHTML = `
                                 <h3 class="text-2xl font-bold mb-4 text-[--primary-color]">فك شفرة تحاليل الدم</h3>
                                 <p class="text-gray-600 mb-6">الصق نتائج تحاليل دمك هنا. ستقوم الأداة بتحليلها من منظور الطب الوظيفي، مع التركيز على المعدلات المثالية وليس فقط الطبيعية.</p>
                                 <form id="tool-form">
                                     <div class="mb-4">
                                         <label for="blood-test-data" class="block text-right font-semibold mb-2">نتائج التحليل</label>
                                         <textarea id="blood-test-data" rows="10" class="w-full p-2 border rounded-md" placeholder="مثال:&#10;Vitamin D (25-OH) ..... 21 ng/mL&#10;Ferritin ................ 35 ng/mL&#10;TSH ..................... 3.8 mIU/L"></textarea>
                                     </div>
                                     <div class="text-left">
                                         <button type="button" class="close-modal-btn btn btn-secondary py-2 px-6 rounded-full">إغلاق</button>
                                         <button type="submit" class="btn btn-primary text-white py-2 px-6 rounded-full mr-2">حلل نتائجي</button>
                                     </div>
                                 </form>
                                 <div id="tool-results" class="mt-6 hidden"></div>`;
                             break;
                         case 'diagnosis':
                             modalHTML = `
                                 <h3 class="text-2xl font-bold mb-4 text-[--primary-color]">تشخيص متعدد الأبعاد</h3>
                                 <p class="text-gray-600 mb-6">يرجى إدخال المعلومات التالية بأكبر قدر ممكن من التفصيل.</p>
                                 <form id="tool-form">
                                     <div class="mb-4">
                                         <label for="symptoms" class="block text-right font-semibold mb-2">1. الأعراض الجسدية</label>
                                         <textarea id="symptoms" rows="3" class="w-full p-2 border rounded-md" placeholder="مثال: صداع نصفي، ألم في المفاصل..."></textarea>
                                     </div>
                                     <div class="mb-4">
                                         <label for="feelings" class="block text-right font-semibold mb-2">2. المشاعر والأفكار</label>
                                         <textarea id="feelings" rows="3" class="w-full p-2 border rounded-md" placeholder="مثال: أشعر بقلق دائم، أفكار سلبية..."></textarea>
                                     </div>
                                     <div class="mb-4">
                                         <label for="lifestyle" class="block text-right font-semibold mb-2">3. نمط الحياة</label>
                                         <textarea id="lifestyle" rows="3" class="w-full p-2 border rounded-md" placeholder="مثال: نومي متقطع، أعتمد على الوجبات السريعة..."></textarea>
                                     </div>
                                     <div class="text-left">
                                         <button type="button" class="close-modal-btn btn btn-secondary py-2 px-6 rounded-full">إغلاق</button>
                                         <button type="submit" class="btn btn-primary text-white py-2 px-6 rounded-full mr-2">ابدأ التحليل</button>
                                     </div>
                                 </form>
                                 <div id="tool-results" class="mt-6 hidden"></div>`;
                             break;
                         case 'treatment-plan':
                             modalHTML = `
                                 <h3 class="text-2xl font-bold mb-4 text-[--primary-color]">وصفة علاجية شمولية ذكية</h3>
                                 <p class="text-gray-600 mb-6">أدخل التشخيص أو الأعراض الرئيسية، مع معلومات إضافية، للحصول على خطة علاجية مقترحة.</p>
                                 <form id="tool-form">
                                     <div class="mb-4">
                                         <label for="diagnosis-input" class="block text-right font-semibold mb-2">1. التشخيص أو الأعراض الرئيسية</label>
                                         <textarea id="diagnosis-input" rows="4" class="w-full p-2 border rounded-md" placeholder="مثال: تشخيص بالقولون العصبي، مع قلق وتعب مستمر"></textarea>
                                     </div>
                                     <div class="text-left">
                                         <button type="button" class="close-modal-btn btn btn-secondary py-2 px-6 rounded-full">إغلاق</button>
                                         <button type="submit" class="btn btn-primary text-white py-2 px-6 rounded-full mr-2">صمم خطتي</button>
                                     </div>
                                 </form>
                                 <div id="tool-results" class="mt-6 hidden"></div>`;
                             break;
                         case 'awareness-exercise':
                              modalHTML = `
                                 <h3 class="text-2xl font-bold mb-4 text-[--primary-color]">تمرين وعي موجّه</h3>
                                 <p class="text-gray-600 mb-6">صف المشاعر التي تمر بها أو الصدمة التي تود العمل عليها، وسيقوم المساعد الذكي بإنشاء تمرين كتابة موجه لك.</p>
                                 <form id="tool-form">
                                     <div class="mb-4">
                                         <label for="repressed-feelings" class="block text-right font-semibold mb-2">المشاعر المكبوتة أو الصدمة</label>
                                         <textarea id="repressed-feelings" rows="4" class="w-full p-2 border rounded-md" placeholder="مثال: أشعر بغضب مكبوت تجاه موقف معين..."></textarea>
                                     </div>
                                     <div class="text-left">
                                         <button type="button" class="close-modal-btn btn btn-secondary py-2 px-6 rounded-full">إغلاق</button>
                                         <button type="submit" class="btn btn-primary text-white py-2 px-6 rounded-full mr-2">أنشئ التمرين</button>
                                     </div>
                                 </form>
                                 <div id="tool-results" class="mt-6 hidden"></div>`;
                             break;
                         case 'consultation':
                              modalHTML = `
                                 <h3 class="text-2xl font-bold mb-4 text-[--primary-color]">استشارة طبية آلية</h3>
                                 <p class="text-gray-600 mb-6">اطرح سؤالك على مساعد د. عمر الذكي للحصول على إجابات تستند إلى مبادئ الطب الشمولي.</p>
                                 <form id="tool-form">
                                     <div class="mb-4">
                                         <label for="question" class="block text-right font-semibold mb-2">سؤالك</label>
                                         <textarea id="question" rows="4" class="w-full p-2 border rounded-md" placeholder="مثال: ما هي أفضل الطرق لتقوية المناعة بشكل طبيعي؟"></textarea>
                                     </div>
                                     <div class="text-left">
                                         <button type="button" class="close-modal-btn btn btn-secondary py-2 px-6 rounded-full">إغلاق</button>
                                         <button type="submit" class="btn btn-primary text-white py-2 px-6 rounded-full mr-2">احصل على الإجابة</button>
                                     </div>
                                 </form>
                                 <div id="tool-results" class="mt-6 hidden"></div>`;
                             break;
                         case 'supplements':
                              modalHTML = `
                                 <h3 class="text-2xl font-bold mb-4 text-[--primary-color]">توصية مكملات غذائية</h3>
                                 <p class="text-gray-600 mb-6">صف أعراضك أو الصق نتائج تحليل الدم هنا، وسيقوم المساعد الذكي بتحليلها وتقديم توصيات للمكملات الغذائية.</p>
                                 <form id="tool-form">
                                     <div class="mb-4">
                                         <label for="analysis-data" class="block text-right font-semibold mb-2">الأعراض أو نتائج التحليل</label>
                                         <textarea id="analysis-data" rows="5" class="w-full p-2 border rounded-md" placeholder="مثال: أعاني من تساقط الشعر، إرهاق مستمر..."></textarea>
                                     </div>
                                     <div class="text-left">
                                         <button type="button" class="close-modal-btn btn btn-secondary py-2 px-6 rounded-full">إغلاق</button>
                                         <button type="submit" class="btn btn-primary text-white py-2 px-6 rounded-full mr-2">احصل على توصية</button>
                                     </div>
                                 </form>
                                 <div id="tool-results" class="mt-6 hidden"></div>`;
                             break;
                         case 'intention':
                              modalHTML = `
                                 <h3 class="text-2xl font-bold mb-4 text-[--primary-color]">نية اليوم</h3>
                                 <p class="text-gray-600 mb-6">احصل على نية إيجابية ومركزة لدعمك في يومك.</p>
                                 <form id="tool-form">
                                     <div class="text-left">
                                         <button type="button" class="close-modal-btn btn btn-secondary py-2 px-6 rounded-full">إغلاق</button>
                                         <button type="submit" class="btn btn-primary text-white py-2 px-6 rounded-full mr-2">أعطني نيتي</button>
                                     </div>
                                 </form>
                                 <div id="tool-results" class="mt-6 hidden"></div>`;
                             break;
                    }
                    showModal(modalHTML);
                    const form = document.getElementById('tool-form');
                    if (form) form.addEventListener('submit', (e) => handleToolSubmit(e, tool));
                });
            });
            
            async function handleToolSubmit(e, tool) {
                e.preventDefault();
                let prompt = '', toolTitle = '', rawInputForSaving = '';
                 switch(tool) {
                       case 'blood-test-decoder':
                           toolTitle = "فك شفرة تحاليل الدم";
                           const bloodTestData = document.getElementById('blood-test-data').value;
                           rawInputForSaving = `بيانات التحليل: ${bloodTestData}`;
                           if (!bloodTestData) { showNotification('يرجى لصق نتائج التحليل.', 'warning'); return; }
                           prompt = `Act as a functional medicine expert analyzing blood test results. The user has provided these results: "${bloodTestData}". Your task is to:
1.  Identify key markers (like Vitamin D, Ferritin, TSH, etc.).
2.  For each marker, state its functional/optimal range (which is often stricter than the standard lab range).
3.  Compare the user's result to the optimal range.
4.  Explain in simple Arabic what this result means for their health from a holistic perspective (e.g., how low ferritin affects energy and hair).
5.  Provide actionable recommendations including specific foods, lifestyle changes, and potential supplements to help them reach the optimal range.
Structure the output in Arabic with clear headings for each marker using markdown. Start with a disclaimer that this is not a medical diagnosis.`;
                           break;
                       case 'diagnosis':
                           toolTitle = "تشخيص متعدد الأبعاد";
                           const symptoms = document.getElementById('symptoms').value;
                           const feelings = document.getElementById('feelings').value;
                           const lifestyle = document.getElementById('lifestyle').value;
                           rawInputForSaving = `الأعراض: ${symptoms}\nالمشاعر: ${feelings}\nنمط الحياة: ${lifestyle}`;
                           if (!symptoms && !feelings && !lifestyle) { showNotification('يرجى إدخال بعض المعلومات للتحليل.', 'warning'); return; }
                           prompt = `Act as a holistic medicine expert. Analyze the user's input based on a tripartite model (organic, emotional, energetic) and provide a probable diagnosis or assessment. User Input -> Symptoms: "${symptoms}", Feelings: "${feelings}", Lifestyle: "${lifestyle}". Structure the output as a clean, readable text in Arabic with three main sections: "الاحتمال العضوي", "الجذر الشعوري", and "التوازن الطاقي المختل". Use markdown for formatting.`;
                           break;
                       case 'treatment-plan':
                           toolTitle = "وصفة علاجية شمولية";
                           const diagnosisInput = document.getElementById('diagnosis-input').value;
                           rawInputForSaving = `التشخيص: ${diagnosisInput}`;
                           if (!diagnosisInput) { showNotification('يرجى إدخال التشخيص أو الأعراض الرئيسية.', 'warning'); return; }
                           prompt = `As a functional medicine doctor, design a comprehensive 21-day holistic treatment plan for a patient with the following diagnosis/symptoms: "${diagnosisInput}". The plan should include sections for: "الأدوية أو المكملات المقترحة", "توصيات التغذية", "تمارين تأمل أو وعي", and "نصائح طاقة ونمط حياة". Present the output in a well-structured, easy-to-read format in Arabic using markdown.`;
                           break;
                       case 'awareness-exercise':
                           toolTitle = "تمرين وعي موجّه";
                           const repressedFeelings = document.getElementById('repressed-feelings').value;
                           rawInputForSaving = `المشاعر: ${repressedFeelings}`;
                           if (!repressedFeelings) { showNotification('يرجى وصف مشاعرك.', 'warning'); return; }
                           prompt = `You are a therapeutic writing coach. Based on the user's stated repressed feelings: "${repressedFeelings}", create a guided expressive writing exercise. The output should be in Arabic and include: 1. A gentle introduction. 2. A series of 3-5 reflective writing prompts. 3. A concluding guidance on how to process what they've written. Format the output with clear headings using markdown.`;
                           break;
                       case 'consultation':
                           toolTitle = "استشارة طبية آلية";
                           const question = document.getElementById('question').value;
                           rawInputForSaving = `السؤال: ${question}`;
                           if (!question) { showNotification('يرجى كتابة سؤالك.', 'warning'); return; }
                           prompt = `As a holistic medicine assistant for Dr. Omar, answer the following question in Arabic, incorporating principles of holistic, functional, and spiritual medicine where appropriate. Question: "${question}"`;
                           break;
                       case 'supplements':
                           toolTitle = "توصية مكملات غذائية";
                           const analysisData = document.getElementById('analysis-data').value;
                           rawInputForSaving = `البيانات: ${analysisData}`;
                           if (!analysisData) { showNotification('يرجى إدخال الأعراض أو نتائج التحليل.', 'warning'); return; }
                           prompt = `As a functional medicine expert, analyze the provided symptoms or blood test results: "${analysisData}" and recommend the most effective supplements. Include recommended timing (e.g., with food, in the morning) and any potential warnings. The output should be a clear, bulleted list in Arabic.`;
                           break;
                       case 'intention':
                           toolTitle = "نية اليوم";
                           rawInputForSaving = `طلب نية اليوم`;
                           prompt = `As a spiritual wellness coach, provide a supportive, healing daily intention for the user. The output should be a single, powerful intention sentence in Arabic, followed by a short (1-2 sentences) "تمرين دعم داخلي" to help them embody that intention.`;
                           break;
                }
                // Prepare loading UI for tool results
                const toolResultsDiv = document.getElementById('tool-results');
                if (toolResultsDiv) {
                    toolResultsDiv.classList.remove('hidden');
                    toolResultsDiv.setAttribute('role', 'status');
                    toolResultsDiv.setAttribute('aria-live', 'polite');
                    toolResultsDiv.setAttribute('aria-busy', 'true');
                    toolResultsDiv.innerHTML = `
                        <div class="ai-loader p-4">
                            <div class="ai-loader-dots"><div class="dot1"></div><div class="dot2"></div><div class="dot3"></div></div>
                            <p class="mt-2 text-gray-500">جاري إعداد النتيجة...</p>
                        </div>`;
                }
                const responseText = await handleApiRequest(prompt, 'tool-results', GEMINI_API_KEY);
                if (responseText) {
                    const resultsDiv = document.getElementById('tool-results');
                    resultsDiv.innerHTML = `
                        <div id="result-content" class="p-4 bg-gray-50 rounded-md text-right whitespace-pre-wrap border">${responseText}</div>
                        <div class="mt-4 text-left">
                            ${currentUser ? '<button id="save-result-btn" class="btn btn-secondary py-2 px-4 rounded-full text-sm">حفظ النتيجة</button>' : ''}
                            <button id="download-pdf-btn" class="btn btn-primary text-white py-2 px-4 rounded-full mr-2 text-sm">تحميل كـ PDF</button>
                        </div>`;
                    resultsDiv.removeAttribute('aria-busy');
                    if (currentUser) {
                        document.getElementById('save-result-btn').addEventListener('click', () => {
                            const fullResultText = `--- المدخلات ---\n${rawInputForSaving}\n\n--- نتيجة التحليل ---\n${responseText}`;
                            saveResultToFirestore(toolTitle, fullResultText)
                        });
                    }
                    document.getElementById('download-pdf-btn').addEventListener('click', () => downloadResultAsPDF('result-content', toolTitle));
                }
            }

            // Category & Search filtering for Smart Tools
            const catBtns = document.querySelectorAll('.tool-cat-btn');
            const searchInput = document.getElementById('tool-search');
            const toolGrid = document.getElementById('tool-grid');
            const toolButtons = toolGrid ? Array.from(toolGrid.querySelectorAll('.smart-tool-btn')) : [];

            const getActiveCat = () => {
                const active = Array.from(catBtns).find(b => b.getAttribute('aria-selected') === 'true');
                return active ? active.dataset.cat : 'all';
            };

            const applyToolFilters = () => {
                const cat = getActiveCat();
                const q = (searchInput?.value || '').toLowerCase().trim();
                toolButtons.forEach(btn => {
                    const btnCat = btn.dataset.cat || 'other';
                    const text = btn.textContent.toLowerCase();
                    const matchCat = (cat === 'all') || (btnCat === cat);
                    const matchText = !q || text.includes(q);
                    btn.classList.toggle('hidden', !(matchCat && matchText));
                });
            };

            catBtns.forEach(btn => btn.addEventListener('click', () => {
                catBtns.forEach(b => b.setAttribute('aria-selected', 'false'));
                btn.setAttribute('aria-selected', 'true');
                applyToolFilters();
            }));

            searchInput?.addEventListener('input', applyToolFilters);

            // Initial filter state
            applyToolFilters();
        }
        
        // --- CHRONIC CARE MODULE ---
        function initChronicCare() {
            const section = document.getElementById('view-chronic-care');
            if (!section) return;

            const categoryButtons = section.querySelectorAll('.chronic-category-btn');
            const suggestionsDiv = document.getElementById('chronic-suggestions');
            const askBtn = document.getElementById('chronic-ask-btn');
            const qArea = document.getElementById('chronic-question');
            const resultsDiv = document.getElementById('chronic-results');
            // Tabs and Sections
            const tabButtons = section.querySelectorAll('.tab-btn');
            const segmented = section.querySelector('.segmented-control');
            const articlesSection = document.getElementById('chronic-articles-section');
            const assistantSection = document.getElementById('chronic-assistant-section');
            // Articles Nav
            const articleNav = document.getElementById('chronic-articles-nav');
            const articleContent = document.getElementById('chronic-article-content');
            const diseaseButtons = articleNav ? articleNav.querySelectorAll('button') : [];

            const suggestionMap = {
                diabetes: [
                    'ما أفضل نمط غذائي عملي لمريض السكري من النوع الثاني؟',
                    'كم هدف HbA1c الصحي بشكل عام؟',
                    'كيف أوزّع الكربوهيدرات خلال اليوم؟',
                    'ما العلامات المبكرة لهبوط السكر وكيف أتعامل معها؟',
                    'هل الصيام المتقطع مناسب مع السكري؟'
                ],
                hypertension: [
                    'ما القراءات الطبيعية لضغط الدم في المنزل؟',
                    'كيف أطبق نظام DASH لتقليل الضغط؟',
                    'ما دور الملح والبوتاسيوم والمغنيسيوم في ضغط الدم؟',
                    'ما هي نصائح قياس الضغط المنزلي الصحيحة؟',
                    'متى يجب طلب إسعاف بسبب ارتفاع الضغط؟'
                ],
                diet: [
                    'ما مبادئ النظام المتوسطي المضاد للالتهاب؟',
                    'كم جرام ألياف أنصح بها يومياً، ومن أين أحصل عليها؟',
                    'كيف أبني طبق متوازن: بروتين + ألياف + دهون مفيدة؟',
                    'نصائح للترطيب الذكي وعدد أكواب الماء اليومية؟',
                    'بدائل صحية للسكر المكرر والطحين الأبيض'
                ],
                medications: [
                    'ما أكثر التداخلات الدوائية شيوعاً مع أدوية الضغط والسكري؟',
                    'هل يوجد نقص فيتامين B12 مع الميتفورمين على المدى الطويل؟',
                    'متى أستشير الطبيب فوراً عند ظهور أعراض جانبية؟',
                    'هل يمكن الجمع بين مكملات عشبية وبعض الأدوية بأمان؟',
                    'ما إرشادات عامة لتناول الأدوية بأمان؟'
                ]
            };

            let selectedCat = 'diabetes';

            // Doctor-reviewed articles content
            const articlesContent = {
                diabetes: `
                    <div class="space-y-4 text-right">
                        <h3 class="text-2xl font-bold text-[--primary-dark]">دليل موجز لمرض السكري من النوع الثاني</h3>
                        <p class="text-gray-700">هذه معلومات تعليمية عامة لمساعدتك على فهم الأساسيات قبل زيارتك لطبيبك. ضبط الأهداف النهائية وخطة العلاج فردي ويحدده طبيبك وفق حالتك.</p>

                        <h4 class="text-xl font-bold">الأهداف السريرية العامة (تُفصَّل فردياً):</h4>
                        <ul class="list-disc pr-6 text-gray-800">
                            <li>HbA1c: غالباً &lt; 7% (قد يُشدَّد أو يُليَّن حسب السن، المخاطر، والأمراض المصاحبة).</li>
                            <li>السكر الصائم: 80–130 mg/dL تقريباً.</li>
                            <li>بعد الوجبة (ساعتان): أقل من 180 mg/dL غالباً.</li>
                            <li>ضغط الدم: حول 130/80 mmHg أو أقل إن كان ذلك آمناً ومناسباً لك.</li>
                        </ul>

                        <h4 class="text-xl font-bold">أساسيات نمط الحياة:</h4>
                        <ul class="list-disc pr-6 text-gray-800">
                            <li>نمط غذائي متوازن (متوسطي/‏DASH) يحد من السكريات البسيطة والدقيق الأبيض، ويُكثّر من الألياف (25–35 ج/يوم).</li>
                            <li>حركة أسبوعية: 150 دقيقة على الأقل من النشاط الهوائي المتوسط + تمارين مقاومة 2–3 مرات أسبوعياً.</li>
                            <li>نوم كافٍ (7–9 ساعات) وإدارة للضغط النفسي.</li>
                            <li>خفض الوزن الزائد (5–10%) قد يحسن التحكم بالسكر بشكل ملحوظ.</li>
                        </ul>

                        <h4 class="text-xl font-bold">المراقبة الذاتية:</h4>
                        <ul class="list-disc pr-6 text-gray-800">
                            <li>تعلم تقنية القياس المنزلي الصحيحة وتسجيل القراءات.</li>
                            <li>التعرّف على علامات هبوط السكر (تعرق، رجفان، دوخة) وارتفاعه ومعرفة متى تطلب مساعدة.</li>
                        </ul>

                        <h4 class="text-xl font-bold">متى أطلب رعاية إسعافية؟</h4>
                        <ul class="list-disc pr-6 text-gray-800">
                            <li>أعراض هبوط شديد لا تتحسن بالسكريات السريعة.</li>
                            <li>ارتفاع شديد مستمر مع أعراض (قيء، جفاف، تنفس غير طبيعي، اضطراب وعي).</li>
                            <li>ألم صدر، ضيق نفس شديد، أو ارتباك مفاجئ.</li>
                        </ul>

                        <div class="p-3 rounded-md bg-amber-50 border-r-4 border-amber-500 text-gray-800">
                            تذكير: القرارات العلاجية والجرعات تُحدَّد مع طبيبك فقط. هذه مادة عامة تمهيدية وليست وصفة أو تشخيصاً.
                        </div>
                    </div>
                `,
                hypertension: `
                    <div class="space-y-4 text-right">
                        <h3 class="text-2xl font-bold text-[--primary-dark]">دليل موجز لارتفاع ضغط الدم</h3>
                        <p class="text-gray-700">المعلومات التالية تعليمية عامة. تحديد أهداف الضغط وخيارات العلاج يتم مع طبيبك بناءً على ملفك الصحي الكامل.</p>

                        <h4 class="text-xl font-bold">الأهداف العامة والقياس المنزلي:</h4>
                        <ul class="list-disc pr-6 text-gray-800">
                            <li>الهدف الشائع للبالغين: قراءات قريبة من 130/80 mmHg أو أقل إن كان ذلك مناسباً وآمناً.</li>
                            <li>لأخذ خط أساس: قِس في المنزل صباحاً ومساءً لمدة 3 أيام (قراءتان في كل مرة) واحتسب المتوسط.</li>
                            <li>التقنية الصحيحة: راحة 5 دقائق، ظهر مسنود، الذراع على مستوى القلب، كُفة مناسبة، والامتناع عن الكافيين/التدخين 30 دقيقة قبل القياس.</li>
                        </ul>

                        <h4 class="text-xl font-bold">تعديل نمط الحياة:</h4>
                        <ul class="list-disc pr-6 text-gray-800">
                            <li>تقليل الملح إلى نحو 1500–2000 mg صوديوم/يوم متى أمكن، وزيادة البوتاسيوم الغذائي ما لم توجد موانع (مثل أمراض الكلى).</li>
                            <li>اتباع نظام DASH/متوسطي، الإكثار من الخضار والفواكه والبقول والحبوب الكاملة.</li>
                            <li>نشاط بدني منتظم، خفض الوزن الزائد، تقليل الكحول، والإقلاع عن التدخين.</li>
                        </ul>

                        <h4 class="text-xl font-bold">إنذارات تستوجب مراجعة طبية عاجلة/إسعاف:</h4>
                        <ul class="list-disc pr-6 text-gray-800">
                            <li>ضغط ≥ 180/120 mmHg مع أعراض (ألم صدر، ضيق نفس، أعراض عصبية، تشوش رؤية، صداع شديد مفاجئ).</li>
                            <li>قراءات مرتفعة جداً متكررة رغم الراحة والتقنية الصحيحة.</li>
                        </ul>

                        <div class="p-3 rounded-md bg-amber-50 border-r-4 border-amber-500 text-gray-800">
                            تذكير: هذه مادة تثقيفية عامة. تشخيص السبب وخطة العلاج والدواء يحددها الطبيب وفق تقييم شامل لك.
                        </div>
                    </div>
                `
            , ckd: `
                    <div class="space-y-4 text-right">
                        <h3 class="text-2xl font-bold text-[--primary-dark]">دليل موجز لمرض الكلى المزمن</h3>
                        <p class="text-gray-700">هذه مادة تثقيفية عامة لفهم المرض قبل الاستشارة. التشخيص وخطط العلاج فردية ويحددها الطبيب بناءً على التقييم الشامل.</p>

                        <h4 class="text-xl font-bold">الأساسيات:</h4>
                        <ul class="list-disc pr-6 text-gray-800">
                            <li>يقاس تقدم المرض عادةً عبر معدل الترشيح الكبيبي (eGFR) ووجود ألبومين في البول.</li>
                            <li>التحكم بالضغط والسكري (إن وُجدا) أساس لتباطؤ تدهور الوظيفة الكلوية.</li>
                        </ul>

                        <h4 class="text-xl font-bold">نمط الحياة والدعم:</h4>
                        <ul class="list-disc pr-6 text-gray-800">
                            <li>تقليل الملح الغذائي، شرب ماء مناسب وفق توجيه طبيبك.</li>
                            <li>توازن البروتين وفق إرشاد الطبيب/أخصائي التغذية، وتجنب مسكنات NSAIDs دون استشارة.</li>
                            <li>الالتزام بالتطعيمات الموصى بها ومراجعة الأدوية للتأكد من أمانها كلوياً.</li>
                        </ul>

                        <h4 class="text-xl font-bold">مراقبة عامة:</h4>
                        <ul class="list-disc pr-6 text-gray-800">
                            <li>متابعة دورية لـ eGFR، الألبومين في البول، الشوارد، والهيموغلوبين.</li>
                        </ul>

                        <h4 class="text-xl font-bold">متى أطلب رعاية عاجلة؟</h4>
                        <ul class="list-disc pr-6 text-gray-800">
                            <li>تورم شديد، قلة شديدة في البول، ضيق نفس ملحوظ، ارتباك، ألم صدر.</li>
                        </ul>

                        <div class="p-3 rounded-md bg-amber-50 border-r-4 border-amber-500 text-gray-800">
                            تذكير: هذه معلومات عامة وليست وصفاً علاجياً. خطتك تُحدَّد مع طبيبك المعالج.
                        </div>
                    </div>
                `,
            dyslipidemia: `
                    <div class="space-y-4 text-right">
                        <h3 class="text-2xl font-bold text-[--primary-dark]">دليل موجز لاضطراب دهون الدم</h3>
                        <p class="text-gray-700">الأهداف العلاجية تُحدَّد حسب خطورة القلب والأوعية لديك. هذه معلومات عامة تمهيدية.</p>

                        <h4 class="text-xl font-bold">الأساسيات:</h4>
                        <ul class="list-disc pr-6 text-gray-800">
                            <li>تقييم الخطورة القلبية الوعائية يوجّه مستوى الهدف من LDL وغيرها.</li>
                            <li>التدخلات الدوائية تُقرّر من قبل الطبيب بعد تقييم متكامل.</li>
                        </ul>

                        <h4 class="text-xl font-bold">نمط الحياة:</h4>
                        <ul class="list-disc pr-6 text-gray-800">
                            <li>نظام متوسطي/DASH غني بالألياف (شوفان، بقوليات)، تقليل الدهون المتحولة والدهون المشبعة.</li>
                            <li>نشاط بدني منتظم، خفض الوزن الزائد، الإقلاع عن التدخين.</li>
                        </ul>

                        <h4 class="text-xl font-bold">مراقبة عامة:</h4>
                        <ul class="list-disc pr-6 text-gray-800">
                            <li>تحليل دهون صائم دوري حسب خطة طبيبك ومتابعة الالتزام بالنمط الحياتي.</li>
                        </ul>

                        <h4 class="text-xl font-bold">متى أطلب رعاية عاجلة؟</h4>
                        <ul class="list-disc pr-6 text-gray-800">
                            <li>ألم صدر شديد مفاجئ، ضيق نفس حاد، أعراض عصبية حادة (ضعف/خدر مفاجئ، اضطراب كلام/رؤية).</li>
                        </ul>

                        <div class="p-3 rounded-md bg-amber-50 border-r-4 border-amber-500 text-gray-800">
                            تذكير: هذه مادة تثقيفية عامة. القرار العلاجي النهائي وتحديد الأهداف الدوائية يتمّان مع الطبيب.
                        </div>
                    </div>
                `,
            copd: `
                    <div class="space-y-4 text-right">
                        <h3 class="text-2xl font-bold text-[--primary-dark]">دليل موجز للانسداد الرئوي المزمن (COPD)</h3>
                        <p class="text-gray-700">الحالة تنجم غالباً عن التدخين أو التعرض المزمن للمهيجات. هذه نقاط عامة لمساندة زيارتك للطبيب.</p>

                        <h4 class="text-xl font-bold">الأساسيات:</h4>
                        <ul class="list-disc pr-6 text-gray-800">
                            <li>أعراض شائعة: سعال مزمن، بلغم، ضيق نفس يزداد مع الجهد.</li>
                            <li>الخطة العلاجية الفردية يضعها الطبيب وقد تشمل أجهزة استنشاق وبرامج تأهيل رئوي.</li>
                        </ul>

                        <h4 class="text-xl font-bold">نمط الحياة والوقاية:</h4>
                        <ul class="list-disc pr-6 text-gray-800">
                            <li>الإقلاع التام عن التدخين هو الأهم.</li>
                            <li>التطعيمات الموسمية (الإنفلونزا) وتطعيمات المكورات الرئوية وفق الإرشادات.</li>
                            <li>تمارين تنفّس وتأهيل رئوي لتحسين القدرة على الجهد.</li>
                            <li>تجنّب المهيّجات الهوائية بالبيت والعمل.</li>
                        </ul>

                        <h4 class="text-xl font-bold">متى أطلب رعاية عاجلة؟</h4>
                        <ul class="list-disc pr-6 text-gray-800">
                            <li>ضيق نفس شديد مفاجئ، ازرقاق الشفاه/الأظافر، ارتباك، ألم صدر.</li>
                        </ul>

                        <div class="p-3 rounded-md bg-amber-50 border-r-4 border-amber-500 text-gray-800">
                            تذكير: هذه المعلومات عامة وليست خطة علاج. راجع طبيبك لتشخيص دقيق وتعديل الخطة حسب حالتك.
                        </div>
                    </div>
                `
            };

            const renderArticle = (key) => {
                if (!articleContent) return;
                const html = articlesContent[key] || '<p class="text-gray-600">المحتوى غير متوفر بعد.</p>';
                articleContent.innerHTML = html;
            };

            const setActiveDisease = (btn) => {
                diseaseButtons.forEach(b => {
                    b.classList.remove('active', 'btn-primary');
                    b.classList.add('btn-secondary');
                    b.setAttribute('aria-pressed', 'false');
                });
                if (btn) {
                    btn.classList.add('active', 'btn-primary');
                    btn.classList.remove('btn-secondary');
                    btn.setAttribute('aria-pressed', 'true');
                }
            };

            // Tabs behavior
            const showTab = (tab) => {
                tabButtons.forEach(b => {
                    const isActive = b.dataset.tab === tab;
                    b.classList.toggle('active', isActive);
                    b.setAttribute('aria-selected', isActive ? 'true' : 'false');
                    b.setAttribute('tabindex', isActive ? '0' : '-1');
                });
                if (articlesSection && assistantSection) {
                    if (tab === 'articles') {
                        articlesSection.classList.remove('hidden');
                        articlesSection.setAttribute('aria-hidden', 'false');
                        assistantSection.classList.add('hidden');
                        assistantSection.setAttribute('aria-hidden', 'true');
                    } else {
                        assistantSection.classList.remove('hidden');
                        assistantSection.setAttribute('aria-hidden', 'false');
                        articlesSection.classList.add('hidden');
                        articlesSection.setAttribute('aria-hidden', 'true');
                    }
                }
            };
            tabButtons.forEach(btn => btn.addEventListener('click', () => {
                const tab = btn.dataset.tab;
                showTab(tab);
                // Persist state in hash
                location.hash = `view=chronic-care&tab=${encodeURIComponent(tab)}`;
            }));
            // Keyboard navigation for segmented tabs (RTL-aware)
            segmented && segmented.addEventListener('keydown', (e) => {
                const keys = ['ArrowLeft','ArrowRight','Home','End'];
                if (!keys.includes(e.key)) return;
                e.preventDefault();
                const tabs = Array.from(tabButtons);
                let idx = tabs.indexOf(document.activeElement);
                if (e.key === 'Home') idx = 0;
                else if (e.key === 'End') idx = tabs.length - 1;
                else if (e.key === 'ArrowLeft') idx = (idx + 1) % tabs.length; // RTL: left moves to next visually
                else if (e.key === 'ArrowRight') idx = (idx - 1 + tabs.length) % tabs.length; // RTL: right moves to previous
                const target = tabs[idx];
                if (target) {
                    target.focus();
                    target.click();
                }
            });
            // Default tab
            showTab('articles');

            // Disease buttons behavior
            diseaseButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const key = btn.dataset.disease;
                    setActiveDisease(btn);
                    renderArticle(key);
                    // Persist state in hash
                    location.hash = `view=chronic-care&tab=articles&disease=${encodeURIComponent(key)}`;
                });
            });
            const defaultDiseaseBtn = articleNav ? articleNav.querySelector('[data-disease="diabetes"]') : null;
            if (defaultDiseaseBtn) {
                setActiveDisease(defaultDiseaseBtn);
                renderArticle('diabetes');
            }

            const renderSuggestions = (cat) => {
                const items = suggestionMap[cat] || [];
                suggestionsDiv.innerHTML = items.map((t) => `
                    <button class="btn btn-outline py-2 px-4 rounded-full text-sm text-right">${t}</button>
                `).join('');
                suggestionsDiv.querySelectorAll('button').forEach(b => {
                    b.addEventListener('click', () => {
                        qArea.value = b.textContent.trim();
                        qArea.focus();
                    });
                });
            };

            categoryButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    categoryButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedCat = btn.dataset.cat || 'diabetes';
                    renderSuggestions(selectedCat);
                });
            });

            // Default category
            const defaultBtn = section.querySelector(`.chronic-category-btn[data-cat="${selectedCat}"]`);
            if (defaultBtn) defaultBtn.classList.add('active');
            renderSuggestions(selectedCat);

            const buildPrompt = (question, cat) => `أنت مساعد صحي مسؤول يتبع مبادئ الطب الباطني وطب نمط الحياة. أجب باللغة العربية الفصحى.
مهم: إجابتك عامة تثقيفية وليست تشخيصاً أو وصفاً علاجياً.
الفئة: ${cat}
السؤال: "${question}"

رجاءً قدم إجابة منظمة بعناوين واضحة:
1) ملخص موجز
2) النقاط الأساسية المرتبطة بالفئة
3) نصائح نمط حياة عامة عملية (غير مخصصة)
4) تحذيرات/تداخلات شائعة ذات صلة (إن وُجدت)
5) متى أطلب رعاية طارئة أو أراجع الطبيب فوراً

تجنب الجرعات والأدوية المحددة والقرارات العلاجية الفردية. اختم بتذكير قصير بأن هذه المعلومات عامة فقط.`;

            askBtn.addEventListener('click', async () => {
                const q = (qArea.value || '').trim();
                if (!q) { showNotification('يرجى كتابة سؤالك أولاً.', 'warning'); qArea.focus(); return; }
                const prompt = buildPrompt(q, selectedCat);
                // Show loading state
                resultsDiv.classList.remove('hidden');
                resultsDiv.setAttribute('aria-busy', 'true');
                resultsDiv.innerHTML = `
                    <div class="ai-loader p-4">
                        <div class="ai-loader-dots"><div class="dot1"></div><div class="dot2"></div><div class="dot3"></div></div>
                        <p class="mt-2 text-gray-500">جاري إعداد إجابة عامة...</p>
                    </div>`;
                const responseText = await handleApiRequest(prompt, 'chronic-results', GEMINI_API_KEY);
                if (responseText) {
                    resultsDiv.innerHTML = `
                        <div id="chronic-result-content" class="p-4 bg-gray-50 rounded-md text-right whitespace-pre-wrap border">${responseText}</div>
                        <div class="mt-4 text-left">
                            ${currentUser ? '<button id="save-result-btn" class="btn btn-secondary py-2 px-4 rounded-full text-sm">حفظ النتيجة</button>' : ''}
                            <button id="download-chronic-pdf-btn" class="btn btn-primary text-white py-2 px-4 rounded-full mr-2 text-sm">تحميل كـ PDF</button>
                        </div>`;
                    resultsDiv.classList.remove('hidden');
                    resultsDiv.removeAttribute('aria-busy');
                    if (currentUser) {
                        const fullResultText = `--- الفئة ---\n${selectedCat}\n\n--- السؤال ---\n${q}\n\n--- الإجابة العامة ---\n${responseText}`;
                        document.getElementById('save-result-btn')?.addEventListener('click', () => {
                            saveResultToFirestore('مركز دعم الأمراض المزمنة', fullResultText);
                        });
                    }
                    document.getElementById('download-chronic-pdf-btn')?.addEventListener('click', () => {
                        downloadResultAsPDF('chronic-result-content', 'مركز دعم الأمراض المزمنة');
                    });
                }
            });
        }

        // --- MEDICAL TRAVEL & SECOND OPINION MODULES ---
        function initMedicalTravel() {
            const form = document.getElementById('medical-travel-form');
            if (!form) return;
            const filesInput = document.getElementById('mt-files');
            const resultDiv = document.getElementById('mt-result');

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const fullname = document.getElementById('mt-fullname').value.trim();
                const dob = document.getElementById('mt-dob').value;
                const phone = document.getElementById('mt-phone').value.trim();
                const email = document.getElementById('mt-email').value.trim();
                const city = document.getElementById('mt-city').value.trim();
                const nationality = document.getElementById('mt-nationality').value.trim();
                const diagnosis = document.getElementById('mt-diagnosis').value.trim();
                const urgency = document.getElementById('mt-urgency').value;
                const destination = document.getElementById('mt-destination').value;
                const comorbid = document.getElementById('mt-comorbid').value.trim();
                const companions = document.getElementById('mt-companions').value;
                const dates = document.getElementById('mt-dates').value.trim();

                if (!fullname || !dob || !phone || !email || !diagnosis) {
                    showNotification('يرجى تعبئة الحقول المطلوبة.', 'warning');
                    highlightFirstMissing(['mt-fullname','mt-dob','mt-phone','mt-email','mt-diagnosis']);
                    return;
                }

                try {
                    // Disable UI and show loading
                    const submitBtn = document.getElementById('mt-submit');
                    let prevBtnHTML = '';
                    if (submitBtn) {
                        prevBtnHTML = submitBtn.innerHTML;
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<span class="loading-dots"><span></span><span></span><span></span></span> جاري الإرسال...';
                    }
                    form.classList.add('is-submitting');

                    showNotification('جاري إرسال طلبك...', 'warning');
                    const baseData = {
                        type: 'medical-travel',
                        createdAt: new Date(),
                        status: 'submitted',
                        userUid: currentUser ? currentUser.uid : null,
                        patient: { fullname, dob, phone, email, city, nationality },
                        clinical: { diagnosis, comorbid },
                        logistics: { urgency, destination, companions: companions ? Number(companions) : 0, dates }
                    };
                    const colRef = collection(db, 'intakes', appId, 'medicalTravel');
                    const docRef = await addDoc(colRef, baseData);

                    // Upload files (if any)
                    const uploaded = [];
                    const files = (filesInput && filesInput.files) ? Array.from(filesInput.files) : [];
                    for (const file of files) {
                        const path = `reports/medicalTravel/${docRef.id}/${encodeURIComponent(file.name)}`;
                        const sRef = storageRef(storage, path);
                        await uploadBytes(sRef, file, { contentType: file.type || 'application/octet-stream' });
                        const url = await getDownloadURL(sRef);
                        uploaded.push({ name: file.name, url, contentType: file.type || '', size: file.size || 0 });
                    }
                    if (uploaded.length) {
                        await setDoc(docRef, { files: uploaded }, { merge: true });
                    }

                    showNotification('تم استلام طلب تنسيق السفر الطبي بنجاح.', 'success');
                    resultDiv.innerHTML = `<div class="p-3 bg-green-50 border-r-4 border-green-500 rounded">تم تسجيل الطلب برقم: <strong>${docRef.id}</strong>. سيتواصل فريقنا معك.</div>`;
                    form.reset();
                } catch (error) {
                    console.error('Medical Travel submit error:', error);
                    showNotification('حدث خطأ أثناء إرسال الطلب. حاول مرة أخرى.', 'error');
                    resultDiv.innerHTML = `<p class="text-red-600">تعذر إرسال الطلب: ${error.message}</p>`;
                } finally {
                    // Restore UI
                    const submitBtn = document.getElementById('mt-submit');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'إرسال الطلب';
                    }
                    form.classList.remove('is-submitting');
                }
            });
        }

        function initSecondOpinion() {
            const form = document.getElementById('second-opinion-form');
            if (!form) return;
            const filesInput = document.getElementById('so-files');
            const resultDiv = document.getElementById('so-result');

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const fullname = document.getElementById('so-fullname').value.trim();
                const phone = document.getElementById('so-phone').value.trim();
                const email = document.getElementById('so-email').value.trim();
                const region = document.getElementById('so-region').value;
                const summary = document.getElementById('so-summary').value.trim();
                const questions = document.getElementById('so-questions').value.trim();

                if (!fullname || !phone || !email || !summary) {
                    showNotification('يرجى تعبئة الحقول المطلوبة.', 'warning');
                    highlightFirstMissing(['so-fullname','so-phone','so-email','so-summary']);
                    return;
                }

                try {
                    // Disable UI and show loading
                    const submitBtn = document.getElementById('so-submit');
                    let prevBtnHTML = '';
                    if (submitBtn) {
                        prevBtnHTML = submitBtn.innerHTML;
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<span class="loading-dots"><span></span><span></span><span></span></span> جاري الإرسال...';
                    }
                    form.classList.add('is-submitting');

                    showNotification('جاري إرسال طلبك...', 'warning');
                    const baseData = {
                        type: 'second-opinion',
                        createdAt: new Date(),
                        status: 'submitted',
                        userUid: currentUser ? currentUser.uid : null,
                        patient: { fullname, phone, email },
                        preference: { region },
                        clinical: { summary, questions }
                    };
                    const colRef = collection(db, 'intakes', appId, 'secondOpinion');
                    const docRef = await addDoc(colRef, baseData);

                    // Upload files (if any)
                    const uploaded = [];
                    const files = (filesInput && filesInput.files) ? Array.from(filesInput.files) : [];
                    for (const file of files) {
                        const path = `reports/secondOpinion/${docRef.id}/${encodeURIComponent(file.name)}`;
                        const sRef = storageRef(storage, path);
                        await uploadBytes(sRef, file, { contentType: file.type || 'application/octet-stream' });
                        const url = await getDownloadURL(sRef);
                        uploaded.push({ name: file.name, url, contentType: file.type || '', size: file.size || 0 });
                    }
                    if (uploaded.length) {
                        await setDoc(docRef, { files: uploaded }, { merge: true });
                    }

                    showNotification('تم استلام طلب الرأي الطبي الثاني بنجاح.', 'success');
                    resultDiv.innerHTML = `<div class="p-3 bg-green-50 border-r-4 border-green-500 rounded">تم تسجيل الطلب برقم: <strong>${docRef.id}</strong>. سنتواصل معك قريباً.</div>`;
                    form.reset();
                } catch (error) {
                    console.error('Second Opinion submit error:', error);
                    showNotification('حدث خطأ أثناء إرسال الطلب. حاول مرة أخرى.', 'error');
                    resultDiv.innerHTML = `<p class="text-red-600">تعذر إرسال الطلب: ${error.message}</p>`;
                } finally {
                    // Restore UI
                    const submitBtn = document.getElementById('so-submit');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = 'إرسال الطلب';
                    }
                    form.classList.remove('is-submitting');
                }
            });
        }

        // --- PDF DOWNLOAD MODULE ---
        async function downloadResultAsPDF(elementId, title) {
            try {
                // Ensure libs are available (lazy-load)
                if (typeof ensurePDFLibs === 'function') {
                    await ensurePDFLibs();
                } else {
                    // Fallback if helper not yet defined
                    if (!window.html2canvas) await loadScript('https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js');
                    if (!(window.jspdf && window.jspdf.jsPDF)) await loadScript('https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js');
                }
                const { jsPDF } = window.jspdf || {};
                const element = document.getElementById(elementId);
                if (!element || !jsPDF || !window.html2canvas) return;
                showNotification("جاري إعداد ملف الـ PDF...", 'warning', 2000);
                const canvas = await window.html2canvas(element, { scale: 2, useCORS: true });
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                pdf.setProperties({ title: `تقرير ${title} - د. عمر العماد`, author: 'موقع د. عمر العماد - TibraSoul' });
                const pdfWidth = pdf.internal.pageSize.getWidth();
                pdf.addImage(imgData, 'PNG', 10, 10, pdfWidth - 20, 0);
                pdf.save(`${title.replace(/\s+/g, '-')}_${new Date().toISOString().split('T')[0]}.pdf`);
            } catch (e) {
                console.error('PDF export failed:', e);
                showNotification("تعذر إنشاء ملف PDF. حاول مجدداً.", 'error', 2500);
            }
        }

        // --- FREQUENCY GENERATOR MODULE (ROBUST & UPGRADED) ---
        async function initFrequencyGenerator() {
            await ensureTone();
            const audioPrompt = document.getElementById('audio-init-prompt');
            const startAudioBtn = document.getElementById('start-audio-btn');
            const playerContainer = document.getElementById('frequency-player-container');
            const stopFreqBtn = document.getElementById('stop-freq-btn');
            const canvas = document.getElementById('frequency-canvas');
            const musicPlayer = document.getElementById('background-music');
            const musicPlayPauseBtn = document.getElementById('music-play-pause-btn');
            const musicVolumeSlider = document.getElementById('music-volume');

            if (!startAudioBtn || !playerContainer) return;

            let audioContext, oscillator, analyser, gainNode, animationFrameId;
            let isAudioInitialized = false;
            const canvasCtx = canvas.getContext('2d');
            
            const allFreqButtons = document.querySelectorAll('.freq-btn');

            const setupAudioSystem = async () => {
                if (isAudioInitialized) return true;
                try {
                    await Tone.start();
                    audioContext = Tone.context;
                    analyser = new Tone.Analyser('waveform', 1024);
                    gainNode = new Tone.Gain(0.5).toDestination();
                    isAudioInitialized = true;
                    console.log("Audio Context is ready.");
                    audioPrompt.classList.add('hidden');
                    playerContainer.classList.remove('hidden');
                    return true;
                } catch (e) {
                    console.error("Could not start Audio Context: ", e);
                    showNotification("لا يمكن تشغيل الصوت. يرجى التفاعل مع الصفحة أولاً.", "error");
                    return false;
                }
            };
            
            startAudioBtn.addEventListener('click', setupAudioSystem);

            const playFrequency = (freq) => {
                if (!isAudioInitialized) return;
                
                musicPlayer.pause();
                musicPlayPauseBtn.innerHTML = '<i class="fas fa-play"></i>';

                if (oscillator) {
                    oscillator.disconnect();
                    oscillator.stop();
                }

                oscillator = new Tone.Oscillator(freq, "sine").connect(analyser).connect(gainNode);
                oscillator.volume.value = -9;
                oscillator.start();
                
                stopFreqBtn.classList.remove('hidden');
                if (!animationFrameId) visualize();
            };
            
            const stopFrequency = () => {
                if (oscillator) {
                    oscillator.stop();
                    oscillator.disconnect();
                    oscillator = null;
                }
                stopFreqBtn.classList.add('hidden');
                allFreqButtons.forEach(b => b.classList.remove('active'));
            };
            
            function visualize() {
                const draw = () => {
                    animationFrameId = requestAnimationFrame(draw);
                    if (!analyser || !oscillator) {
                       canvasCtx.clearRect(0, 0, canvas.width, canvas.height);
                       return;
                    };
                    const waveform = analyser.getValue();
                    canvasCtx.fillStyle = '#121212';
                    canvasCtx.fillRect(0, 0, canvas.width, canvas.height);
                    canvasCtx.lineWidth = 2;
                    canvasCtx.strokeStyle = 'rgb(200, 160, 125, 0.7)';
                    canvasCtx.beginPath();
                    
                    for (let i = 0; i < waveform.length; i++) {
                        const x = (i / (waveform.length -1)) * canvas.width;
                        const y = (waveform[i] + 1) / 2 * canvas.height;
                        if (i === 0) canvasCtx.moveTo(x, y);
                        else canvasCtx.lineTo(x, y);
                    }
                    canvasCtx.stroke();
                };
                draw();
            }
            
            allFreqButtons.forEach(button => {
                 button.addEventListener('click', async (e) => {
                    if (!isAudioInitialized) {
                       const audioReady = await setupAudioSystem();
                       if (!audioReady) return;
                    }
                    allFreqButtons.forEach(b => b.classList.remove('active'));
                    button.classList.add('active');
                    const freq = parseFloat(button.dataset.freq);
                    playFrequency(freq);
                });
            });
            
            stopFreqBtn.addEventListener('click', stopFrequency);
            
            // Music Player Logic
            musicPlayPauseBtn.addEventListener('click', () => {
                if (!isAudioInitialized) return;
                if (musicPlayer.paused) {
                    stopFrequency();
                    musicPlayer.play();
                    musicPlayPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                } else {
                    musicPlayer.pause();
                    musicPlayPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                }
            });
            musicVolumeSlider.addEventListener('input', (e) => {
                musicPlayer.volume = e.target.value;
            });
        }

        // --- BLOG MODULE ---
        function initBlog() {
            const blogGrid = document.getElementById('blog-grid');
            const searchInput = document.getElementById('blog-search');
            const catBtns = document.querySelectorAll('.blog-cat-btn');
            const relatedContainer = document.getElementById('related-posts');
            const featuredWrap = document.getElementById('featured-post');
            const featuredImg = document.getElementById('featured-image');
            const featuredCat = document.getElementById('featured-cat');
            const featuredTitle = document.getElementById('featured-title');
            const featuredExcerpt = document.getElementById('featured-excerpt');
            const featuredRead = document.getElementById('featured-read');
            if (!blogGrid) return;

            const posts = [
                {
                    id: 'gut-brain',
                    title: 'هل أمعاؤك هي سبب تقلبات مزاجك؟',
                    image: 'https://images.unsplash.com/photo-1498837167922-ddd27525d352?q=80&w=2070&auto=format&fit=crop',
                    category: 'nutrition',
                    date: '2025-09-20',
                    excerpt: 'اكتشف العلاقة المدهشة بين صحة الجهاز الهضمي وصحتك النفسية.',
                    content: `
                        <h2>العلاقة الخفية بين القناة الهضمية والدماغ</h2>
                        <p>هل تعلم أن أمعاءك يُطلق عليها "الدماغ الثاني"؟ يوجد اتصال ثنائي الاتجاه بين الدماغ والجهاز الهضمي (محور الأمعاء-الدماغ) يؤثر في المزاج والرفاه.</p>
                        <h2>كيف تدعم هذا المحور الهام؟</h2>
                        <ul>
                            <li><strong>ألياف:</strong> خضروات، فواكه، بقول.</li>
                            <li><strong>أطعمة مخمرة:</strong> زبادي، كفير، مخلل ملفوف.</li>
                            <li><strong>تقليل السكر والمصنع:</strong> للحد من الالتهاب.</li>
                            <li><strong>إدارة الإجهاد:</strong> تنفس وتأمل ويوجا.</li>
                        </ul>
                        <p>ابدأ بخطوة صغيرة اليوم؛ صحة أمعائك ترتبط مباشرة بصفاء ذهنك.</p>
                    `
                },
                {
                    id: 'breathing',
                    title: 'قوة التنفس: كيف تهدئ جهازك العصبي في 5 دقائق',
                    image: 'https://images.unsplash.com/photo-1599301934984-1d2741913a5f?q=80&w=2070&auto=format&fit=crop',
                    category: 'mind',
                    date: '2025-09-25',
                    excerpt: 'تقنية Box Breathing لخفض التوتر سريعاً.',
                    content: `
                        <h2>أقوى أداة لتنظيم الحالة العصبية</h2>
                        <p>التنفس العميق ينشّط الجهاز اللاودي ويخفّض التوتر بسرعة.</p>
                        <h2>Box Breathing</h2>
                        <ul>
                            <li>شهيق 4 — حبس 4 — زفير 4 — حبس 4 (3-5 دقائق).</li>
                        </ul>
                    `
                },
                {
                    id: 'supplements',
                    title: 'أفضل 3 مكملات غذائية لمكافحة الالتهابات',
                    image: 'https://images.unsplash.com/photo-1476837579993-f1d3948f17c2?q=80&w=2070&auto=format&fit=crop',
                    category: 'supplements',
                    date: '2025-09-28',
                    excerpt: 'اختيارات فعالة لخفض الالتهاب المزمن.',
                    content: `
                        <h2>التهاب مزمن: ما العمل؟</h2>
                        <ul>
                            <li>الكركمين + بيبرين.</li>
                            <li>أوميغا-3.</li>
                            <li>مغنيسيوم.</li>
                        </ul>
                        <p><strong>تنبيه:</strong> راجع طبيبك قبل أي مكمل جديد.</p>
                    `
                }
            ];

            function renderGrid(cat = 'all', q = '') {
                const norm = (s) => (s || '').toLowerCase();
                const nq = norm(q);
                const filtered = posts.filter(p => (cat === 'all' || p.category === cat) && (!nq || norm(p.title).includes(nq) || norm(p.excerpt).includes(nq)));
                blogGrid.innerHTML = filtered.map(p => `
                    <div class="bg-white rounded-lg overflow-hidden shadow-lg hover:shadow-2xl transition-all duration-300 fade-in-up hover:-translate-y-2">
                        <img src="${p.image}" alt="${p.title}" loading="lazy" decoding="async" class="w-full h-56 object-cover">
                        <div class="p-6 text-right">
                            <p class="text-xs text-gray-500 mb-1">${catLabel(p.category)} · ${readingTime(p.content)}</p>
                            <h3 class="text-xl font-bold mb-2">${p.title}</h3>
                            <p class="text-gray-600 mb-4">${p.excerpt}</p>
                            <a href="#" class="read-more-btn font-bold text-[--primary-color] hover:underline" data-postid="${p.id}">اقرأ المزيد &larr;</a>
                        </div>
                    </div>`).join('');
            }

            function openPost(id) {
                const post = posts.find(p => p.id === id);
                if (!post) return;
                document.getElementById('post-title').textContent = post.title;
                const imgEl = document.getElementById('post-image');
                imgEl.src = post.image; imgEl.alt = post.title; imgEl.loading = 'lazy'; imgEl.decoding = 'async';
                document.getElementById('post-content').innerHTML = post.content;
                // Meta
                const metaEl = document.getElementById('post-meta');
                if (metaEl) {
                    const dateStr = post.date ? new Date(post.date).toLocaleDateString('ar-YE') : '';
                    metaEl.innerHTML = `
                        <span class="px-2 py-0.5 bg-gray-100 rounded-full">${catLabel(post.category)}</span>
                        ${dateStr ? `<span>${dateStr}</span>` : ''}
                        <span>${readingTime(post.content)}</span>`;
                }
                // Related posts
                if (relatedContainer) {
                    const related = posts.filter(p => p.id !== id && p.category === post.category).slice(0, 2);
                    relatedContainer.innerHTML = related.map(p => `
                        <div class="bg-white rounded-lg overflow-hidden shadow border">
                            <img src="${p.image}" alt="${p.title}" loading="lazy" decoding="async" class="w-full h-28 object-cover">
                            <div class="p-3 text-right">
                                <h4 class="font-bold text-sm mb-1">${p.title}</h4>
                                <a href="#" class="read-more-btn text-[--primary-color] font-semibold text-sm" data-postid="${p.id}">اقرأ المقال &larr;</a>
                            </div>
                        </div>`).join('');
                }
                // Share links
                const base = window.location.origin + window.location.pathname;
                const shareText = encodeURIComponent(post.title + ' — ' + base);
                const shareUrl = encodeURIComponent(base);
                const w = document.getElementById('share-whatsapp'); if (w) w.href = `https://wa.me/?text=${shareText}`;
                const f = document.getElementById('share-facebook'); if (f) f.href = `https://www.facebook.com/sharer/sharer.php?u=${shareUrl}`;
                const x = document.getElementById('share-x'); if (x) x.href = `https://twitter.com/intent/tweet?text=${shareText}`;
                showView('single-post');
            }

            // Event delegation for opening posts
            blogGrid.addEventListener('click', (e) => {
                const a = e.target.closest('.read-more-btn');
                if (!a) return;
                e.preventDefault();
                openPost(a.dataset.postid);
            });
            relatedContainer?.addEventListener('click', (e) => {
                const a = e.target.closest('.read-more-btn');
                if (!a) return;
                e.preventDefault();
                openPost(a.dataset.postid);
            });

            // Filters
            function activeCat() {
                const btn = Array.from(catBtns).find(b => b.getAttribute('aria-selected') === 'true');
                return btn ? btn.dataset.cat : 'all';
            }
            catBtns.forEach(btn => btn.addEventListener('click', () => {
                catBtns.forEach(x => x.setAttribute('aria-selected', 'false'));
                btn.setAttribute('aria-selected', 'true');
                renderGrid(activeCat(), searchInput?.value?.trim() || '');
            }));
            searchInput?.addEventListener('input', () => {
                renderGrid(activeCat(), searchInput.value.trim());
            });

            // Initial render
            renderGrid('all', '');

            // Featured hero: pick latest by date or first
            if (featuredWrap && featuredImg && featuredRead) {
                const sorted = posts.slice().sort((a,b) => (new Date(b.date||0)) - (new Date(a.date||0)));
                const feat = sorted[0] || posts[0];
                if (feat) {
                    featuredImg.src = feat.image;
                    featuredTitle.textContent = feat.title;
                    featuredExcerpt.textContent = feat.excerpt;
                    featuredCat.textContent = catLabel(feat.category) + ' · ' + readingTime(feat.content);
                    featuredRead.dataset.postid = feat.id;
                    featuredWrap.classList.remove('hidden');
                }
                featuredRead.addEventListener('click', (e) => {
                    e.preventDefault();
                    openPost(featuredRead.dataset.postid);
                });
            }
        }

        // --- WHEEL OF LIFE MODULE ---
        async function initWheelOfLife() {
            await ensureChart();
            const ctx = document.getElementById('wheel-of-life-chart');
            if (!ctx) return;
            const slidersContainer = document.getElementById('wheel-of-life-sliders');
            const getInsightBtn = document.getElementById('get-wheel-insight-btn');
            
            const labels = ['الصحة الجسدية', 'النمو الشخصي', 'الحياة المهنية', 'المالية', 'البيئة المحيطة', 'المرح والاستجمام', 'العلاقات الأسرية والاجتماعية', 'الحياة الروحية'];
            const initialData = Array(labels.length).fill(5);
            
            slidersContainer.innerHTML = labels.map((label, index) => `
                <div class="flex items-center gap-4">
                    <label for="slider-${index}" class="w-1/3 text-right">${label}</label>
                    <input type="range" id="slider-${index}" min="0" max="10" value="5" class="range-slider flex-grow" data-index="${index}">
                    <span id="value-${index}" class="w-8 text-center font-bold">5</span>
                </div>`).join('');
            
            wheelChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'تقييمي الحالي',
                        data: initialData,
                        fill: true,
                        backgroundColor: hexToRgba(cssVar('--accent-color') || '#2DD4BF', 0.35),
                        borderColor: cssVar('--primary-color') || '#1F6FEB',
                        pointBackgroundColor: cssVar('--primary-color') || '#1F6FEB',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: cssVar('--primary-color') || '#1F6FEB'
                    }]
                },
                options: {
                    elements: { line: { borderWidth: 3 } },
                    scales: {
                        r: {
                            angleLines: { color: hexToRgba(cssVar('--primary-dark') || '#0F4CA8', 0.25) },
                            grid: { color: hexToRgba(cssVar('--primary-dark') || '#0F4CA8', 0.25) },
                            pointLabels: { font: { family: "'Noto Kufi Arabic', sans-serif", size: 13 }, color: cssVar('--text-dark') || '#222' },
                            ticks: { backdropColor: 'var(--secondary-color)', color: '#555', stepSize: 2 },
                            suggestedMin: 0,
                            suggestedMax: 10
                        }
                    },
                    plugins: { legend: { display: false } }
                }
            });

            slidersContainer.addEventListener('input', (e) => {
                if (e.target.type === 'range') {
                    const index = e.target.dataset.index;
                    const value = e.target.value;
                    document.getElementById(`value-${index}`).textContent = value;
                    wheelChart.data.datasets[0].data[index] = value;
                    wheelChart.update();
                }
            });
            
            getInsightBtn.addEventListener('click', getWheelInsight);
        }
        
        async function getWheelInsight() {
            const resultDiv = document.getElementById('wheel-of-life-result');
            const data = wheelChart.data.datasets[0].data;
            const labels = wheelChart.data.labels;
            
            resultDiv.classList.remove('hidden');
            resultDiv.style.opacity = '0';
            
            let userInput = "User's Wheel of Life scores are: ";
            labels.forEach((label, index) => {
                userInput += `${label}: ${data[index]}/10, `;
            });

            const prompt = `Act as a wise and compassionate holistic life coach. Based on the user's Wheel of Life scores: [${userInput}]. Your task is to:
1.  Identify the top 2-3 highest scoring areas and acknowledge them as strengths.
2.  Identify the top 2-3 lowest scoring areas and frame them as opportunities for growth, not failures.
3.  Provide one insightful, holistic observation about the potential interplay between the high and low areas (e.g., "I notice your career score is high, but your health is low. Perhaps your professional success is coming at the expense of your physical wellbeing?").
4.  Offer one simple, actionable first step for one of the lowest areas.
5.  End with an encouraging and empowering message.
The entire response should be in warm, supportive Arabic. Start with a positive affirmation. Use markdown for lists and bolding.`;
            
            const insightText = await handleApiRequest(prompt, 'wheel-of-life-result', GEMINI_API_KEY);

            if (insightText) {
                resultDiv.innerHTML = `
                    <div id="wheel-result-content" class="text-right whitespace-pre-wrap">${insightText}</div>
                    <div class="mt-4 text-center">
                        ${currentUser ? '<button id="save-wheel-result-btn" class="btn btn-secondary py-2 px-4 rounded-full text-sm">حفظ النتيجة في ملفي</button>' : '<p class="text-sm text-gray-500">سجل الدخول لحفظ هذه الرؤى القيمة!</p>'}
                    </div>`;
                if(currentUser) {
                    document.getElementById('save-wheel-result-btn').addEventListener('click', () => {
                        const fullResultText = `--- تقييم عجلة العافية ---\n${userInput}\n\n--- رؤى التحليل ---\n${insightText}`;
                        saveResultToFirestore("تحليل عجلة العافية", fullResultText);
                    });
                }
            }
            resultDiv.style.opacity = '1';
        }
        
        // --- AUDIO PLAYER MODULE ---
        function initAudioPlayer() {
             const audio = document.getElementById('guided-audio');
            if(!audio) return;
            const playPauseBtn = document.getElementById('audio-play-pause-btn');
            const playIcon = playPauseBtn.querySelector('i');
            const progressBar = document.getElementById('audio-progress-bar');
            const timeDisplay = document.getElementById('audio-time');
            const totalDuration = 60; // 1 minute

            const formatTime = (seconds) => {
                const minutes = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${String(minutes).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
            };

            playPauseBtn.addEventListener('click', () => {
                if (audio.paused) {
                    audio.play();
                    playIcon.classList.replace('fa-play-circle', 'fa-pause-circle');
                } else {
                    audio.pause();
                    playIcon.classList.replace('fa-pause-circle', 'fa-play-circle');
                }
            });

            audio.addEventListener('timeupdate', () => {
                const progress = (audio.currentTime / audio.duration) * 100;
                progressBar.value = progress;
                timeDisplay.textContent = `${formatTime(audio.currentTime)} / ${formatTime(totalDuration)}`;
            });

            audio.addEventListener('ended', () => {
                playIcon.classList.replace('fa-pause-circle', 'fa-play-circle');
                progressBar.value = 0;
                timeDisplay.textContent = `00:00 / ${formatTime(totalDuration)}`;
            });

            progressBar.addEventListener('input', () => {
                const seekTime = (progressBar.value / 100) * audio.duration;
                audio.currentTime = seekTime;
            });
        }

        // --- GENERAL UI & CREATIVE EFFECTS ---
        function initGeneralUI() {
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            let lastFocused = null;
            function setMenuOpen(open) {
                if (!mobileMenu || !mobileMenuButton) return;
                mobileMenu.classList.toggle('hidden', !open);
                mobileMenuButton.setAttribute('aria-expanded', open ? 'true' : 'false');
                if (open) {
                    lastFocused = document.activeElement;
                    const firstLink = mobileMenu.querySelector('.nav-link');
                    try { firstLink?.focus(); } catch {}
                } else {
                    try { lastFocused?.focus(); } catch {}
                }
            }
            if (mobileMenuButton) {
                mobileMenuButton.addEventListener('click', () => setMenuOpen(mobileMenu?.classList.contains('hidden')));
            }
            if (mobileMenu) {
                mobileMenu.addEventListener('click', (e) => { 
                    if(e.target.classList.contains('nav-link') || e.target.closest('.nav-link')){
                         setMenuOpen(false);
                    }
                });
            }
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') setMenuOpen(false);
            });

            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) entry.target.classList.add('is-visible');
                });
            }, { threshold: 0.1 });
            document.querySelectorAll('.fade-in-up').forEach(el => observer.observe(el));
            
            // Back to top button
            const backToTopBtn = document.getElementById('back-to-top-btn');
            if (backToTopBtn) {
                window.addEventListener('scroll', () => {
                    backToTopBtn.classList.toggle('hidden', window.scrollY < 300);
                }, { passive: true });
                backToTopBtn.addEventListener('click', () => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            }

            // Compact header and Smart CTA toggle on scroll
            const headerEl = document.querySelector('header');
            const heroView = document.getElementById('view-hero');
            const smartCTA = document.getElementById('smart-cta');
            function applyScrollUI() {
                const y = window.scrollY || 0;
                // Header compact style
                if (headerEl) headerEl.classList.toggle('scrolled', y > 12);
                // Smart CTA only on mobile contexts and when not on hero
                if (smartCTA) {
                    const notHero = typeof currentViewId === 'string' ? (currentViewId !== 'hero') : true;
                    const show = y > 360 && notHero;
                    smartCTA.classList.toggle('hidden', !show);
                }
            }
            window.addEventListener('scroll', applyScrollUI, { passive: true });
            setTimeout(applyScrollUI, 50);
        }

        function initAccessibility() {
            const panel = document.getElementById('a11y-panel');
            const openBtn = document.getElementById('a11y-open-btn');
            const closeBtn = document.getElementById('a11y-close-btn');
            const incBtn = document.getElementById('font-inc-btn');
            const decBtn = document.getElementById('font-dec-btn');
            const label = document.getElementById('font-scale-label');
            const hcToggle = document.getElementById('hc-toggle');
            const dysToggle = document.getElementById('dys-toggle');
            let scale = parseFloat(localStorage.getItem('a11yFontScale')) || 1;
            const hc = localStorage.getItem('a11yHighContrast') === '1';
            const dys = localStorage.getItem('a11yDys') === '1';
            function applyScale(v) {
                v = Math.max(0.9, Math.min(1.6, v));
                scale = v;
                document.documentElement.style.fontSize = `${Math.round(v*100)}%`;
                if (label) label.textContent = `${Math.round(v*100)}%`;
                localStorage.setItem('a11yFontScale', String(v));
            }
            function applyHC(flag) {
                document.body.classList.toggle('a11y-hc', flag);
                localStorage.setItem('a11yHighContrast', flag ? '1' : '0');
                if (hcToggle) hcToggle.checked = flag;
            }
            function applyDys(flag) {
                document.body.classList.toggle('a11y-dys', flag);
                localStorage.setItem('a11yDys', flag ? '1' : '0');
                if (dysToggle) dysToggle.checked = flag;
            }
            applyScale(scale);
            applyHC(hc);
            applyDys(dys);
            function openPanel() {
                if (!panel) return;
                panel.classList.remove('hidden');
                openBtn?.setAttribute('aria-expanded', 'true');
                panel.setAttribute('aria-modal', 'false');
                try { panel.focus(); } catch {}
            }
            function closePanel() {
                if (!panel) return;
                panel.classList.add('hidden');
                openBtn?.setAttribute('aria-expanded', 'false');
                openBtn?.focus();
            }
            openBtn?.addEventListener('click', () => panel?.classList.contains('hidden') ? openPanel() : closePanel());
            closeBtn?.addEventListener('click', closePanel);
            incBtn?.addEventListener('click', () => applyScale(scale + 0.1));
            decBtn?.addEventListener('click', () => applyScale(scale - 0.1));
            hcToggle?.addEventListener('change', (e) => applyHC(e.target.checked));
            dysToggle?.addEventListener('change', (e) => applyDys(e.target.checked));
            document.addEventListener('keydown', (e) => {
                if (e.altKey && e.shiftKey && (e.key === 'A' || e.key === 'a')) {
                    e.preventDefault();
                    panel?.classList.contains('hidden') ? openPanel() : closePanel();
                }
                if (e.key === 'Escape' && panel && !panel.classList.contains('hidden')) {
                    e.preventDefault();
                    closePanel();
                }
            });
        }

        function initCreativeEffects() {
            const cards = document.querySelectorAll('.dashboard-card');
            cards.forEach(card => {
                card.addEventListener('mousemove', (e) => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const rotateX = ((y - card.offsetHeight / 2) / (card.offsetHeight / 2)) * -5;
                    const rotateY = ((x - card.offsetWidth / 2) / (card.offsetWidth / 2)) * 5;
                    card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1.05, 1.05, 1.05)`;
                });
                card.addEventListener('mouseleave', () => {
                    card.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) scale3d(1, 1, 1)';
                });
            });
            document.querySelectorAll('.btn').forEach(button => {
                button.addEventListener('click', function(e) {
                     const rect = this.getBoundingClientRect();
                     const ripple = document.createElement('span');
                     const d = Math.max(this.clientWidth, this.clientHeight);
                     ripple.style.width = ripple.style.height = d + 'px';
                     ripple.style.left = e.clientX - rect.left - d/2 + 'px';
                     ripple.style.top = e.clientY - rect.top - d/2 + 'px';
                     ripple.classList.add('ripple');
                     this.appendChild(ripple);
                     setTimeout(() => ripple.remove(), 600);
                });
            });
        }

        // --- BODY MAP MODULE (SVG UPGRADE) ---
        function initBodyMap() {
            const infoContainer = document.getElementById('body-map-info');
            const organNameEl = document.getElementById('organ-name');
            const organDetailsEl = document.getElementById('organ-details');
            const organPaths = document.querySelectorAll('#body-map-svg .organ-path');
            const tooltip = document.getElementById('body-map-tooltip');
            const searchEl = document.getElementById('body-map-search');
            const chipEls = document.querySelectorAll('.body-map-toolbar .chip');
            const svgContainer = document.getElementById('body-map-svg-container');
            const container3D = document.getElementById('body-map-3d-container');
            const model3D = document.getElementById('body-model-3d');
            const modeBtns = document.querySelectorAll('.body-map-toolbar .segmented-control [data-mode]');
            const hotspotBtns = document.querySelectorAll('#body-map-3d-container .hotspot-btn');
            const model3DError = document.getElementById('body-map-3d-error');
            const refToggle = document.getElementById('anatomy-ref-toggle');
            const refEl = document.getElementById('anatomy-ref');
            let modelFallbackTried = false;
            if (!infoContainer) return;
            // Ensure 3D component is available when needed
            try { ensureModelViewer(); } catch {}
            
            window.organData = {
                brain: {
                    name: 'الدماغ والجهاز العصبي',
                    emotionalCause: 'صراعات فكرية مستمرة، رفض أو مقاومة الأفكار الجديدة، الشعور بالانفصال عن الحدس الداخلي.',
                    associatedDiseases: 'الصداع النصفي، الزهايمر، باركنسون، الجلطات، الأورام، ضبابية الدماغ.',
                    holisticAdvice: 'مارس التأمل لتصفية الذهن، تعلم تقنيات التنفس لتهدئة الجهاز العصبي، اكتب أفكارك لتحريرها، ثق بحدسك أكثر.',
                    category: 'neuro',
                    keywords: ['دماغ','عصبي','صداع','تشنج','ذاكرة','قلق','توتر']
                },
                thyroid: {
                    name: 'الغدة الدرقية',
                    emotionalCause: 'الشعور بالإذلال، عدم القدرة على التعبير عن الذات، الشعور بأن دورك لم يأت بعد، كبت الإبداع.',
                    associatedDiseases: 'خمول أو فرط نشاط الغدة، تضخم الغدة، مرض هاشيموتو، مرض جريفز.',
                    holisticAdvice: 'تحدث عن حقيقتك، مارس هواية إبداعية (رسم، كتابة، غناء)، قل "لا" عند الحاجة، حرر رقبتك وكتفيك من خلال التمارين.',
                    category: 'endocrine',
                    keywords: ['درقية','هرمونات','سيلان','وزن','طاقة']
                },
                heart: {
                    name: 'القلب',
                    emotionalCause: 'نقص الفرح والحب، جروح عاطفية قديمة، الشعور بالوحدة، النقد الذاتي القاسي.',
                    associatedDiseases: 'ارتفاع ضغط الدم، النوبات القلبية، عدم انتظام ضربات القلب, أمراض الشرايين.',
                    holisticAdvice: 'مارس الامتنان يومياً، سامح نفسك والآخرين، اقض وقتاً في الطبيعة، تواصل مع الأصدقاء والأحباء، احتضن أكثر.',
                    category: 'cardio',
                    keywords: ['قلب','ضغط','شرايين','خفقان','ألم صدر']
                },
                liver: {
                    name: 'الكبد',
                    emotionalCause: 'الغضب المكبوت، المرارة، الاستياء المزمن، الخوف من النقص والفقر.',
                    associatedDiseases: 'تليف الكبد، الكبد الدهني، التهاب الكبد، حصوات المرارة، مشاكل جلدية.',
                    holisticAdvice: 'تعلم تقنيات صحية للتعبير عن الغضب (مثل الكتابة أو الرياضة)، مارس التسامح، ركز على الوفرة بدلاً من النقص، تناول الأطعمة المرة (جرجير، هندباء).',
                    category: 'digestive',
                    keywords: ['كبد','مرارة','سموم','غضب','حبوب']
                },
                gut: {
                    name: 'الأمعاء (الجهاز الهضمي)',
                    emotionalCause: 'عدم القدرة على "هضم" أو تقبل مواقف الحياة، التمسك بالماضي، القلق المفرط بشأن المستقبل.',
                    associatedDiseases: 'القولون العصبي، كرونز، التهاب القولون التقرحي، الإمساك/الإسهال المزمن، الحساسيات الغذائية.',
                    holisticAdvice: 'مارس اليقظة الذهنية أثناء تناول الطعام، تعلم التخلي عما لا يمكنك التحكم فيه، اكتب مخاوفك على ورق، تناول البروبيوتيك لدعم "عقلك الثاني".',
                    category: 'digestive',
                    keywords: ['أمعاء','قولون','نفخة','هضم','غذاء']
                },
                adrenals: {
                    name: 'الغدد الكظرية',
                    emotionalCause: 'الإجهاد المزمن، الشعور بأنك في وضع "النجاة" باستمرار، عدم الشعور بالأمان، تحمل مسؤوليات تفوق طاقتك.',
                    associatedDiseases: 'الإرهاق الكظري، متلازمة التعب المزمن، مشاكل النوم، القلق.',
                    holisticAdvice: 'ضع حدوداً صحية، تعلم قول "لا"، خصص وقتاً يومياً للاسترخاء التام (بدون شاشات)، قلل من الكافيين، مارس التأمل أو اليوجا التصالحية.',
                    category: 'adrenal',
                    keywords: ['كظر','إجهاد','كورتيزول','تعب','توتر']
                },
                kidneys: {
                    name: 'الكلى',
                    emotionalCause: 'الخوف العميق، مشاكل في العلاقات والشراكات، الشعور بخيبة الأمل والنقد.',
                    associatedDiseases: 'حصوات الكلى، الفشل الكلوي، التهابات المسالك البولية المتكررة.',
                    holisticAdvice: 'واجه مخاوفك بدلاً من الهروب منها، قيم علاقاتك وابنِ روابط صحية، اشرب كمية كافية من الماء بنية التطهير، مارس تقنيات التأريض.',
                    category: 'adrenal',
                    keywords: ['كلى','بول','حصى','خوف','سائل']
                },
                lungs: {
                    name: 'الرئتان',
                    emotionalCause: 'الحزن العميق أو الإحساس بالاختناق من القيود، صعوبة “أخذ نفس” من الحياة.',
                    associatedDiseases: 'الربو، العدوى التنفسية، الانسداد الرئوي، الحساسية، ضيق التنفس.',
                    holisticAdvice: 'تمارين تنفس عميق، تعرض للشمس والهواء النقي، معالجة الحزن بالكتابة والبكاء الصحي، زيوت عطرية كالكافور.',
                    category: 'respiratory',
                    keywords: ['رئة','تنفسي','ضيق','سعال','أكسجين','صدر']
                },
                stomach: {
                    name: 'المعدة',
                    emotionalCause: 'القلق والتوتر المزمن، صعوبة تقبّل المواقف الجديدة، “هضم” الخبرات الثقيلة.',
                    associatedDiseases: 'حموضة، قرحة، عسر هضم، غثيان.',
                    holisticAdvice: 'الأكل بوعي وببطء، تقليل الكافيين والسكّر، شاي الزنجبيل/النعناع، كتابة المخاوف قبل النوم.',
                    category: 'digestive',
                    keywords: ['معدة','حموضة','قرحة','غثيان','هضم']
                },
                pancreas: {
                    name: 'البنكرياس',
                    emotionalCause: 'مرارة داخلية أو إحباط من “حلاوة الحياة”، ضغط حول السيطرة والتنظيم.',
                    associatedDiseases: 'اختلال سكر الدم، السكري النوع الثاني، التهاب البنكرياس.',
                    holisticAdvice: 'تنظيم السكر والوجبات، موازنة العمل والراحة، ممارسة الامتنان يومياً.',
                    category: 'digestive',
                    keywords: ['بنكرياس','سكر','أنسولين','حلاوة','تنظيم']
                },
                spleen: {
                    name: 'الطحال (مناعة)',
                    emotionalCause: 'إحساس بالضعف أو عدم الحماية، اجترار الأفكار والقلق.',
                    associatedDiseases: 'تضخم الطحال، ضعف المناعة، العدوى المتكررة.',
                    holisticAdvice: 'تعزيز المناعة بالغذاء الكامل والنوم الجيد، تهدئة العقل بالتأمل والمشي.',
                    category: 'digestive',
                    keywords: ['طحال','مناعة','عدوى','حماية']
                },
                bladder: {
                    name: 'المثانة',
                    emotionalCause: 'توتر وعدم الأمان، احتباس مشاعر أو حدود غير واضحة.',
                    associatedDiseases: 'التهابات المسالك، تهيّج المثانة، تكرار البول.',
                    holisticAdvice: 'شرب الماء بانتظام، دعم صحة المسالك (التوت البري)، التعبير عن الاحتياجات بوضوح.',
                    category: 'adrenal',
                    keywords: ['مثانة','بول','التهاب','إلحاح']
                },
                reproductive: {
                    name: 'الجهاز التناسلي',
                    emotionalCause: 'قضايا تتعلق بالقيمة الذاتية والعلاقات والحميمية والإبداع.',
                    associatedDiseases: 'اضطرابات الدورة، تكيس المبايض، آلام الحوض، مشاكل البروستاتا.',
                    holisticAdvice: 'رعاية الذات والحدود الصحية، علاج الصدمات اللطيف، الحركة الواعية وتمارين الحوض.',
                    category: 'endocrine',
                    keywords: ['هرمونات','مبايض','رحم','بروستاتا','خصوبة']
                },
                trachea: {
                    name: 'القصبة الهوائية',
                    emotionalCause: 'صعوبة التعبير والتنفس بحرية، شعور بالضغط في الصدر أو الخوف.',
                    associatedDiseases: 'التهاب القصبات، السعال المزمن، تضيق القصبة.',
                    holisticAdvice: 'تمارين تنفّس وتمطيط للصدر، تخفيف المهيّجات، تهدئة الجهاز العصبي.',
                    category: 'respiratory',
                    keywords: ['قصبة','هوائية','سعال','تنفس']
                },
                esophagus: {
                    name: 'المريء',
                    emotionalCause: 'صعوبة “ابتلاع” مواقف الحياة، توتر مزمن، استعجال.',
                    associatedDiseases: 'ارتجاع مريئي، التهاب مريء، صعوبة بلع.',
                    holisticAdvice: 'إبطاء وتيرة الأكل، تقليل الأطعمة المهيّجة، إدارة التوتر، الامتناع عن الأكل قبل النوم.',
                    category: 'digestive',
                    keywords: ['مريء','ارتجاع','حرقة','بلع']
                },
                diaphragm: {
                    name: 'الحجاب الحاجز',
                    emotionalCause: 'حبس النفس تحت التوتر، عدم السماح “بالتنفس” وسط الضغوط.',
                    associatedDiseases: 'تشنج حجاب حاجز، حموضة مترافقة، ألم صدري وظيفي.',
                    holisticAdvice: 'تنفّس بطني عميق، استرخاء تدريجي، إطلاق التوتر العاطفي.',
                    category: 'respiratory',
                    keywords: ['حجاب','تنفّس','صدر','تشنج']
                },
                small_intestine: {
                    name: 'الأمعاء الدقيقة',
                    emotionalCause: 'حساسية زائدة/فرط تحليل التفاصيل، صعوبة امتصاص “العبر”.',
                    associatedDiseases: 'سوء امتصاص، حساسية جلوتين/سيلياك، فرط نمو بكتيري (SIBO).',
                    holisticAdvice: 'أكل بسيط ونظيف، بروبيوتيك/بريبايوتيك مناسب، تخفيف التوتر.',
                    category: 'digestive',
                    keywords: ['أمعاء دقيقة','امتصاص','SIBO','حساسية']
                },
                colon: {
                    name: 'القولون',
                    emotionalCause: 'التمسّك بالماضي، مقاومة التغيير، قلق على المستقبل.',
                    associatedDiseases: 'قولون عصبي، إمساك/إسهال مزمن، التهاب قولون.',
                    holisticAdvice: 'روتين يومي ثابت، ألياف وماء كافٍ، تفريغ عاطفي آمن.',
                    category: 'digestive',
                    keywords: ['قولون','IBS','إمساك','إسهال','غازات']
                },
                gallbladder: {
                    name: 'المرارة',
                    emotionalCause: 'مرارة مستمرة وصعوبة اتخاذ القرارات، غضب مكبوت.',
                    associatedDiseases: 'حصوات المرارة، التهاب المرارة، عسر هضم دهون.',
                    holisticAdvice: 'إدارة الغضب بلطف، دهون صحية متوازنة، دعم الكبد والألياف.',
                    category: 'digestive',
                    keywords: ['مرارة','حصى','صفرا','دهون']
                },
                prostate: {
                    name: 'البروستاتا',
                    emotionalCause: 'قضايا تتعلق بالرجولة والسلطة والحدود، أو ضغط مزمن غير معبّر عنه.',
                    associatedDiseases: 'التهاب البروستاتا، تضخم البروستاتا الحميد، اضطرابات التبوّل.',
                    holisticAdvice: 'تقليل الجلوس الطويل، دعم صحة الحوض، تخفيف التوتر، غذاء مضاد للالتهاب، مراجعة الطبيب للفحص الدوري.',
                    category: 'endocrine',
                    keywords: ['بروستاتا','تبوّل','تضخم','التهاب']
                },
                uterus_ovaries: {
                    name: 'الرحم والمبايض',
                    emotionalCause: 'قيمة ذاتية وإبداع وأنوثة، قضايا متعلقة بالخصوبة والعلاقات والحدود.',
                    associatedDiseases: 'اضطرابات الدورة، بطانة رحم مهاجرة، تكيس المبايض، آلام حوض.',
                    holisticAdvice: 'رعاية ذاتية لطيفة، معالجة جذرية للصدمات، توازن هرموني غذائي ونومي، حركة واعية وتمارين حوض.',
                    category: 'endocrine',
                    keywords: ['رحم','مبايض','خصوبة','دورة']
                }
            };

            // --- Helpers & UI state ---
            const categoryMeta = {
                cardio: { label: 'قلبي وعائي', color: '#b91c1c' },
                neuro: { label: 'عصبي', color: '#2563eb' },
                respiratory: { label: 'تنفسي', color: '#0ea5e9' },
                digestive: { label: 'هضمي', color: '#059669' },
                endocrine: { label: 'غدد صماء', color: '#a855f7' },
                adrenal: { label: 'كظري/كلوي', color: '#f59e0b' }
            };

            const categoryDefaults = {
                cardio: {
                    symptoms: ['ألم/ضغط صدري','خفقان','ضيق نفس','تعب سريع'],
                    redFlags: ['ألم صدري شديد ممتد للذراع أو الفك','إغماء مفاجئ','ضيق نفس شديد مع تعرّق'],
                    tests: ['قياس ضغط الدم','ECG تخطيط قلب','Troponin','Echo موجات صوتية للقلب'],
                    seeDoctor: ['ألم صدري جديد أو متكرر','تورم الساقين مع ضيق نفس','دوخة مترافقة بخفقان']
                },
                neuro: {
                    symptoms: ['صداع مستمر','دوخة','تنميل/ضعف','تشنجات'],
                    redFlags: ['علامات سكتة: ضعف مفاجئ بوجه/ذراع/رجل أو صعوبة كلام','أسوأ صداع بحياتي','اختلاجات لأول مرة'],
                    tests: ['فحص عصبي','CT/MRI دماغ','تحاليل فيتامينات (B12/D)','EEG عند اللزوم'],
                    seeDoctor: ['صداع جديد شديد','ضعف/خدر مفاجئ','تدهور إدراكي']
                },
                respiratory: {
                    symptoms: ['سعال','صفير','ضيق نفس','ألم صدري مع التنفس'],
                    redFlags: ['زرقة/انخفاض أكسجة','ألم صدري حاد مفاجئ','سعال دم'],
                    tests: ['أشعة صدر','قياس وظائف الرئة','تحاليل حساسية','Pulse oximetry'],
                    seeDoctor: ['ضيق نفس مترقٍ','حُمّى مع سعال مستمر','سعال دم']
                },
                digestive: {
                    symptoms: ['ألم بطني','غثيان/إقياء','نفخة','تغير عادات إخراج'],
                    redFlags: ['قيء دم/براز أسود','ألم حاد مستمر','نقص وزن غير مفسر'],
                    tests: ['عد دم كامل','وظائف كبد/بنكرياس','إيكو بطن','تنظير عند اللزوم'],
                    seeDoctor: ['ألم شديد مستمر','إقياء أو إسهال مع تجفاف','نزف هضمي']
                },
                endocrine: {
                    symptoms: ['تعب','تبدلات وزن','عدم تحمل حر/برد','اضطراب دورة/مزاج'],
                    redFlags: ['ارتباك شديد/إغماء','ألم بطني مع قيء مستمر','ارتفاع ضغط/سكر غير مضبوط'],
                    tests: ['TSH/FT4 هرمونات درقية','سكر تراكمي HbA1c','كورتيزول وغير ذلك حسب الحالة'],
                    seeDoctor: ['أعراض هرمونية مترقية','اضطراب دورة شديد','اشتباه حمل مع أعراض']
                },
                adrenal: {
                    symptoms: ['ألم خاصرتين','تبوّل متكرر/حرقة','تورم','تعب'],
                    redFlags: ['انقطاع بول','حمّى مرتفعة مع قشعريرة','ألم خاصرة شديد مفاجئ'],
                    tests: ['تحليل بول','كرياتينين ووظائف كلى','إيكو كلى','CT عند الحاجة'],
                    seeDoctor: ['ألم خاصرة شديد','تورم مع قلة بول','حرقة بول مع حمّى']
                }
            };

            const hotspotSetSelected = (key) => {
                hotspotBtns.forEach(b => b.classList.toggle('selected', b.dataset.organ === key));
            };

            const highlight2D = (key) => {
                // clear previous
                organPaths.forEach(p => p.classList.remove('selected'));
                // select all shapes/groups for this organ
                document.querySelectorAll(`#body-map-svg [data-organ="${key}"]`).forEach(p => p.classList.add('selected'));
            };

            const renderCategoryChip = (cat) => {
                const meta = categoryMeta[cat] || { label: cat || 'غير مصنف', color: '#6b7280' };
                return `<span class="category-chip"><span class="dot" style="background:${meta.color}"></span>${meta.label}</span>`;
            };

            const renderList = (title, items) => {
                if (!items || !items.length) return '';
                const lis = items.map(i => `<li>• ${i}</li>`).join('');
                return `<div class="mb-2"><strong>${title}:</strong><ul class="list-disc pr-5">${lis}</ul></div>`;
            };

            const selectOrgan = (organKey) => {
                const data = window.organData[organKey];
                if (!data) return;
                highlight2D(organKey);
                hotspotSetSelected(organKey);
                infoContainer.style.opacity = 0;
                infoContainer.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    organNameEl.textContent = data.name;
                    const cat = data.category;
                    const dflt = categoryDefaults[cat] || {};
                    const symptoms = data.symptoms || dflt.symptoms || [];
                    const redFlags = data.redFlags || dflt.redFlags || [];
                    const tests = data.tests || dflt.tests || [];
                    const seeDoctor = data.seeDoctor || dflt.seeDoctor || [];

                    organDetailsEl.innerHTML = `
                        <div class="mb-3">${renderCategoryChip(cat)}</div>
                        <p class="mb-2"><strong>الأمراض المرتبطة:</strong> ${data.associatedDiseases}</p>
                        ${renderList('أعراض شائعة', symptoms)}
                        ${renderList('علامات إنذار', redFlags)}
                        ${renderList('فحوصات مقترحة', tests)}
                        ${renderList('متى تراجع الطبيب؟', seeDoctor)}
                        <p class="mb-2"><strong>السبب الشعوري الجذري:</strong> ${data.emotionalCause}</p>
                        <p class="mb-2"><strong>نصيحة شمولية:</strong> ${data.holisticAdvice}</p>
                        <p class="mt-3 text-xs text-gray-500">تنويه: هذه المعلومات تثقيفية ولا تغني عن استشارة الطبيب عند ظهور علامات الإنذار أو استمرار الأعراض.</p>
                    `;
                    infoContainer.style.opacity = 1;
                    infoContainer.style.transform = 'translateY(0)';
                }, 200);
                // Persist and deep-link
                ls.set('bm_lastOrgan', organKey);
                updateHash({ organ: organKey });
            };

            // Sex toggle (2D)
            const sexBtns = document.querySelectorAll('.body-map-toolbar [data-sex]');
            let activeSex = 'male';
            const applySex = (sex) => {
                activeSex = sex;
                // Update buttons state
                sexBtns.forEach(btn => btn.setAttribute('aria-selected', (btn.dataset.sex === sex).toString()));
                // Show/hide sex-specific organs
                document.querySelectorAll('#body-map-svg [data-sex]').forEach(el => {
                    el.style.display = (el.dataset.sex === sex) ? '' : 'none';
                });
                // Re-apply filters to respect sex visibility
                applyFilter();
                // Persist and deep-link
                ls.set('bm_sex', sex);
                updateHash({ sex });
            };

            sexBtns.forEach(btn => btn.addEventListener('click', () => applySex(btn.dataset.sex)));

            // Fine-tune mode (drag organs)
            const tuneToggleBtn = document.getElementById('body-map-tune-toggle');
            const tuneResetBtn = document.getElementById('body-map-tune-reset');
            let tuneMode = false;
            let activeDragEl = null;
            let dragStart = { x: 0, y: 0 };
            let startTranslate = { x: 0, y: 0 };

            const parseTranslate = (el) => {
                const t = el.getAttribute('transform') || '';
                const m = t.match(/translate\(([-\d\.]+)[,\s]+([\-\d\.]+)\)/);
                if (m) return { x: parseFloat(m[1] || 0), y: parseFloat(m[2] || 0) };
                return { x: 0, y: 0 };
            };
            const setTranslate = (el, x, y) => {
                // preserve other transforms if any (simple case: only translate)
                el.setAttribute('transform', `translate(${x} ${y})`);
            };
            const svgRoot = document.getElementById('body-map-svg');
            if (svgRoot) {
                svgRoot.addEventListener('pointerdown', (e) => {
                    if (!tuneMode) return;
                    const el = e.target.closest('#body-map-svg [data-organ]');
                    if (!el) return;
                    activeDragEl = el;
                    dragStart = { x: e.clientX, y: e.clientY };
                    startTranslate = parseTranslate(el);
                    try { svgRoot.setPointerCapture(e.pointerId); } catch {}
                });
                svgRoot.addEventListener('pointermove', (e) => {
                    if (!tuneMode || !activeDragEl) return;
                    const dx = e.clientX - dragStart.x;
                    const dy = e.clientY - dragStart.y;
                    setTranslate(activeDragEl, startTranslate.x + dx, startTranslate.y + dy);
                });
                svgRoot.addEventListener('pointerup', (e) => {
                    if (!tuneMode) return;
                    // Save transform before clearing selection
                    if (activeDragEl) {
                        const key = activeDragEl.dataset.organ;
                        const t = activeDragEl.getAttribute('transform') || '';
                        const storeKey = `${activeSex}::${key}`;
                        savedTransforms[storeKey] = t;
                        try { ls.set('bm_transforms', savedTransforms); } catch {}
                    }
                    activeDragEl = null;
                    try { svgRoot.releasePointerCapture(e.pointerId); } catch {}
                });
            }

            tuneToggleBtn?.addEventListener('click', () => {
                tuneMode = !tuneMode;
                svgContainer.classList.toggle('tune-active', tuneMode);
                try { showNotification(tuneMode ? 'تم تفعيل وضع الضبط: اسحب الأعضاء لتعديل مواضعها' : 'تم إيقاف وضع الضبط', 'success'); } catch(e) {}
            });
            tuneResetBtn?.addEventListener('click', () => {
                document.querySelectorAll('#body-map-svg [data-organ]').forEach(el => el.removeAttribute('transform'));
                savedTransforms = {};
                ls.set('bm_transforms', savedTransforms);
                try { showNotification('تمت إعادة ضبط مواضع الأعضاء', 'success'); } catch(e) {}
            });

            // color by category (optional visual cue using stroke)
            organPaths.forEach(path => {
                const organKey = path.dataset.organ;
                const data = window.organData[organKey];
                if (data) {
                    path.dataset.category = data.category;
                }
                // Click -> unified select
                path.addEventListener('click', () => selectOrgan(organKey));

                // Tooltip hover
                path.addEventListener('mouseenter', (e) => {
                    if (!tooltip) return;
                    const organKey = path.dataset.organ;
                    const data = window.organData[organKey];
                    if (!data) return;
                    tooltip.innerHTML = `<strong>${data.name}</strong>`;
                    tooltip.classList.remove('hidden');
                });
                path.addEventListener('mousemove', (e) => {
                    if (!tooltip) return;
                    const container = document.getElementById('body-map-svg-container');
                    const rect = container.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    tooltip.style.left = x + 'px';
                    tooltip.style.top = y + 'px';
                });
                path.addEventListener('mouseleave', () => {
                    if (!tooltip) return;
                    tooltip.classList.add('hidden');
                });
            });

            // SVG-wide event delegation for groups and nested shapes
            if (svgRoot) {
                // Click selection
                svgRoot.addEventListener('click', (e) => {
                    const el = e.target.closest('[data-organ]');
                    if (!el) return;
                    const key = el.dataset.organ;
                    if (key) selectOrgan(key);
                });
                // Tooltip show/move/hide
                svgRoot.addEventListener('mouseover', (e) => {
                    if (!tooltip) return;
                    const el = e.target.closest('[data-organ]');
                    if (!el) return;
                    const key = el.dataset.organ;
                    const data = window.organData[key];
                    tooltip.textContent = data ? data.name : key;
                    tooltip.classList.remove('hidden');
                });
                svgRoot.addEventListener('mousemove', (e) => {
                    if (!tooltip) return;
                    const rect = svgContainer.getBoundingClientRect();
                    tooltip.style.left = (e.clientX - rect.left) + 'px';
                    tooltip.style.top = (e.clientY - rect.top) + 'px';
                });
                svgContainer.addEventListener('mouseleave', () => {
                    if (tooltip) tooltip.classList.add('hidden');
                });
            }

            // Hotspots (3D)
            hotspotBtns.forEach(btn => {
                const key = btn.dataset.organ;
                const data = window.organData[key];
                if (data) {
                    btn.dataset.category = data.category;
                    btn.title = data.name;
                }
                btn.addEventListener('click', () => selectOrgan(key));
            });

            // --- LocalStorage helpers ---
            const ls = {
                get: (k, def = null) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : def; } catch { return def; } },
                set: (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} }
            };

            // --- URL hash helper ---
            const updateHash = (updates) => {
                const p = parseHashParams();
                const newParams = { ...p, view: 'body-map', ...updates };
                const qs = Object.keys(newParams).map(k => `${encodeURIComponent(k)}=${encodeURIComponent(newParams[k])}`).join('&');
                const newUrl = `${location.origin}${location.pathname}#${qs}`;
                try { history.replaceState(null, '', newUrl); } catch { location.hash = qs; }
                return newUrl;
            };

            // --- dynamic script loader helpers ---
            const loadScript = (src, type) => new Promise((resolve, reject) => {
                const s = document.createElement('script');
                if (type) s.type = type;
                s.src = src;
                s.onload = () => resolve();
                s.onerror = () => reject(new Error('Failed to load ' + src));
                document.head.appendChild(s);
            });
            const ensureModelViewer = async () => {
                if (customElements && customElements.get && customElements.get('model-viewer')) return;
                try { await loadScript('https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js', 'module'); } catch {}
            };

            // --- Mode toggle (2D/3D) ---
            const switchMode = (mode) => {
                const show3D = mode === '3d';
                container3D.classList.toggle('hidden', !show3D);
                svgContainer.classList.toggle('hidden', show3D);
                modeBtns.forEach(b => b.setAttribute('aria-selected', (b.dataset.mode === mode).toString()));
                ls.set('bm_mode', mode);
                updateHash({ mode });
            };

            // --- Pan/Zoom for 2D (Alt+سحب أو زر الفأرة الأوسط) ---
            const svgEl = document.getElementById('body-map-svg');
            let panZoom = ls.get('bm_panzoom', { x: 0, y: 0, scale: 1 });
            const applyPanZoom = () => {
                if (!svgEl) return;
                svgEl.style.transformOrigin = '50% 50%';
                svgEl.style.transform = `translate(${panZoom.x}px, ${panZoom.y}px) scale(${panZoom.scale})`;
            };
            applyPanZoom();
            svgContainer.addEventListener('wheel', (e) => {
                if (!svgEl) return;
                e.preventDefault();
                const factor = 1.1;
                const newScale = Math.min(3, Math.max(0.8, panZoom.scale * (e.deltaY < 0 ? factor : 1 / factor)));
                panZoom.scale = newScale;
                applyPanZoom();
                ls.set('bm_panzoom', panZoom);
            }, { passive: false });
            let panning = false;
            let panStart = { x: 0, y: 0 };
            let panBase = { x: 0, y: 0 };
            svgContainer.addEventListener('pointerdown', (e) => {
                if (e.button !== 1 && !e.altKey) return;
                panning = true;
                panStart = { x: e.clientX, y: e.clientY };
                panBase = { ...panZoom };
                try { svgContainer.setPointerCapture(e.pointerId); } catch {}
            });
            svgContainer.addEventListener('pointermove', (e) => {
                if (!panning) return;
                panZoom.x = panBase.x + (e.clientX - panStart.x);
                panZoom.y = panBase.y + (e.clientY - panStart.y);
                applyPanZoom();
            });
            svgContainer.addEventListener('pointerup', (e) => {
                if (!panning) return;
                panning = false;
                try { svgContainer.releasePointerCapture(e.pointerId); } catch {}
                ls.set('bm_panzoom', panZoom);
            });

            // --- Persist transforms for tune mode (per sex) ---
            let savedTransforms = ls.get('bm_transforms', {});
            Object.keys(savedTransforms || {}).forEach(storeKey => {
                const organKey = (storeKey.includes('::') ? storeKey.split('::')[1] : storeKey);
                document.querySelectorAll(`#body-map-svg [data-organ="${organKey}"]`).forEach(el => el.setAttribute('transform', savedTransforms[storeKey]));
            });

            // --- Export PDF ---
            const ensurePDFLibs = async () => {
                if (!window.html2canvas) await loadScript('https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js');
                if (!(window.jspdf && window.jspdf.jsPDF)) await loadScript('https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js');
            };

            const exportPDF = async () => {
                try {
                    await ensurePDFLibs();
                    const { jsPDF } = window.jspdf || {};
                    if (!jsPDF) throw new Error('jsPDF not loaded');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const container = document.getElementById('body-map-svg-container');
                    const info = document.getElementById('body-map-info');
                    const pageWidth = pdf.internal.pageSize.getWidth();
                    const toImg = async (el) => {
                        const canvas = await window.html2canvas(el, { backgroundColor: '#ffffff', scale: 2 });
                        return { data: canvas.toDataURL('image/png'), w: canvas.width, h: canvas.height };
                    };
                    const img1 = await toImg(container);
                    const img1W = pageWidth - 20; const img1H = (img1.h / img1.w) * img1W;
                    pdf.addImage(img1.data, 'PNG', 10, 10, img1W, img1H);
                    pdf.addPage();
                    const img2 = await toImg(info);
                    const img2W = pageWidth - 20; const img2H = (img2.h / img2.w) * img2W;
                    pdf.addImage(img2.data, 'PNG', 10, 10, img2W, img2H);
                    const fname = `خريطة-الجسد-${(organNameEl.textContent || 'عضو')}.pdf`;
                    pdf.save(fname);
                    try { showNotification('تم تصدير PDF بنجاح', 'success'); } catch {}
                } catch (e) {
                    console.error(e);
                    try { showNotification('تعذر تصدير PDF', 'error'); } catch {}
                }
            };
            document.getElementById('body-map-export-pdf')?.addEventListener('click', exportPDF);

            // --- Share / Copy Summary / Reset View ---
            const shareBtn = document.getElementById('body-map-share');
            const copySummaryBtn = document.getElementById('body-map-copy-summary');
            const resetViewBtn = document.getElementById('body-map-reset-view');

            const buildSummaryText = (key) => {
                const d = window.organData[key];
                if (!d) return '—';
                const cat = d.category;
                const meta = (categoryMeta[cat] || { label: cat || 'غير مصنف' }).label;
                const dflt = categoryDefaults[cat] || {};
                const symptoms = d.symptoms || dflt.symptoms || [];
                const redFlags = d.redFlags || dflt.redFlags || [];
                const tests = d.tests || dflt.tests || [];
                const seeDoctor = d.seeDoctor || dflt.seeDoctor || [];
                const listToLines = (arr) => arr.map(i => `- ${i}`).join('\n');
                return (
`العضو: ${d.name} (${meta})\n\nالأمراض المرتبطة: ${d.associatedDiseases}\n\nأعراض شائعة:\n${listToLines(symptoms)}\n\nعلامات إنذار:\n${listToLines(redFlags)}\n\nفحوصات مقترحة:\n${listToLines(tests)}\n\nمتى تراجع الطبيب؟\n${listToLines(seeDoctor)}\n\nالسبب الشعوري: ${d.emotionalCause}\nالنصيحة الشمولية: ${d.holisticAdvice}\n`);
            };

            shareBtn?.addEventListener('click', async () => {
                try {
                    const url = updateHash({});
                    await navigator.clipboard.writeText(url);
                    showNotification('تم نسخ رابط المشاركة إلى الحافظة', 'success');
                } catch { showNotification('تعذر نسخ الرابط', 'error'); }
            });

            copySummaryBtn?.addEventListener('click', async () => {
                try {
                    const key = ls.get('bm_lastOrgan', null);
                    if (!key) { showNotification('اختر عضواً أولاً لنسخ ملخصه', 'warning'); return; }
                    const txt = buildSummaryText(key);
                    await navigator.clipboard.writeText(txt);
                    showNotification('تم نسخ الملخص', 'success');
                } catch { showNotification('تعذر نسخ الملخص', 'error'); }
            });

            resetViewBtn?.addEventListener('click', () => {
                // Reset pan/zoom
                panZoom = { x: 0, y: 0, scale: 1 };
                applyPanZoom();
                ls.set('bm_panzoom', panZoom);
                // Reset transforms
                document.querySelectorAll('#body-map-svg [data-organ]').forEach(el => el.removeAttribute('transform'));
                savedTransforms = {};
                ls.set('bm_transforms', savedTransforms);
                // Clear selection UI
                organPaths.forEach(p => p.classList.remove('selected'));
                organNameEl.textContent = 'اختر عضواً من الخريطة';
                organDetailsEl.innerHTML = '<p class="text-gray-600">استخدم البحث أو الفلاتر أعلاه، ثم انقر على العضو للاطلاع على التفاصيل.</p>';
                showNotification('تم تصفير العرض وإعادة الوضع الافتراضي', 'success');
            });

            // --- Lesson Mode ---
            const lessonToggleBtn = document.getElementById('body-map-lesson-toggle');
            const lessonPrevBtn = document.getElementById('body-map-lesson-prev');
            const lessonNextBtn = document.getElementById('body-map-lesson-next');
            let lessonActive = false; let lessonIndex = 0; let lessonOrder = [];
            const buildLessonOrder = () => {
                const common = ['brain','lungs','heart','liver','stomach','pancreas','spleen','small_intestine','colon','kidneys','bladder'];
                const sexSpecific = activeSex === 'female' ? ['uterus_ovaries'] : ['prostate'];
                lessonOrder = common.concat(sexSpecific).filter(k => window.organData[k]);
            };
            const updateLessonUI = () => {
                lessonPrevBtn.classList.toggle('hidden', !lessonActive);
                lessonNextBtn.classList.toggle('hidden', !lessonActive);
                lessonToggleBtn.textContent = lessonActive ? 'إنهاء الدرس' : 'بدء الدرس';
            };
            const lessonGo = (dir) => {
                lessonIndex = Math.min(Math.max(0, lessonIndex + dir), lessonOrder.length - 1);
                const key = lessonOrder[lessonIndex];
                if (key) {
                    selectOrgan(key);
                    try { showNotification(`(${lessonIndex+1}/${lessonOrder.length}): ${window.organData[key].name}`, 'success', 2500); } catch {}
                }
            };
            lessonToggleBtn?.addEventListener('click', () => {
                lessonActive = !lessonActive;
                if (lessonActive) { buildLessonOrder(); lessonIndex = 0; lessonGo(0); }
                updateLessonUI();
            });
            lessonPrevBtn?.addEventListener('click', () => lessonGo(-1));
            lessonNextBtn?.addEventListener('click', () => lessonGo(+1));

            // Expose simple API for deep links
            window.BodyMap = { selectOrgan, applySex, switchMode, exportPDF };

            // Mode toggle
            modeBtns.forEach(btn => btn.addEventListener('click', () => switchMode(btn.dataset.mode)));
            // If 3D model loads, prefer 3D by default; otherwise stay 2D
            if (model3D) {
                model3D.addEventListener('load', () => {
                    if (model3DError) model3DError.classList.add('hidden');
                    switchMode('3d');
                });
                model3D.addEventListener('error', () => {
                    // First failure: try remote fallback demo model to verify wiring
                    if (!modelFallbackTried) {
                        modelFallbackTried = true;
                        try { showNotification('لم يتم العثور على النموذج المحلي. نحاول تحميل نموذج اختباري...', 'warning'); } catch(e) {}
                        model3D.src = 'https://modelviewer.dev/shared-assets/models/Astronaut.glb';
                        return;
                    }
                    // Second failure: fall back to 2D and show inline error
                    switchMode('2d');
                    try { showNotification('تعذر تحميل النموذج ثلاثي الأبعاد. تم عرض النسخة ثنائية الأبعاد.', 'warning'); } catch (e) {}
                    if (model3DError) model3DError.classList.remove('hidden');
                });
            }
            switchMode('2d');

            // Anatomy reference toggle
            if (refToggle && refEl) {
                refToggle.addEventListener('click', () => {
                    const nowHidden = refEl.classList.toggle('hidden');
                    refToggle.textContent = nowHidden ? 'عرض المخطط التشريحي المرجعي' : 'إخفاء المخطط التشريحي المرجعي';
                });
            }

            // Filtering
            let activeFilter = 'all';
            const applyFilter = () => {
                organPaths.forEach(p => {
                    const cat = p.dataset.category || 'other';
                    const catOk = activeFilter === 'all' || cat === activeFilter;
                    const sexOk = !p.dataset.sex || p.dataset.sex === activeSex;
                    p.style.display = (catOk && sexOk) ? '' : 'none';
                });
                hotspotBtns.forEach(b => {
                    const cat = b.dataset.category || 'other';
                    const catOk = activeFilter === 'all' || cat === activeFilter;
                    b.style.display = catOk ? '' : 'none';
                });
            };
            chipEls.forEach(chip => {
                chip.addEventListener('click', () => {
                    chipEls.forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    activeFilter = chip.dataset.filter || 'all';
                    applyFilter();
                });
            });

            // Save transform on drag end (redundant safety)
            svgRoot && svgRoot.addEventListener('pointerup', (e) => {
                if (!tuneMode || !activeDragEl) return;
                const key = activeDragEl.dataset.organ;
                const t = activeDragEl.getAttribute('transform') || '';
                const storeKey = `${activeSex}::${key}`;
                savedTransforms[storeKey] = t;
                ls.set('bm_transforms', savedTransforms);
            });

            // Search
            const normalize = (s) => (s || '').toString().toLowerCase();
            const applySearch = (term) => {
                const q = normalize(term);
                let anyMatch = false;
                organPaths.forEach(p => {
                    const key = p.dataset.organ;
                    const data = window.organData[key];
                    if (!data) return;
                    const hay = [data.name, data.emotionalCause, data.associatedDiseases, ...(data.keywords||[])].join(' ');
                    const match = !q || normalize(hay).includes(q);
                    p.style.opacity = match ? '1' : '0.25';
                    p.classList.toggle('match', !!q && match);
                    if (match) anyMatch = true;
                });
                hotspotBtns.forEach(b => {
                    const key = b.dataset.organ;
                    const data = window.organData[key];
                    if (!data) return;
                    const hay = [data.name, data.emotionalCause, data.associatedDiseases, ...(data.keywords||[])].join(' ');
                    const match = !q || normalize(hay).includes(q);
                    b.style.opacity = match ? '1' : '0.25';
                });
            };
            if (searchEl) {
                searchEl.addEventListener('input', (e) => applySearch(e.target.value));
            }
            // initial states (from hash or saved)
            const hp = parseHashParams();
            const initialSex = hp.sex || ls.get('bm_sex', 'male');
            applySex(initialSex);
            const initialMode = hp.mode || ls.get('bm_mode', '2d');
            switchMode(initialMode);
            const initialOrgan = hp.organ || ls.get('bm_lastOrgan', null);
            if (initialOrgan) selectOrgan(initialOrgan);
            applyFilter();
            applySearch('');
            
            // Keyboard shortcuts (when on body-map view and not typing)
            document.addEventListener('keydown', (e) => {
                const inInput = ['INPUT','TEXTAREA'].includes((document.activeElement || {}).tagName || '');
                if (inInput) return;
                if (typeof currentViewId !== 'string' || currentViewId !== 'body-map') return;
                const key = e.key.toLowerCase();
                if (key === 'l') { document.getElementById('body-map-lesson-toggle')?.click(); }
                else if (key === ']') { document.getElementById('body-map-lesson-next')?.click(); }
                else if (key === '[') { document.getElementById('body-map-lesson-prev')?.click(); }
                else if (key === 'm') { const next = (ls.get('bm_mode','2d')==='2d' ? '3d' : '2d'); switchMode(next); }
                else if (key === 's') { const nextSex = (ls.get('bm_sex','male')==='male' ? 'female' : 'male'); applySex(nextSex); }
                else if (key === 'r') { document.getElementById('body-map-reset-view')?.click(); }
                else if (key === 'p') { exportPDF(); }
                else if (key === 'h') { document.getElementById('anatomy-ref-toggle')?.click(); }
            });
        }

        // --- QUIZZES MODULE (COMPLETED) ---
        function initQuizzes() {
            const modal = document.getElementById('quiz-modal');
            const modalContent = document.getElementById('quiz-modal-content');
            const modalClose = document.getElementById('quiz-modal-close');
            const catControl = document.getElementById('quiz-cat-control');
            const searchInput = document.getElementById('quiz-search');
            const featuredWrap = document.getElementById('quizzes-featured');
            const gridWrap = document.getElementById('quizzes-grid');
            const catIcon = {
                mental: 'fa-brain',
                sleep: 'fa-bed',
                metabolic: 'fa-apple-whole',
                cardio: 'fa-heart-pulse',
                respiratory: 'fa-lungs',
                gastro: 'fa-bacteria',
                geriatrics: 'fa-person-cane',
                lifestyle: 'fa-person-walking'
            };
            let activeQuizId = null;
            let lastFocusedQuiz = null;

            const quizzes = {
                'adrenal-fatigue': {
                    title: 'اختبار الإرهاق الكظري',
                    questions: [
                        { q: "هل تشعر بالتعب حتى بعد ليلة نوم كاملة؟", points: 2 },
                        { q: "هل تجد صعوبة في الاستيقاظ في الصباح؟", points: 2 },
                        { q: "هل تشتهي الأطعمة المالحة أو السكرية بشدة؟", points: 2 },
                        { q: "هل تشعر بالدوار أو الدوخة عند الوقوف بسرعة؟", points: 1 },
                        { q: "هل قدرتك على التعامل مع الإجهاد منخفضة؟", points: 2 },
                        { q: "هل تمرض بسهولة وتستغرق وقتاً أطول للشفاء؟", points: 1 },
                        { q: "هل تشعر بأن لديك طاقة أفضل في المساء؟", points: 1 },
                    ],
                    results: [
                        { score: 0, text: "احتمالية منخفضة لوجود إرهاق كظري. يبدو أن غددك الكظرية تعمل بشكل جيد. حافظ على نمط حياتك الصحي!" },
                        { score: 4, text: "احتمالية متوسطة لوجود إرهاق كظري. قد تكون غددك الكظرية تحت ضغط. من الجيد البدء في تطبيق تقنيات إدارة الإجهاد والنوم بشكل أفضل." },
                        { score: 7, text: "احتمالية عالية لوجود إرهاق كظري. غددك الكظرية بحاجة ماسة للدعم. نوصي بشدة بالتركيز على إدارة الإجهاد، التغذية الداعمة، والنوم. قد يكون من المفيد حجز استشارة لمناقشة النتائج." }
                    ]
                },
                'leaky-gut': {
                    title: 'تقييم الأمعاء المتسربة',
                    questions: [
                        { q: "هل تعاني من انتفاخ أو غازات أو آلام في البطن بشكل منتظم؟", points: 2 },
                        { q: "هل لديك حساسيات غذائية معروفة أو تشتبه في وجودها؟", points: 2 },
                        { q: "هل تعاني من مشاكل جلدية مثل الأكزيما، حب الشباب، أو الصدفية؟", points: 2 },
                        { q: "هل تعاني من آلام في المفاصل أو العضلات بدون سبب واضح؟", points: 1 },
                        { q: "هل تعاني من ضبابية الدماغ، صعوبة في التركيز، أو تقلبات مزاجية؟", points: 2 },
                        { q: "هل تم تشخيصك بمرض مناعي ذاتي (مثل الهاشيموتو أو التهاب المفاصل الروماتويدي)؟", points: 2 },
                        { q: "هل تتناول المضادات الحيوية أو مسكنات الألم بشكل متكرر؟", points: 1 },
                    ],
                    results: [
                        { score: 0, text: "احتمالية منخفضة لوجود أمعاء متسربة. جهازك الهضمي يبدو في حالة جيدة." },
                        { score: 4, text: "احتمالية متوسطة لوجود أمعاء متسربة. قد يكون من المفيد التركيز على نظام غذائي مضاد للالتهابات ودعم صحة الأمعاء." },
                        { score: 7, text: "احتمالية عالية لوجود أمعاء متسربة. نوصي بشدة بالنظر في بروتوكول علاجي للأمعاء واستشارة مختص." }
                    ]
                },
                'toxicity-score': {
                    title: 'احسب درجة السمية في جسمك',
                    questions: [
                        { q: "هل تستخدم أواني طهي غير لاصقة (تيفلون) بانتظام؟", points: 1 },
                        { q: "هل تشرب من قوارير بلاستيكية أو تستخدم حاويات طعام بلاستيكية؟", points: 1 },
                        { q: "هل نظامك الغذائي يحتوي على الكثير من الأطعمة المصنعة أو السريعة؟", points: 2 },
                        { q: "هل تستخدم منتجات التنظيف أو العناية الشخصية التقليدية (غير الطبيعية)؟", points: 2 },
                        { q: "هل تعاني من صداع، تعب، أو حساسية كيميائية (للعطور مثلاً)؟", points: 2 },
                        { q: "هل حركة أمعائك منتظمة (على الأقل مرة واحدة يومياً)؟", points: -2 }, 
                        { q: "هل تتعرق بانتظام من خلال التمارين الرياضية أو الساونا؟", points: -1 },
                    ],
                    results: [
                        { score: -3, text: "درجة سمية منخفضة جدًا. يبدو أنك تقوم بعمل رائع في تقليل تعرضك للسموم ودعم قدرة جسمك على التخلص منها." },
                        { score: 0, text: "درجة سمية منخفضة إلى معتدلة. هناك بعض الجوانب التي يمكن تحسينها لتقليل العبء على جسمك." },
                        { score: 3, text: "درجة سمية معتدلة إلى عالية. قد يستفيد جسمك بشكل كبير من استراتيجيات دعم إزالة السموم وتقليل التعرض للمواد الكيميائية." },
                        { score: 6, text: "درجة سمية عالية. من المهم اتخاذ خطوات جادة لتقليل تعرضك للسموم ودعم مسارات التخلص منها في الكبد والأمعاء والجلد." }
                    ]
                },
                'luscher-color-test': {
                    title: 'اختبار لوشير المبسط للألوان',
                    isColorTest: true,
                    colors: [
                        { name: 'أزرق', hex: '#004084' }, { name: 'أخضر', hex: '#006400' }, { name: 'أحمر', hex: '#b00000' }, { name: 'أصفر', hex: '#ffd700' },
                        { name: 'بنفسجي', hex: '#6a0dad' }, { name: 'بني', hex: '#8b4513' }, { name: 'أسود', hex: '#000000' }, { name: 'رمادي', hex: '#808080' }
                    ],
                    interpretations: {
                        'أزرق': 'يشير إلى الحاجة إلى الهدوء والسكينة والرضا. اختيارك له أولاً يعكس رغبة في بيئة مستقرة ومتناغمة.',
                        'أخضر': 'يمثل الثبات والعزيمة والمثابرة. اختياره يعبر عن رغبة في تأكيد الذات والسيطرة على مسار الحياة.',
                        'أحمر': 'يرمز إلى الطاقة والحيوية والرغبة في الفعل والإنجاز. اختياره يعكس حالة من الإثارة والقوة الدافعة.',
                        'أصفر': 'يعبر عن الأمل والتفاؤل والرغبة في التحرر والمستقبل المشرق. اختياره يشير إلى البحث عن السعادة والتوسع.',
                        'بنفسجي': 'مزيج من الأحمر والأزرق، يرمز إلى الرغبة في علاقة صوفية أو سحرية. قد يعبر عن عدم النضج أو الحاجة للهروب من الواقع.',
                        'بني': 'يمثل الجذور والحواس الجسدية. قد يشير اختياره إلى الشعور بالإرهاق والحاجة إلى الراحة واستعادة الحيوية الجسدية.',
                        'أسود': 'يرمز إلى النفي والرفض والتخلي. اختياره كأول لون قد يشير إلى التمرد ضد الوضع الحالي أو الشعور بالضغط الشديد.',
                        'رمادي': 'يمثل الحياد وعدم الرغبة في المشاركة. اختياره قد يعبر عن رغبة في عزل النفس عن الصراعات أو التحفيز الزائد.'
                    }
                },
                // --- Validated assessments (مختارات موثوقة) ---
                'phq9': {
                    title: 'PHQ‑9 | تقييم الاكتئاب',
                    type: 'questionnaire',
                    meta: { cat: 'mental', featured: true, description: 'قياس شدة أعراض الاكتئاب خلال أسبوعين.' },
                    items: [
                        { q: 'قلة الاهتمام أو المتعة في فعل الأشياء', options: [{label:'أبداً (0)',score:0},{label:'عدة أيام (1)',score:1},{label:'أكثر من نصف الأيام (2)',score:2},{label:'تقريباً كل يوم (3)',score:3}] },
                        { q: 'الشعور بالاكتئاب أو الإحباط أو اليأس', options: [{label:'0',score:0},{label:'1',score:1},{label:'2',score:2},{label:'3',score:3}] },
                        { q: 'مشاكل في النوم', options: [{label:'0',score:0},{label:'1',score:1},{label:'2',score:2},{label:'3',score:3}] },
                        { q: 'الشعور بالتعب أو قلة الطاقة', options: [{label:'0',score:0},{label:'1',score:1},{label:'2',score:2},{label:'3',score:3}] },
                        { q: 'ضعف الشهية أو الإفراط في الأكل', options: [{label:'0',score:0},{label:'1',score:1},{label:'2',score:2},{label:'3',score:3}] },
                        { q: 'الشعور بسوء تجاه نفسك', options: [{label:'0',score:0},{label:'1',score:1},{label:'2',score:2},{label:'3',score:3}] },
                        { q: 'صعوبة في التركيز', options: [{label:'0',score:0},{label:'1',score:1},{label:'2',score:2},{label:'3',score:3}] },
                        { q: 'بطء/تململ ملحوظ', options: [{label:'0',score:0},{label:'1',score:1},{label:'2',score:2},{label:'3',score:3}] },
                        { q: 'أفكار إيذاء النفس', options: [{label:'0',score:0},{label:'1',score:1},{label:'2',score:2},{label:'3',score:3}] }
                    ],
                    thresholds: [
                        { min:0, max:4, label:'حدّي', text:'أعراض منخفضة.' },
                        { min:5, max:9, label:'خفيف', text:'راقب نمط الحياة وناقش إن استمرت.' },
                        { min:10, max:14, label:'متوسط', text:'يوصى بتقييم سريري.' },
                        { min:15, max:19, label:'شديد', text:'يفضل متابعة مختص.' },
                        { min:20, max:27, label:'شديد جداً', text:'يُنصح بطلب مساعدة مختص فوراً.' }
                    ],
                    references: ['Kroenke K, Spitzer RL, Williams JBW. The PHQ‑9: Validity of a Brief Depression Severity Measure. J Gen Intern Med. 2001']
                },
                'gad7': {
                    title: 'GAD‑7 | تقييم القلق',
                    type: 'questionnaire',
                    meta: { cat: 'mental', featured: true, description: 'قياس شدة القلق العام.' },
                    items: [
                        { q:'الشعور بالتوتر أو العصبية', options:[{label:'0',score:0},{label:'1',score:1},{label:'2',score:2},{label:'3',score:3}] },
                        { q:'عدم القدرة على التوقف عن القلق', options:[{label:'0',score:0},{label:'1',score:1},{label:'2',score:2},{label:'3',score:3}] },
                        { q:'القلق بشأن أمور مختلفة', options:[{label:'0',score:0},{label:'1',score:1},{label:'2',score:2},{label:'3',score:3}] },
                        { q:'صعوبة الاسترخاء', options:[{label:'0',score:0},{label:'1',score:1},{label:'2',score:2},{label:'3',score:3}] },
                        { q:'التململ', options:[{label:'0',score:0},{label:'1',score:1},{label:'2',score:2},{label:'3',score:3}] },
                        { q:'الانفعال بسهولة', options:[{label:'0',score:0},{label:'1',score:1},{label:'2',score:2},{label:'3',score:3}] },
                        { q:'الشعور بالخوف من حدوث شيء سيء', options:[{label:'0',score:0},{label:'1',score:1},{label:'2',score:2},{label:'3',score:3}] }
                    ],
                    thresholds: [
                        { min:0, max:4, label:'حدّي', text:'أعراض منخفضة.' },
                        { min:5, max:9, label:'خفيف', text:'تكنيكات تنفس ونوم جيد.' },
                        { min:10, max:14, label:'متوسط', text:'يفيد تقييم سلوكي معرفي.' },
                        { min:15, max:21, label:'شديد', text:'تقييم سريري مُستحسن.' }
                    ],
                    references: ['Spitzer RL, Kroenke K, Williams JBW, Löwe B. A Brief Measure for Assessing Generalized Anxiety Disorder: The GAD‑7. Arch Intern Med. 2006']
                },
                'stop-bang': {
                    title: 'STOP‑Bang | خطر انقطاع النفس أثناء النوم',
                    type: 'questionnaire',
                    meta: { cat: 'sleep', featured: true, description: 'تقدير خطر OSA.' },
                    items: [
                        { q:'شخير عالٍ؟', options:[{label:'نعم',score:1},{label:'لا',score:0}] },
                        { q:'نعاس نهاري/إرهاق؟', options:[{label:'نعم',score:1},{label:'لا',score:0}] },
                        { q:'توقف التنفس أثناء النوم؟', options:[{label:'نعم',score:1},{label:'لا',score:0}] },
                        { q:'تعاني من ضغط دم مرتفع؟', options:[{label:'نعم',score:1},{label:'لا',score:0}] },
                        { q:'BMI > 35؟', options:[{label:'نعم',score:1},{label:'لا',score:0}] },
                        { q:'العمر > 50؟', options:[{label:'نعم',score:1},{label:'لا',score:0}] },
                        { q:'محيط رقبة > 40 سم؟', options:[{label:'نعم',score:1},{label:'لا',score:0}] },
                        { q:'ذكر؟', options:[{label:'نعم',score:1},{label:'لا',score:0}] }
                    ],
                    thresholds: [
                        { min:0, max:2, label:'منخفض', text:'خطر منخفض.' },
                        { min:3, max:4, label:'متوسط', text:'قد يفيد تقييم نوم.' },
                        { min:5, max:8, label:'مرتفع', text:'ناقش دراسة نوم.' }
                    ]
                },
                'epworth': {
                    title: 'Epworth | مقياس النعاس النهاري',
                    type: 'questionnaire',
                    meta: { cat: 'sleep', featured: false, description: 'قياس ميل النعاس النهاري.' },
                    items: ['الجلوس وقراءة','مشاهدة التلفاز','مكان عام','راكب سيارة لساعة','الاستلقاء للراحة','التحدث مع شخص','بعد الغداء','قيادة والتوقف'].map(q=>({ q, options:[{label:'0',score:0},{label:'1',score:1},{label:'2',score:2},{label:'3',score:3}] })),
                    thresholds: [
                        { min:0, max:10, label:'طبيعي', text:'طبيعي.' },
                        { min:11, max:12, label:'حدّي', text:'راقب النوم.' },
                        { min:13, max:24, label:'مرتفع', text:'يستحسن تقييم اضطرابات النوم.' }
                    ]
                },
                'findrisc': {
                    title: 'FINDRISC | خطر السكري (10 سنوات)',
                    type: 'questionnaire',
                    meta: { cat: 'metabolic', featured: true, description: 'تقدير خطر الإصابة بالسكري من النمط 2.' },
                    items: [
                        { q:'العمر', options:[{label:'<45',score:0},{label:'45–54',score:2},{label:'55–64',score:3},{label:'>64',score:4}] },
                        { q:'BMI', options:[{label:'<25',score:0},{label:'25–30',score:1},{label:'>30',score:3}] },
                        { q:'محيط الخصر', options:[{label:'ذكر<94/أنثى<80',score:0},{label:'ذكر 94–102/أنثى 80–88',score:3},{label:'ذكر>102/أنثى>88',score:4}] },
                        { q:'نشاط بدني ≥ 30 دقيقة/يوم', options:[{label:'نعم',score:0},{label:'لا',score:2}] },
                        { q:'خضار/فاكهة يومياً', options:[{label:'نعم',score:0},{label:'لا',score:1}] },
                        { q:'أدوية ضغط', options:[{label:'نعم',score:2},{label:'لا',score:0}] },
                        { q:'سبق ارتفاع السكر', options:[{label:'نعم',score:5},{label:'لا',score:0}] },
                        { q:'تاريخ عائلي سكري', options:[{label:'لا',score:0},{label:'درجة ثانية',score:3},{label:'درجة أولى',score:5}] }
                    ],
                    thresholds: [
                        { min:0, max:6, label:'منخفض', text:'حافظ على نمط صحي.' },
                        { min:7, max:11, label:'معتدل', text:'حسّن التغذية والنشاط.' },
                        { min:12, max:14, label:'مرتفع', text:'ناقش فحوص مع مختص.' },
                        { min:15, max:26, label:'مرتفع جداً', text:'يوصى بتقييم طبي وفحوص.' }
                    ],
                    references: ['Lindström J, Tuomilehto J. The Diabetes Risk Score: A practical tool to predict type 2 diabetes risk. Diabetes Care. 2003']
                },
                'bmi': {
                    title: 'حاسبة مؤشر كتلة الجسم (BMI)',
                    type: 'calculator',
                    meta: { cat: 'lifestyle', featured: false, description: 'احسب BMI من الطول والوزن.' },
                    fields: [ { id:'weight', label:'الوزن (كغ)' }, { id:'height', label:'الطول (سم)' } ],
                    references: ['WHO Expert Committee. Obesity: Preventing and Managing the Global Epidemic. WHO, 2000']
                },
                'whtr': {
                    title: 'WHtR | نسبة الخصر للطول',
                    type: 'calculator',
                    meta: { cat: 'metabolic', featured: false, description: 'مؤشر مركّز لمخاطر القلب والأيض.' },
                    fields: [ { id:'waist', label:'محيط الخصر (سم)' }, { id:'height', label:'الطول (سم)' } ],
                    references: ['Browning LM, Hsieh SD, Ashwell M. A systematic review of waist-to-height ratio as a screening tool. Nutr Res Rev. 2010']
                },
                'act': {
                    title: 'ACT | اختبار التحكم بالربو',
                    type: 'questionnaire',
                    meta: { cat: 'respiratory', featured: true, description: 'خمسة أسئلة لتقييم التحكم بالربو خلال 4 أسابيع.' },
                    items: [
                        { q:'خلال 4 أسابيع، كم مرة أثّر الربو على نشاطك اليومي؟', options:[{label:'دائماً (1)',score:1},{label:'غالباً (2)',score:2},{label:'أحياناً (3)',score:3},{label:'نادراً (4)',score:4},{label:'أبداً (5)',score:5}] },
                        { q:'كم مرة شعرت بضيق نفس؟', options:[{label:'دائماً (1)',score:1},{label:'غالباً (2)',score:2},{label:'أحياناً (3)',score:3},{label:'نادراً (4)',score:4},{label:'أبداً (5)',score:5}] },
                        { q:'كم مرة استيقظت ليلاً بسبب الربو؟', options:[{label:'4+ ليال/أسبوع (1)',score:1},{label:'2–3 ليال (2)',score:2},{label:'1 ليلة/أسبوع (3)',score:3},{label:'1–2 مرات/شهر (4)',score:4},{label:'أبداً (5)',score:5}] },
                        { q:'كم مرة استخدمت بخاخ الإنقاذ؟', options:[{label:'3+ مرات/يوم (1)',score:1},{label:'1–2 مرات/يوم (2)',score:2},{label:'2–3 مرات/أسبوع (3)',score:3},{label:'1 مرة/أسبوع (4)',score:4},{label:'أقل/أبداً (5)',score:5}] },
                        { q:'كيف تُقيّم تحكمك العام بالربو؟', options:[{label:'سيء جداً (1)',score:1},{label:'سيء (2)',score:2},{label:'مقبول (3)',score:3},{label:'جيد (4)',score:4},{label:'ممتاز (5)',score:5}] }
                    ],
                    thresholds: [
                        { min:5, max:15, label:'تحكم ضعيف جداً', text:'يلزم مراجعة خطة العلاج. ناقش التعديلات مع مختص.' },
                        { min:16, max:19, label:'تحكم غير كافٍ', text:'قد تستفيد من تحسين الالتزام أو تعديل العلاج.' },
                        { min:20, max:25, label:'تحكم جيد', text:'استمر، وناقش تقليل المخاطر ومفاتيح الحفاظ.' }
                    ],
                    references: ['Nathan RA et al., J Allergy Clin Immunol, 2004']
                },
                'mmrc': {
                    title: 'mMRC | مقياس ضيق النفس المعدّل',
                    type: 'questionnaire',
                    meta: { cat: 'respiratory', featured: false, description: 'تقدير عبء ضيق النفس من 0 إلى 4.' },
                    items: [
                        { q:'0: ضيق نفس فقط عند الجهد الشديد', options:[{label:'ينطبق',score:0}] },
                        { q:'1: ضيق نفس عند الإسراع أو صعود تلّة خفيفة', options:[{label:'ينطبق',score:1}] },
                        { q:'2: المشي أبطأ من أقراني لضيق النفس أو التوقف بعد 15 دقيقة مشي', options:[{label:'ينطبق',score:2}] },
                        { q:'3: التوقف بعد مسافة قصيرة (100 متر) بسبب ضيق النفس', options:[{label:'ينطبق',score:3}] },
                        { q:'4: ضيق نفس يمنع مغادرة المنزل أو عند ارتداء الملابس', options:[{label:'ينطبق',score:4}] }
                    ],
                    thresholds: [
                        { min:0, max:1, label:'خفيف', text:'عبء ضيق نفس منخفض.' },
                        { min:2, max:2, label:'متوسط', text:'عبء متوسط؛ يفيد برنامج تأهيل رئوي.' },
                        { min:3, max:4, label:'شديد', text:'عبء عالٍ؛ يُستحسن تقييم وعلاج تخصصي.' }
                    ],
                    references: ['Bestall JC et al., Thorax, 1999']
                },
                'gerdq': {
                    title: 'GERD‑Q | تقييم الارتجاع المعدي المريئي',
                    type: 'questionnaire',
                    meta: { cat: 'gastro', featured: true, description: 'ستة بنود بدرجات تكرارية لمساعدة تقدير GERD.' },
                    items: [
                        { q:'حرقة المعدة خلال الأسبوع الماضي', options:[{label:'0 يوم (0)',score:0},{label:'1 يوم (1)',score:1},{label:'2–3 أيام (2)',score:2},{label:'4–7 أيام (3)',score:3}] },
                        { q:'ارتجاع/طعم مرّ بالفم', options:[{label:'0',score:0},{label:'1',score:1},{label:'2–3',score:2},{label:'4–7',score:3}] },
                        { q:'ألم أعلى البطن', options:[{label:'0',score:0},{label:'1',score:1},{label:'2–3',score:2},{label:'4–7',score:3}] },
                        { q:'الغثيان', options:[{label:'0',score:0},{label:'1',score:1},{label:'2–3',score:2},{label:'4–7',score:3}] },
                        { q:'اضطراب النوم بسبب الأعراض', options:[{label:'0 يوم (3)',score:3},{label:'1 (2)',score:2},{label:'2–3 (1)',score:1},{label:'4–7 (0)',score:0}] },
                        { q:'استخدام أدوية إضافية للأعراض', options:[{label:'0 (3)',score:3},{label:'1 (2)',score:2},{label:'2–3 (1)',score:1},{label:'4–7 (0)',score:0}] }
                    ],
                    thresholds: [
                        { min:0, max:7, label:'منخفض', text:'احتمال GERD منخفض.' },
                        { min:8, max:18, label:'مرتفع', text:'احتمال GERD مرتفع؛ ناقش خطة التشخيص/العلاج.' }
                    ],
                    references: ['Jones R et al., Aliment Pharmacol Ther, 2009']
                },
                'sarc-f': {
                    title: 'SARC‑F | خطر الساركوبينيا',
                    type: 'questionnaire',
                    meta: { cat: 'geriatrics', featured: false, description: 'خمسة بنود (0–2)؛ ≥4 يشير إلى خطر ساركوبينيا.' },
                    items: [
                        { q:'القوة (فتح علبة أو حمل كيس)', options:[{label:'بدون صعوبة (0)',score:0},{label:'بعض الصعوبة (1)',score:1},{label:'صعوبة شديدة/غير قادر (2)',score:2}] },
                        { q:'المشي عبر الغرفة', options:[{label:'بدون صعوبة (0)',score:0},{label:'بعض الصعوبة (1)',score:1},{label:'صعوبة شديدة/مساعدة (2)',score:2}] },
                        { q:'القيام من كرسي/سرير', options:[{label:'بدون صعوبة (0)',score:0},{label:'بعض الصعوبة (1)',score:1},{label:'صعوبة شديدة (2)',score:2}] },
                        { q:'الصعود عدة درجات', options:[{label:'بدون صعوبة (0)',score:0},{label:'بعض الصعوبة (1)',score:1},{label:'صعوبة شديدة (2)',score:2}] },
                        { q:'السقوط خلال السنة الماضية', options:[{label:'0 (0)',score:0},{label:'1–3 (1)',score:1},{label:'4+ (2)',score:2}] }
                    ],
                    thresholds: [
                        { min:0, max:3, label:'منخفض', text:'خطر ساركوبينيا منخفض.' },
                        { min:4, max:10, label:'مرتفع', text:'خطر مرتفع؛ يُستحسن تقييم وظيفة وكتلة العضلات.' }
                    ],
                    references: ['Malmstrom TK, Morley JE, J Nutr Health Aging, 2013']
                },
                'frail': {
                    title: 'FRAIL | متلازمة الوهَن (5 بنود)',
                    type: 'questionnaire',
                    meta: { cat: 'geriatrics', featured: false, description: 'Fatigue, Resistance, Ambulation, Illnesses, Loss of weight.' },
                    items: [
                        { q:'Fatigue – تعب متكرر؟', options:[{label:'نعم',score:1},{label:'لا',score:0}] },
                        { q:'Resistance – صعوبة صعود 10 درجات؟', options:[{label:'نعم',score:1},{label:'لا',score:0}] },
                        { q:'Ambulation – صعوبة المشي عدة مئات أمتار؟', options:[{label:'نعم',score:1},{label:'لا',score:0}] },
                        { q:'Illnesses – ≥5 أمراض مزمنة؟', options:[{label:'نعم',score:1},{label:'لا',score:0}] },
                        { q:'Loss of weight – فقدان >5% خلال سنة؟', options:[{label:'نعم',score:1},{label:'لا',score:0}] }
                    ],
                    thresholds: [
                        { min:0, max:0, label:'سليم', text:'لا توجد دلائل وهَن.' },
                        { min:1, max:2, label:'ما قبل الوهَن', text:'اعتمد خطة تغذية ونشاط ووظيفة.' },
                        { min:3, max:5, label:'وهَن', text:'يُنصح بتقييم شيخوخة شامل.' }
                    ],
                    references: ['Morley JE et al., J Nutr Health Aging, 2012']
                },
                'cat': {
                    title: 'CAT | تأثير داء الانسداد الرئوي المزمن (COPD)',
                    type: 'questionnaire',
                    meta: { cat: 'respiratory', featured: false, description: 'ثمانية بنود بدرجة 0–5 لكل بند لقياس التأثير اليومي.' },
                    items: ['الكحة','البلغم','ضيق النفس عند الجهد','ألم/ثقل الصدر','الأنشطة المنزلية','الخروج بثقة','النوم','الطاقة'].map(q=>({ q, options:[{label:'0',score:0},{label:'1',score:1},{label:'2',score:2},{label:'3',score:3},{label:'4',score:4},{label:'5',score:5}] })),
                    thresholds: [
                        { min:0, max:10, label:'منخفض', text:'تأثير منخفض. استمر على الخطة الحالية.' },
                        { min:11, max:20, label:'متوسط', text:'تأثير متوسط. ناقش برنامج تأهيل رئوي.' },
                        { min:21, max:30, label:'شديد', text:'تأثير واضح؛ يلزم مراجعة خطة العلاج.' },
                        { min:31, max:40, label:'شديد جداً', text:'تأثير شديد جداً؛ يُنصح بتقييم تخصصي عاجل.' }
                    ],
                    references: ['Jones PW et al., Eur Respir J, 2009']
                },
                'audit-c': {
                    title: 'AUDIT‑C | فحص تعاطي الكحول (3 بنود)',
                    type: 'questionnaire',
                    meta: { cat: 'lifestyle', featured: false, description: 'أداة سريعة (0–12). ≥4 قد يشير لاستخدام خطِر (يختلف حسب الجنس).' },
                    items: [
                        { q:'عدد المرّات التي تتناول فيها مشروباً كحولياً؟', options:[{label:'أبداً (0)',score:0},{label:'شهرياً أو أقل (1)',score:1},{label:'2–4 مرات/شهر (2)',score:2},{label:'2–3 مرات/أسبوع (3)',score:3},{label:'4+ مرات/أسبوع (4)',score:4}] },
                        { q:'كم عدد المشروبات القياسية في اليوم المعتاد؟', options:[{label:'1–2 (0)',score:0},{label:'3–4 (1)',score:1},{label:'5–6 (2)',score:2},{label:'7–9 (3)',score:3},{label:'10+ (4)',score:4}] },
                        { q:'كم مرة تتناول 6 مشروبات أو أكثر في مناسبة واحدة؟', options:[{label:'أبداً (0)',score:0},{label:'أقل من شهرياً (1)',score:1},{label:'شهرياً (2)',score:2},{label:'أسبوعياً (3)',score:3},{label:'يومياً/تقريباً (4)',score:4}] }
                    ],
                    thresholds: [
                        { min:0, max:3, label:'منخفض', text:'استخدام منخفض الخطورة.' },
                        { min:4, max:12, label:'محتمل خطر', text:'نتيجة موجبة للفحص؛ تختلف العتبات حسب الجنس. ناقش مع مختص.' }
                    ],
                    references: ['Bush K et al., Arch Intern Med, 1998']
                },
                'scoff': {
                    title: 'SCOFF | فحص اضطرابات الأكل (5 أسئلة)',
                    type: 'questionnaire',
                    meta: { cat: 'mental', featured: false, description: '≥2 يشير لاحتمال اضطراب أكل؛ يلزم تقييم مختص.' },
                    items: [
                        { q:'هل تُحدث القيء عمدًا لأنك تشعر بالامتلاء غير المريح؟', options:[{label:'نعم',score:1},{label:'لا',score:0}] },
                        { q:'هل تقلق من فقدان السيطرة على كمّية ما تأكل؟', options:[{label:'نعم',score:1},{label:'لا',score:0}] },
                        { q:'هل فقدت أكثر من 6 كغ خلال 3 أشهر؟', options:[{label:'نعم',score:1},{label:'لا',score:0}] },
                        { q:'هل تعتقد أن الطعام يهيمن على حياتك؟', options:[{label:'نعم',score:1},{label:'لا',score:0}] },
                        { q:'هل ترى نفسك بديناً رغم قول الآخرين عكس ذلك؟', options:[{label:'نعم',score:1},{label:'لا',score:0}] }
                    ],
                    thresholds: [
                        { min:0, max:1, label:'سلبي', text:'لا توجد دلائل كافية؛ راقب فقط.' },
                        { min:2, max:5, label:'موجب', text:'نتيجة موجبة للفحص؛ يُستحسن تقييم مختص تغذية/نفسية.' }
                    ],
                    references: ['Morgan JF et al., BMJ, 1999']
                },
                'isi': {
                    title: 'ISI | مؤشر شدة الأرق (7 بنود)',
                    type: 'questionnaire',
                    meta: { cat: 'sleep', featured: false, description: '0–28؛ (0–7 طبيعي، 8–14 تحت العتبة، 15–21 متوسط، 22–28 شديد).' },
                    items: [
                        'صعوبة بدء النوم','صعوبة الاستمرار بالنوم','الاستيقاظ مبكراً','الرضا عن نمط النوم','ضعف الأداء النهاري','ملاحظة الآخرين لصعوباتك','القلق بشأن صعوبات النوم'
                    ].map(q=>({ q, options:[{label:'0',score:0},{label:'1',score:1},{label:'2',score:2},{label:'3',score:3},{label:'4',score:4}] })),
                    thresholds: [
                        { min:0, max:7, label:'طبيعي', text:'لا توجد دلائل أرق سريري.' },
                        { min:8, max:14, label:'تحت العتبة', text:'تدخلات نمط الحياة قد تكفي.' },
                        { min:15, max:21, label:'متوسط', text:'قد يفيد CBT‑I أو تدخل علاجي.' },
                        { min:22, max:28, label:'شديد', text:'أرق شديد؛ يُستحسن تقييم متخصص بالنوم.' }
                    ],
                    references: ['Morin CM, Sleep Med, 2011']
                },
                'k10': {
                    title: 'K10 | مؤشر الضائقة النفسية (10 بنود)',
                    type: 'questionnaire',
                    meta: { cat: 'mental', featured: false, description: '10–50؛ درجات أعلى = ضائقة أعلى خلال 4 أسابيع.' },
                    items: [
                        'كم مرة شعرت بالتعب دون سبب؟','عصبي؟','ميّال للانهيار؟','ميّال باليأس؟','قلق؟','لا تستطيع الهدوء؟','كآبة؟','كل شيء جهد؟','لا شيء يفرحك؟','لا يمكنك الاستمرار؟'
                    ].map(q=>({ q, options:[{label:'أبداً (1)',score:1},{label:'قليلاً (2)',score:2},{label:'أحياناً (3)',score:3},{label:'غالباً (4)',score:4},{label:'دائماً (5)',score:5}] })),
                    thresholds: [
                        { min:10, max:15, label:'منخفض', text:'ضائقة منخفضة.' },
                        { min:16, max:21, label:'متوسط', text:'ضائقة متوسطة.' },
                        { min:22, max:29, label:'عالٍ', text:'ضائقة عالية؛ ناقش استراتيجيات دعم.' },
                        { min:30, max:50, label:'عالٍ جداً', text:'ضائقة عالية جداً؛ يُستحسن تقييم مختص.' }
                    ],
                    references: ['Kessler RC et al., Psychol Med, 2002']
                },
                'cha2ds2-vasc': {
                    title: 'CHA₂DS₂‑VASc | خطر السكتة في الرجفان الأذيني',
                    type: 'questionnaire',
                    meta: { cat: 'cardio', featured: false, description: 'للمرضى ذوي الرجفان الأذيني فقط. مجموع النقاط يقدّر خطر السكتة.' },
                    items: [
                        { q:'قصور قلب احتقاني/خلل بطين أيسر', options:[{label:'نعم (1)',score:1},{label:'لا (0)',score:0}] },
                        { q:'ارتفاع ضغط الدم', options:[{label:'نعم (1)',score:1},{label:'لا (0)',score:0}] },
                        { q:'العمر ≥75 سنة', options:[{label:'نعم (2)',score:2},{label:'لا (0)',score:0}] },
                        { q:'داء السكري', options:[{label:'نعم (1)',score:1},{label:'لا (0)',score:0}] },
                        { q:'سكتة/نوبة إقفارية/صمّات سابقة', options:[{label:'نعم (2)',score:2},{label:'لا (0)',score:0}] },
                        { q:'مرض وعائي (احتشاء/مرض شرياني/لويحات)', options:[{label:'نعم (1)',score:1},{label:'لا (0)',score:0}] },
                        { q:'العمر 65–74 سنة', options:[{label:'نعم (1)',score:1},{label:'لا (0)',score:0}] },
                        { q:'الجنس أنثى', options:[{label:'نعم (1)',score:1},{label:'لا (0)',score:0}] }
                    ],
                    thresholds: [
                        { min:0, max:0, label:'منخفض', text:'خطر سنوي منخفض. القرار العلاجي يعتمد على عوامل أخرى.' },
                        { min:1, max:1, label:'متوسط', text:'خطر متوسط؛ ناقش موازنة فائدة المضادّات للتخثّر.' },
                        { min:2, max:9, label:'مرتفع', text:'خطر مرتفع؛ غالباً توصى مضادات التخثّر إذا لا يوجد مانع.' }
                    ],
                    references: ['Lip GYH et al., Chest, 2010']
                }
            };

            const hideQuizModal = () => {
                modal.classList.remove('is-open');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    if (modalContent) modalContent.innerHTML = '';
                    try { lastFocusedQuiz?.focus(); } catch {}
                }, 300);
                // Clean quiz param from hash but preserve category
                try {
                    const p = typeof parseHashParams === 'function' ? parseHashParams() : {};
                    const cat = p && p.cat ? `&cat=${encodeURIComponent(p.cat)}` : '';
                    window.__quizNavigating = true;
                    location.hash = `view=quizzes${cat}`;
                } catch {}
                activeQuizId = null;
            };
            modalClose?.addEventListener('click', hideQuizModal);
            // Close on overlay click
            modal?.addEventListener('click', (e) => { if (e.target === modal) hideQuizModal(); });
            // Close on Escape
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !modal.classList.contains('hidden')) hideQuizModal();
            });
            // Close when navigating via CTA inside modal
            modalContent?.addEventListener('click', (ev) => {
                const link = ev.target.closest('.nav-link');
                if (link) hideQuizModal();
            });

            function bindStartButtons(scope) {
                (scope || document).querySelectorAll('.quiz-start-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const quizId = btn.dataset.quiz;
                        startQuiz(quizId);
                    });
                });
            }
            bindStartButtons();
            // Quick links (chips) fast start
            document.querySelectorAll('#quiz-quick-links .quiz-quick-btn')?.forEach(btn => {
                btn.addEventListener('click', () => {
                    const id = btn.getAttribute('data-quiz');
                    if (id) startQuiz(id);
                });
            });
            // Expose starter for deep links
            window.__startQuiz = startQuiz;
            
            function startQuiz(quizId) {
                const quizData = quizzes[quizId];
                if (!quizData) return;
                activeQuizId = quizId;
                lastFocusedQuiz = document.activeElement;
                // Update hash for deep-linking state
                try {
                    const p = typeof parseHashParams === 'function' ? parseHashParams() : {};
                    const cat = p && p.cat ? `&cat=${encodeURIComponent(p.cat)}` : '';
                    window.__quizNavigating = true;
                    location.hash = `view=quizzes&quiz=${encodeURIComponent(quizId)}${cat}`;
                } catch {}
                if (quizData.type === 'calculator') {
                    renderCalculator(quizId, quizData);
                } else if (quizData.isColorTest) {
                    renderColorTest(quizData);
                } else {
                    // generic questionnaire/likert
                    renderQuestionnaire(quizData);
                }
                modal.classList.remove('hidden');
                setTimeout(() => modal.classList.add('is-open'), 10);
            }
            
            function renderQuestionnaire(quizData) {
                let currentQuestion = 0;
                let score = 0;
                function renderQuestion() {
                    if (currentQuestion >= quizData.questions.length) {
                        renderResult();
                        return;
                    }
                    const q = (quizData.items || quizData.questions)[currentQuestion];
                    const total = (quizData.items || quizData.questions).length;
                    const hasOptions = Array.isArray(q.options);
                    let optionsHtml = '';
                    if (hasOptions) {
                        optionsHtml = q.options.map((op,i)=>`<button class="quiz-option-btn btn ${i===0?'btn-primary text-white':'btn-secondary'} py-2 px-6 rounded-full" data-score="${op.score}">${op.label}</button>`).join(' ');
                    } else {
                        optionsHtml = `
                           <button class="quiz-yn-btn btn btn-primary text-white py-2 px-8 rounded-full" data-yn="yes">نعم</button>
                           <button class="quiz-yn-btn btn btn-secondary py-2 px-8 rounded-full" data-yn="no">لا</button>`;
                    }
                    const progress = Math.round((currentQuestion) / Math.max(1,total) * 100);
                    modalContent.innerHTML = `
                        <h3 class="text-2xl font-bold mb-2">${quizData.title}</h3>
                        <div class="w-full h-2 bg-gray-200 rounded-full mb-4 overflow-hidden" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="${progress}" aria-label="التقدم"><div class="h-2 bg-[--accent-color] rounded-full" style="width:${progress}%"></div></div>
                        <p class="text-gray-500 mb-4">السؤال ${currentQuestion + 1} من ${total}</p>
                        <p class="text-xl font-semibold mb-6 text-center">${q.q || q}</p>
                        <div class="flex flex-wrap justify-center gap-3">${optionsHtml}</div>
                    `;
                    if (hasOptions) {
                        modalContent.querySelectorAll('.quiz-option-btn').forEach(btn => {
                            btn.addEventListener('click', () => {
                                const s = parseFloat(btn.dataset.score || '0');
                                score += isNaN(s) ? 0 : s;
                                currentQuestion++;
                                renderQuestion();
                            });
                        });
                    } else {
                        modalContent.querySelectorAll('.quiz-yn-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const yes = e.currentTarget.getAttribute('data-yn') === 'yes';
                                if (yes) score += q.points || 0; else if ((q.points||0) < 0) score -= (q.points||0);
                                currentQuestion++;
                                renderQuestion();
                            });
                        });
                    }
                }
                function renderResult() {
                    let resultText = '';
                    if (Array.isArray(quizData.thresholds)) {
                        const t = quizData.thresholds.find(th => score >= th.min && score <= th.max) || {};
                        resultText = `${t.label ? ('التصنيف: ' + t.label + '<br>') : ''}${t.text || ''}`;
                    } else if (Array.isArray(quizData.results)) {
                        for (let i = quizData.results.length - 1; i >= 0; i--) {
                            if (score >= quizData.results[i].score) { resultText = quizData.results[i].text; break; }
                        }
                    }
                    const toolTitle = quizData.title || 'نتيجة التقييم';
                    const saveBtnHtml = (typeof currentUser === 'object' && currentUser) ? '<button id="save-quiz-result" class="btn btn-secondary py-2 px-6 rounded-full mr-2">حفظ النتيجة</button>' : '';
                    const refs = Array.isArray(quizData.references) ? `<div class="text-xs text-gray-500 mt-4 text-right"><strong>مراجع:</strong><ul class="list-disc pr-5">${quizData.references.map(r=>`<li>${r}</li>`).join('')}</ul></div>` : '';
                    const ctas = `
                        <div class="flex flex-wrap gap-2 justify-center mt-4">
                          <a href="#" class="nav-link btn btn-outline py-2 px-4 rounded-full" data-view="second-opinion"><i class="fa-solid fa-stethoscope ml-2"></i>الرأي الطبي الثاني</a>
                          <a href="#" class="nav-link btn btn-outline py-2 px-4 rounded-full" data-view="medical-travel"><i class="fa-solid fa-plane-departure ml-2"></i>تنسيق السفر الطبي</a>
                        </div>`;
                    modalContent.innerHTML = `
                        <h3 class="text-2xl font-bold mb-2">${toolTitle}</h3>
                        <div class="bg-gray-100 p-6 rounded-lg text-center">
                            <p class="text-lg mb-2">درجتك هي: <span class="font-bold text-2xl text-[--primary-color]">${score}</span></p>
                            <p class="text-gray-700">${resultText}</p>
                        </div>
                        ${refs}
                        ${ctas}
                        <div class="text-center mt-6 flex flex-wrap gap-2 justify-center">
                            ${saveBtnHtml}
                            <button id="copy-quiz-result" class="btn btn-secondary py-2 px-6 rounded-full">نسخ النتيجة</button>
                            <button id="share-quiz-result" class="btn btn-secondary py-2 px-6 rounded-full"><i class="fa-solid fa-share-nodes ml-1"></i>مشاركة</button>
                            <button id="download-quiz-pdf" class="btn btn-primary text-white py-2 px-6 rounded-full">تحميل كـ PDF</button>
                        </div>
                        <div class="legal-disclaimer mt-4 p-3 text-sm">
                            <p>هذه الأداة معلوماتية ولا تُعد تشخيصاً طبياً. شارك نتائجك مع مختص لاتخاذ القرار الأنسب لحالتك.</p>
                        </div>`;
                    document.getElementById('download-quiz-pdf')?.addEventListener('click', ()=> downloadResultAsPDF('quiz-modal-content', toolTitle));
                    document.getElementById('save-quiz-result')?.addEventListener('click', ()=> {
                        const full = `--- العنوان ---\n${toolTitle}\n\n--- الدرجة ---\n${score}\n\n--- التفسير ---\n${resultText}`;
                        saveResultToFirestore(toolTitle, full, { kind:'assessment', id: activeQuizId, cat: quizData.meta?.cat || null, score });
                    });
                    document.getElementById('copy-quiz-result')?.addEventListener('click', async ()=>{
                        try {
                            const txt = `${toolTitle}\nالدرجة: ${score}\n${stripHtml(resultText)}`;
                            await navigator.clipboard.writeText(txt);
                            showNotification('تم نسخ النتيجة إلى الحافظة.', 'success');
                        } catch { showNotification('تعذّر النسخ. حاول يدوياً.', 'warning'); }
                    });
                    document.getElementById('share-quiz-result')?.addEventListener('click', async ()=>{
                        try {
                            const shareText = `${toolTitle} — الدرجة: ${score}\n${stripHtml(resultText)}`;
                            if (navigator.share) {
                                await navigator.share({ title: toolTitle, text: shareText, url: location.href });
                            } else {
                                await navigator.clipboard.writeText(shareText + `\n${location.href}`);
                                showNotification('تم نسخ نص المشاركة لأن Web Share غير متاح.', 'warning');
                            }
                        } catch {}
                    });
                    modalContent.querySelector('.close-quiz-modal-btn')?.addEventListener('click', hideQuizModal);
                }
                renderQuestion();
            }

            function renderCalculator(quizId, quizData) {
                const fieldsHtml = (quizData.fields||[]).map(f => `
                    <div class="mb-4">
                        <label class="block mb-1">${f.label}</label>
                        <input id="calc-${f.id}" type="number" class="w-full p-2 border rounded-md" step="0.1">
                    </div>`).join('');
                modalContent.innerHTML = `
                    <h3 class="text-2xl font-bold mb-4">${quizData.title}</h3>
                    <div class="bg-gray-50 p-4 rounded-lg mb-4">${quizData.meta?.description || ''}</div>
                    ${fieldsHtml}
                    <div class="text-center mt-4">
                        <button id="calc-run" class="btn btn-primary text-white py-2 px-8 rounded-full">احسب</button>
                    </div>
                    <div id="calc-result" class="mt-4"></div>
                `;
                document.getElementById('calc-run')?.addEventListener('click', () => {
                    const out = document.getElementById('calc-result');
                    if (quizId === 'bmi') {
                        const w = parseFloat(document.getElementById('calc-weight')?.value||'0');
                        const hcm = parseFloat(document.getElementById('calc-height')?.value||'0');
                        if (!w || !hcm) { out.innerHTML = '<p class="text-red-600">أدخل الطول والوزن.</p>'; return; }
                        if (w < 20 || w > 300 || hcm < 100 || hcm > 250) { out.innerHTML = '<p class="text-red-600">تحقق من القيم: الطول 100–250 سم والوزن 20–300 كغ.</p>'; return; }
                        const m = hcm/100; const bmi = w/(m*m);
                        let cls = bmi<18.5?'نحافة':(bmi<25?'طبيعي':(bmi<30?'زيادة وزن':'بدانة'));
                        out.innerHTML = `<div class="bg-white p-4 rounded-lg shadow text-center">
                            <p>BMI: <strong>${bmi.toFixed(1)}</strong> — ${cls}</p>
                            <div class="mt-3 flex flex-wrap gap-2 justify-center">
                                ${currentUser ? '<button id="save-calc-result" class="btn btn-secondary py-1.5 px-4 rounded-full">حفظ</button>' : ''}
                                <button id="copy-calc-result" class="btn btn-secondary py-1.5 px-4 rounded-full">نسخ</button>
                            </div>
                        </div>`;
                        document.getElementById('save-calc-result')?.addEventListener('click', ()=>{
                            const toolTitle = quizData.title;
                            const full = `--- العنوان ---\n${toolTitle}\n\n--- النتيجة ---\nBMI: ${bmi.toFixed(1)} — ${cls}`;
                            saveResultToFirestore(toolTitle, full, { kind:'calculator', id: quizId, inputs:{ weight:w, height:hcm }, bmi });
                        });
                        document.getElementById('copy-calc-result')?.addEventListener('click', async ()=>{
                            try { await navigator.clipboard.writeText(`BMI: ${bmi.toFixed(1)} — ${cls}`); showNotification('تم النسخ.', 'success'); } catch {}
                        });
                    } else if (quizId === 'whtr') {
                        const waist = parseFloat(document.getElementById('calc-waist')?.value||'0');
                        const height = parseFloat(document.getElementById('calc-height')?.value||'0');
                        if (!waist || !height) { out.innerHTML = '<p class="text-red-600">أدخل الخصر والطول.</p>'; return; }
                        if (waist < 40 || waist > 200 || height < 100 || height > 250) { out.innerHTML = '<p class="text-red-600">تحقق من القيم: الخصر 40–200 سم والطول 100–250 سم.</p>'; return; }
                        const whtr = waist/height; 
                        let cls = whtr<0.5?'منخفض':(whtr<0.6?'متوسط':'مرتفع');
                        out.innerHTML = `<div class="bg-white p-4 rounded-lg shadow text-center">
                            <p>WHtR: <strong>${whtr.toFixed(2)}</strong> — خطر ${cls}</p>
                            <div class="mt-3 flex flex-wrap gap-2 justify-center">
                                ${currentUser ? '<button id="save-calc-result" class="btn btn-secondary py-1.5 px-4 rounded-full">حفظ</button>' : ''}
                                <button id="copy-calc-result" class="btn btn-secondary py-1.5 px-4 rounded-full">نسخ</button>
                            </div>
                        </div>`;
                        document.getElementById('save-calc-result')?.addEventListener('click', ()=>{
                            const toolTitle = quizData.title;
                            const full = `--- العنوان ---\n${toolTitle}\n\n--- النتيجة ---\nWHtR: ${whtr.toFixed(2)} — خطر ${cls}`;
                            saveResultToFirestore(toolTitle, full, { kind:'calculator', id: quizId, inputs:{ waist, height }, whtr });
                        });
                        document.getElementById('copy-calc-result')?.addEventListener('click', async ()=>{
                            try { await navigator.clipboard.writeText(`WHtR: ${whtr.toFixed(2)} — خطر ${cls}`); showNotification('تم النسخ.', 'success'); } catch {}
                        });
                    }
                });
            }

            function renderColorTest(quizData) {
                let selectedOrder = [];
                const totalColors = quizData.colors.length;

                function updateInstructions() {
                     const instructionEl = modalContent.querySelector('#luscher-instruction');
                     if(instructionEl) {
                        const remaining = totalColors - selectedOrder.length;
                        if (remaining > 0) {
                           instructionEl.textContent = `اختر اللون المفضل لديك من بين الألوان المتبقية. (${remaining} متبقي)`;
                        } else {
                           instructionEl.textContent = 'اكتمل الاختيار! انقر أدناه للحصول على تحليلك.';
                        }
                     }
                }

                function handleColorClick(e) {
                    const swatch = e.target;
                    if (swatch.classList.contains('selected')) return;

                    selectedOrder.push(swatch.dataset.colorName);
                    swatch.classList.add('selected');
                    swatch.setAttribute('data-order', selectedOrder.length);
                    
                    updateInstructions();

                    if (selectedOrder.length === totalColors) {
                        const analyzeBtn = modalContent.querySelector('#analyze-luscher-btn');
                        if(analyzeBtn) {
                           analyzeBtn.classList.remove('hidden');
                           analyzeBtn.classList.add('flex', 'mx-auto');
                        }
                    }
                }

                modalContent.innerHTML = `
                    <h3 class="text-2xl font-bold mb-2">${quizData.title}</h3>
                    <p id="luscher-instructions" class="text-gray-600 mb-4 text-center">اختر اللون المفضل لديك من بين الألوان المتبقية. (8 متبقي)</p>
                    <div class="color-swatch-container">
                        ${quizData.colors.map(c => `<div class="color-swatch" data-color-name="${c.name}" style="background-color: ${c.hex};"></div>`).join('')}
                    </div>
                    <div class="text-sm text-gray-500 mb-4">
                        <p><strong>إخلاء مسؤولية:</strong> هذا الاختبار هو نسخة مبسطة لأغراض الاستكشاف الذاتي فقط ولا يمثل تشخيصاً نفسياً أو طبياً كاملاً.</p>
                    </div>
                    <div class="text-center mt-6">
                        <button id="analyze-luscher-btn" class="hidden btn btn-primary text-white py-2 px-8 rounded-full">احصل على التحليل</button>
                    </div>
                `;

                const swatches = modalContent.querySelectorAll('.color-swatch');
                swatches.forEach(swatch => swatch.addEventListener('click', handleColorClick));

                modalContent.querySelector('#analyze-luscher-btn').addEventListener('click', () => {
                    const firstChoice = selectedOrder[0];
                    const lastChoice = selectedOrder[7];
                    const analysis = `
                        <h3 class="text-2xl font-bold mb-2">تحليل اختياراتك</h3>
                        <div class="text-right space-y-3">
                           <p><strong>تفضيلك الأول (<span class="font-bold text-green-600">هدف مرغوب</span>): ${firstChoice}</strong></p>
                           <p class="text-gray-700 pr-4">${quizData.interpretations[firstChoice]}</p>
                           <p><strong>تفضيلك الأخير (<span class="font-bold text-red-600">صفة مرفوضة</span>): ${lastChoice}</strong></p>
                           <p class="text-gray-700 pr-4">رفضك للون ${lastChoice} قد يشير إلى أنك ترفض بوعي أو بغير وعي الصفات التي يمثلها. ${quizData.interpretations[lastChoice]}</p>
                        </div>
                        <div class="text-center mt-6">
                           <button class="close-quiz-modal-btn btn btn-primary text-white py-2 px-6 rounded-full">إغلاق</button>
                        </div>
                    `;
                    modalContent.innerHTML = analysis;
                    modalContent.querySelector('.close-quiz-modal-btn').addEventListener('click', hideQuizModal);
                });
            }
        }

        // --- JOURNAL MODULE ---
        function initJournal() {
            const form = document.getElementById('journal-form');
            if(!form) return;

            document.getElementById('entry-date').valueAsDate = new Date();

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser) {
                    showNotification("يجب تسجيل الدخول لحفظ الإدخالات.", "error");
                    return;
                }
                const entry = {
                    date: document.getElementById('entry-date').value,
                    mood: document.getElementById('mood-rating').value,
                    energy: document.getElementById('energy-rating').value,
                    sleep: document.getElementById('sleep-quality').value,
                    symptoms: document.getElementById('symptoms-today').value,
                    createdAt: new Date()
                };

                try {
                    const journalCollection = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'journalEntries');
                    await addDoc(journalCollection, entry);
                    showNotification("تم حفظ الإدخال بنجاح!", "success");
                    form.reset();
                    document.getElementById('entry-date').valueAsDate = new Date();
                    loadJournalEntries(); 
                } catch (error) {
                    console.error("Error saving journal entry: ", error);
                    showNotification("حدث خطأ أثناء حفظ الإدخال.", "error");
                }
            });
        }
        
        function toggleJournalView(isLoggedIn) {
            document.getElementById('journal-content-container').classList.toggle('hidden', !isLoggedIn);
            document.getElementById('journal-login-prompt').classList.toggle('hidden', isLoggedIn);
        }

        async function loadJournalEntries() {
            if (!currentUser) return;
            const entriesContainer = document.getElementById('journal-entries-container');
            entriesContainer.innerHTML = '<p>جاري تحميل السجلات...</p>';

            const journalCollection = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'journalEntries');
            const q = query(journalCollection, limit(30));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                entriesContainer.innerHTML = '<p>لا توجد إدخالات بعد. ابدأ بتسجيل يومك!</p>';
                if(journalChart) journalChart.destroy();
                return;
            }
            
            const entries = [];
            querySnapshot.forEach(doc => {
                entries.push(doc.data());
            });
            
            entries.sort((a, b) => new Date(b.date) - new Date(a.date));

            let entriesHTML = '';
            entries.forEach(data => {
                entriesHTML += `
                    <div class="bg-white p-4 rounded-lg shadow-sm journal-entry">
                        <p class="font-bold text-lg">${data.date}</p>
                        <p class="text-sm"><strong>المزاج:</strong> ${data.mood}/10 | <strong>الطاقة:</strong> ${data.energy}/10 | <strong>النوم:</strong> ${data.sleep || 'N/A'} س</p>
                        ${data.symptoms ? `<p class="text-sm text-gray-600 mt-1"><strong>الأعراض:</strong> ${data.symptoms}</p>` : ''}
                    </div>`;
            });
            entriesContainer.innerHTML = entriesHTML;
            
            renderJournalChart(entries.reverse());
        }

        async function renderJournalChart(entries) {
            await ensureChart();
            const ctx = document.getElementById('journal-chart').getContext('2d');
            if (journalChart) {
                journalChart.destroy();
            }
            journalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: entries.map(e => e.date),
                    datasets: [
                        {
                            label: 'مستوى المزاج',
                            data: entries.map(e => e.mood),
                            borderColor: cssVar('--primary-color') || '#1F6FEB',
                            backgroundColor: hexToRgba(cssVar('--primary-color') || '#1F6FEB', 0.2),
                            tension: 0.1
                        },
                        {
                            label: 'مستوى الطاقة',
                            data: entries.map(e => e.energy),
                            borderColor: cssVar('--accent-color') || '#2DD4BF',
                            backgroundColor: hexToRgba(cssVar('--accent-color') || '#2DD4BF', 0.2),
                            tension: 0.1
                        }
                    ]
                },
                options: {
                                responsive: true,
                                 plugins: { legend: { position: 'top' } },
                    scales: { y: { beginAtZero: true, max: 10 } }
                }
            });
        }
    </script>

<script>
 document.addEventListener('DOMContentLoaded', () => {
   const newProduct = {
     id: 'uxira',
     name: "UXIRA – مزيل عرق طبيعي",
     shortDesc: "تركيبة طبيعية من الزيوت وهيدروجين بيروكسيد لتنقية المسام ومنع الروائح بفعالية ونعومة.",
     price: "2900 ريال يمني",
     imageUrl: "assets/images/UXIRA%20%20DEODERANT%20.png",
     whatsappLink: "https://wa.me/967771447111?text=مرحبًا،%20أرغب%20بطلب%20مزيل%20العرق%20UXIRA",
     detailsButtonText: "وصف المنتج",
     fullDesc: `
     <h3 class="text-lg font-bold mb-2">💚 UXIRA – مزيل عرق طبيعي آمن وفعّال</h3>
     <p class="mb-2"><strong>تركيبة متكاملة تجمع بين نقاء الزيوت الطبيعية وقوة الهيدروجين بيروكسيد بتركيز مدروس، لتمنحك حماية يومية من العرق والروائح الكريهة، مع عناية فائقة ببشرة الإبط.</strong></p>
     <h4 class="font-bold mb-1">✅ الفوائد الرئيسية:</h4>
     <ul class="list-disc pr-5 text-right mb-2">
       <li><strong>مزيل عرق طبيعي 100%</strong> بدون أي مواد كيميائية قاسية أو ألمنيوم.</li>
       <li><strong>تنقية عميقة للمسام</strong> من البكتيريا والسموم المسببة للرائحة.</li>
       <li><strong>تفتيح آمن للبشرة الداكنة تحت الإبطين</strong> بفضل خصائص الهيدروجين بيروكسيد المقشرة اللطيفة.</li>
       <li><strong>ترطيب وتهدئة فورية</strong> بفضل مزيج الزيوت النباتية المغذية.</li>
       <li><strong>يحارب البكتيريا دون التأثير على التوازن الطبيعي للجلد.</strong></li>
       <li><strong>آمن للاستخدام اليومي حتى على البشرة الحساسة.</strong></li>
     </ul>
     <p class="font-bold mb-1">🌿 مناسب لمن؟</p>
     <ul class="list-disc pr-5 text-right mb-2">
       <li>من يبحث عن بديل طبيعي وصحي لمزيلات العرق التجارية.</li>
       <li>من يعاني من <strong>اسمرار تحت الإبط</strong> أو <strong>تهيج الجلد</strong> بسبب مزيلات العرق الكيميائية.</li>
       <li>من يريد منتجًا فعالًا يدوم طوال اليوم دون انسداد المسام أو تعطيل التعرّق الطبيعي.</li>
     </ul>
     <p class="font-bold mb-1">🧴 طريقة الاستخدام:</p>
     <ol class="list-decimal pr-5 text-right mb-2">
       <li>يُغسل الإبط ويُجفف بلطف تام.</li>
       <li>يُرَش كمية خفيفة من هيدروجين بيروكسيد ويُترك لـ30–60 ثانية حتى يجف جزئيًا.</li>
       <li>يُوضع طبقة رقيقة من كريم UXIRA ويُترك ليجف طبيعيًا.</li>
       <li>يُستخدم صباحًا ويمكن إعادة الاستخدام حسب الحاجة.</li>
     </ol>
     <p class="font-bold mb-1">🔒 آمن ومُجرّب</p>
     <ul class="list-disc pr-5 text-right">
       <li>✔ خالٍ من الألمنيوم</li>
       <li>✔ خالٍ من العطور الصناعية</li>
       <li>✔ خالٍ من البارابين</li>
       <li>✔ مُختبر على البشرة الحساسة</li>
     </ul>
     `
   };

   // خريطة أوصاف المنتجات الكاملة
   const productDescriptions = { 
     uxira: newProduct.fullDesc,
     tibrahOra: `
       <h4 class="font-bold text-lg">🦷 طِبرة للعناية الفموية المتقدمة | نظام علاجي–منعش يومي</h4>
       <p><strong>منتجان تكميليان يعملان بتناغم:</strong> تنقية عميقة… وانتعاش يدوم. لصحة لثتك، ونقاء فمك، وثقتك كل يوم.</p>
       <h4 class="font-bold">① مضمضة طِبرة العلاجية | Ṭibrah Oral Detox Rinse</h4>
       <ul class="list-disc pr-6 space-y-1">
         <li>تنظيف الفم من السموم والفضلات الحمضية</li>
         <li>تقليل التهابات اللثة ونزيفها</li>
         <li>تفكيك البلاك ومنع التصبغات السطحية</li>
         <li>موازنة بيئة الفم بعد مضغ الأعشاب أو تناول القهوة</li>
       </ul>
       <h4 class="font-bold">② بخاخ طِبرة المنعش | Ṭibrah Herbal Oral Mist</h4>
       <ul class="list-disc pr-6 space-y-1">
         <li>ينعش النفس برائحة عشبية نظيفة</li>
         <li>يهدئ اللثة ويرطّب الفم</li>
         <li>يقلل من أثر التصبغات السريعة بعد الأكل</li>
       </ul>
       <h4 class="font-bold">🛡️ لماذا نثق به؟</h4>
       <ul class="list-disc pr-6 space-y-1">
         <li>تركيبة مُعايرة طبيًا، بدون نكهات صناعية</li>
         <li>مناسب للأسنان الحساسة والتهابات اللثة المزمنة</li>
         <li>يُكمّل عاداتك اليومية بدل أن يعيقها</li>
       </ul>
       <p class="font-semibold">🎯 نتائج متوقعة خلال أسبوعين من الاستخدام المنتظم:</p>
       <ul class="list-disc pr-6 space-y-1">
         <li>إزالة فورية لرائحة الفم الكريهة من الجذور، وليس تغطيتها فقط.</li>
         <li>تقليل ملحوظ لنزيف اللثة والتهابها، خاصة عند التفريش أو المضغ.</li>
         <li>إحساس بنظافة فموية ناعمة وطعم قلوي معتدل غير مزعج.</li>
       </ul>
       <p class="font-semibold">✅ نتائج مؤكدة عند الاستمرار المنتظم:</p>
       <ul class="list-disc pr-6 space-y-1">
         <li>تفكيك وإزالة البؤر التسوسية السطحية او العميقة مبكرا قبل ان تتسبب في تدمر السن</li>
         <li>تحفيز فسيولوجي طبيعي لإعادة اللثة المنسحبة إلى موضعها فوق السن — حتى في حالات ارتخاء اللثة بسبب القات أو الالتهابات المتكررة.</li>
         <li>تقوية ألياف اللثة الداعمة وتقليل ارتخاءها، حتى لدى المدخنين ومتعاطي الأعشاب المخرشة.</li>
         <li>تقليل اصفرار الأسنان الناتج عن الترسبات الحمضية والبقع السطحية.</li>
       </ul>
       <p class="italic">🌿 طِبرة — لأن فمك ليس فقط مدخل الطعام… بل بوابة صحتك الداخلية.</p>
     `
   };

   const container = document.getElementById('store-products-grid');
   if (container) {
     const card = document.createElement('div');
     card.className = "border bg-white border-gray-200 rounded-lg overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 fade-in-up hover:-translate-y-2";
     card.innerHTML = `
       <img src="${newProduct.imageUrl}" alt="${newProduct.name}" class="w-full h-56 object-cover">
       <div class="p-6">
         <h3 class="text-xl font-bold mb-2">${newProduct.name}</h3>
         <p class="text-gray-600 mb-4">${newProduct.shortDesc}</p>
         <p class="text-2xl font-bold text-[--primary-color] mb-4">${newProduct.price}</p>
         <a href="${newProduct.whatsappLink}" target="_blank" class="btn btn-secondary w-full block py-2 rounded-full mb-2">اطلب عبر واتساب</a>
         <button class="btn btn-outline w-full details-button" data-prod="${newProduct.id}">${newProduct.detailsButtonText}</button>
       </div>`;
     container.appendChild(card);
   }

   // Create product modal once
   const modal = document.createElement('div');
   modal.id = 'product-modal';
   modal.className = 'fixed inset-0 bg-black/60 flex items-center justify-center z-50 hidden';
   modal.innerHTML = `
     <div class="bg-white p-8 rounded-xl max-w-md w-11/12 text-center relative">
       <button id="close-product-modal" class="absolute top-2 right-4 text-2xl text-gray-500">&times;</button>
       <h3 id="modal-product-title" class="text-2xl font-bold mb-4"></h3>
       <div id="modal-product-description" class="text-gray-700 text-right space-y-2 max-h-[70vh] overflow-y-auto"></div>
     </div>`;
   document.body.appendChild(modal);

   const closeModal = () => modal.classList.add('hidden');
   document.getElementById('close-product-modal').addEventListener('click', closeModal);
   modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

   document.addEventListener('click', (e) => {
     const btn = e.target.closest('.details-button');
     if (!btn) return;
     const card = btn.closest('.border');
     const title = card.querySelector('h3')?.textContent || '';
     const id = btn.dataset.prod || '';
     const desc = productDescriptions[id] || '';
     document.getElementById('modal-product-title').textContent = title;
     document.getElementById('modal-product-description').innerHTML = desc;
     modal.classList.remove('hidden');
   });
 });
</script>
</body>
</html>

                    
